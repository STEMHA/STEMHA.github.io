<!DOCTYPE html>
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
<script type="text/javascript" src="/js/src/click.js"></script>
<script type="text/javascript" src="/live2d-widget/autolload.js"></script>

<!-- 数字雨-->
<canvas id="canvas" width="1440" height="900" ></canvas>
  <script type="text/javascript" src="/js/src/DigitalRain.js"></script> 

<html  lang="zh">
<head>
    <meta charset="utf-8" />

<meta name="generator" content="Hexo 4.2.0" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>Linux-块设备驱动程序 - STEMHA&#39;s Blog</title>


    <meta name="description" content="概述 Linux块设备处理程序的组织是相当复杂的，在此不可能详细介绍内核块设备I&#x2F;O子系统中包含的所有函数我们主要说明下面几个问题：  Linux块设备I&#x2F;O子系统的体系结构是什么？ 块设备I&#x2F;O子系统的主要组件有哪些？有哪些作用？ 打开一个块设备文件时内核执行的步骤有哪些？ 内核如何对块设备和块设备的请求进行管理？-&gt;这部分在内核中称为块I&#x2F;O层">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux-块设备驱动程序">
<meta property="og:url" content="https://stemha.github.io/2020/08/17/Linux-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/index.html">
<meta property="og:site_name" content="STEMHA&#39;s Blog">
<meta property="og:description" content="概述 Linux块设备处理程序的组织是相当复杂的，在此不可能详细介绍内核块设备I&#x2F;O子系统中包含的所有函数我们主要说明下面几个问题：  Linux块设备I&#x2F;O子系统的体系结构是什么？ 块设备I&#x2F;O子系统的主要组件有哪些？有哪些作用？ 打开一个块设备文件时内核执行的步骤有哪些？ 内核如何对块设备和块设备的请求进行管理？-&gt;这部分在内核中称为块I&#x2F;O层">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://stemha.github.io/images/og_image.png">
<meta property="article:published_time" content="2020-08-17T13:09:35.000Z">
<meta property="article:modified_time" content="2020-09-01T14:20:01.494Z">
<meta property="article:author" content="STEMHA">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="驱动程序">
<meta property="article:tag" content="块设备">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://stemha.github.io/images/og_image.png">







<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/pojoaque.css">


    
    
<style>body>.footer,body>.navbar,body>.section{opacity:0}</style>

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">

    
    
    
    
<link rel="stylesheet" href="/css/back-to-top.css">

    
    
    
    
    
    
    
    <link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
    
    
    


<link rel="stylesheet" href="/css/style.css">

<link rel="alternate" href="/rss.xml" title="STEMHA's Blog" type="application/atom+xml">
</head>
<body class="is-2-column">
<!-- <body class="is-3-column"> -->
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/og_image.png" alt="Linux-块设备驱动程序" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">首页</a>
                
                <a class="navbar-item"
                href="/archives">归档</a>
                
                <a class="navbar-item"
                href="/categories">分类</a>
                
                <a class="navbar-item"
                href="/tags">标签</a>
                
                <a class="navbar-item"
                href="/about">关于</a>
                
                <a class="navbar-item"
                href="/cs-quotes">CS语录</a>
                
                <a class="navbar-item"
                href="/rss.xml">RSS</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    <a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
               <!--<div class="column is-8-tablet is-8-desktop is-9-widescreen has-order-2 column-main">
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2020-08-17T13:09:35.000Z">2020-08-17</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    2 小时 读完 (大约 15981 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                Linux-块设备驱动程序
            
        </h1>
        <div class="content">
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a><strong>概述</strong></h2><blockquote>
<p>Linux块设备处理程序的组织是相当复杂的，在此不可能详细介绍内核块设备I/O子系统中包含的所有函数<br>我们主要说明下面几个问题：</p>
<ul>
<li>Linux块设备I/O子系统的体系结构是什么？</li>
<li>块设备I/O子系统的主要组件有哪些？有哪些作用？</li>
<li>打开一个块设备文件时内核执行的步骤有哪些？</li>
<li>内核如何对块设备和块设备的请求进行管理？-&gt;这部分在内核中称为块I/O层</li>
</ul>
</blockquote>
<a id="more"></a>
<h2 id="块设备与字符设备"><a href="#块设备与字符设备" class="headerlink" title="块设备与字符设备"></a><strong>块设备与字符设备</strong></h2><p><code>块设备</code>:系统中能够随机（不需要按顺序）访问固定大小数据片（chunks）的设备被称作<code>块设备</code>，这些数据片就称作<code>块</code>。</p>
<ul>
<li>最常见的块设备是硬盘，除此以外，还有软盘驱动器、CD-ROM驱动器和闪存等等许多其他块设备。</li>
<li>注意，它们都是以安装文件系统的方式使用的——这也是块设备的一般访问方式。</li>
</ul>
<p><code>字符设备</code>:另一种基本的设备类型是<code>字符设备</code>。</p>
<ul>
<li>字符设备按照字符流的方式被有序访问，像串口和键盘就都属于字符设备。</li>
<li>如果一个硬件设备是以字符流的方式被访问的话，那就应该将它归于字符设备；反过来，如果一个设备是随机（无序的）访问的，那么它就属于块设备。</li>
</ul>
<p>两种类型的设备的根本区别在于它们是否可以被随机访问——也就是能否在访问设备时随意地从一个位置跳转到另一个位置。</p>
<article class="message is-info"><div class="message-header">
<p>为什么要使用专门的内核子系统来进行块设备的管理？对块设备的优化带来什么好处？</p>
</div><div class="message-body">
<p>内核管理块设备要比管理字符设备细致得多，需要考虑的问题和完成的工作相比字符设备来说要复杂许多。这是因为字符设备仅仅需要控制一个位置—当前位置—而块设备访问的位置必须能够在介质的不同区间前后移动。所以事实上内核不必提供一个专门的子系统来管理字符设备，但是对块设备的管理却必须要有一个专门的提供服务的子系统。不仅仅是因为块设备的复杂性远远高于字符设备，<span class="icon has-text-info">  <i class="fas fa-info-circle"></i></span><strong>更重要的原因是块设备对执行性能的要求很高；对硬盘每多一分利用都会对整个系统的性能带来提升，其效果要远远比键盘吞吐速度成倍的提高大得多</strong>。另外，我们将会看到，块设备的复杂性会为这种优化留下很大的施展空间。</p>
</div></article>

<h2 id="块设备的扇区-内核的块"><a href="#块设备的扇区-内核的块" class="headerlink" title="块设备的扇区/内核的块"></a><strong>块设备的扇区/内核的块</strong></h2><h3 id="扇区"><a href="#扇区" class="headerlink" title="扇区"></a><strong>扇区</strong></h3><p><strong>扇区是什么？</strong></p>
<ul>
<li>块设备中最小的可寻址单元是扇区。扇区大小一般是2的整数倍，而最常见的是512字节。</li>
<li>扇区的大小是设备的物理属性<ul>
<li>扇区是所有块设备的基本单元，块设备无法对比它还小的单元进行寻址和操作，不过许多块设备能够一次就传输多个扇区。</li>
<li>虽然大多数块设备的扇区大小都是512字节，不过其它大小的扇区也很常见， 比如，很多CD-ROM盘的扇区都是2K大小。</li>
<li>在Linux中，扇区大小按惯例都设为512字节；如果一个块设备使用更大的扇区，那么相应的底层设备驱动程序将做些必要的变换。</li>
</ul>
</li>
</ul>
<p><strong>为什么提出扇区？扇区的作用是什么？</strong></p>
<ul>
<li>为了达到可接受的性能，硬盘和类似的设备快速传送几个相邻字节的数据（也就是传递多个字节的数据会提高性能）。块设备的每次数据传送操作都作用于一组称为<code>扇区</code>的相邻字节。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </li>
<li>尽管磁盘的物理构造很复杂，但是硬盘控制器接收到的命令将磁盘看成一大组扇区。应该把扇区作为数据传送的基本单元，不允许传送少于一个扇区的数据，大部分磁盘设备都可以同时传送几个相邻的扇区。</li>
<li>对存放在块设备中的一组数据是通过他们在磁盘上的位置来标识，即其首个512字节扇区的下标以及扇区的数目。扇区的下标存放在类型为sector_t的32位或64位的变量中。</li>
</ul>
<h3 id="块"><a href="#块" class="headerlink" title="块"></a><strong>块</strong></h3><p><strong>块：</strong></p>
<ul>
<li>虽然各种软件的用途不同，但是它们都会用到自己的最小逻辑可寻址单元—块。</li>
<li>块是文件系统的一种抽象，只能基于块来访问文件系统。虽然物理磁盘寻址是按照扇区来级进行的，但是内核执行的所有磁盘操作都是按照块进行的。</li>
<li>由于扇区是设备的最小可寻址单元，所以块不能比扇区还小，只能数倍于扇区大小。对有扇区的硬件设备，内核还要求块大小是2的整数倍，且不能超过一个页的长度。</li>
<li>对块大小的要求最终如下：<ul>
<li>必须是扇区大小的2的整数倍，并且要小于页面大小（页框大小），所以通常块大小是512字节，1KB或者4KB</li>
<li>在80X86体系结构中，允许块的大小为512，1024，2048，4096字节。</li>
<li>块设备的块大小不是唯一的，创建一个磁盘文件系统时，管理员可以选择合适的块大小。因此，同一个磁盘上的几个分区可能使用不同的块大小。</li>
<li>此外，对块设备文件的每次读或写操作是一种“原始”访问，因为他绕过了磁盘文件系统；内核通过使用<code>最大的块（4096字节）</code>执行该操作。</li>
</ul>
</li>
</ul>
<p><code>块缓冲区</code>：每个块都需要自己的块缓冲区，它是内核用来存放块内容的RAM空间。</p>
<ul>
<li>当内核从磁盘读出一个块时，就用从硬件设备中所获得的数据来填充相应的缓冲区；同样，当内核向磁盘中写入一个块时，就用相关块缓冲区的数据来更新硬件设备上相应的一组相邻字节。</li>
<li>块缓冲区的大小通常要与相应块的大小相匹配。</li>
<li><code>缓冲区首部</code>是一个与每个缓冲区相关的<code>buffer_head</code>类型的描述符。它包含内核处理缓冲区需要了解的所有信息；因此，在对每个缓冲区进行操作之前，内核都要首先检查其缓冲区首部；因此，在对每个缓冲区进行操作之前，内核都要首先检查其缓冲区首部。</li>
</ul>
<h3 id="扇区与块的关系"><a href="#扇区与块的关系" class="headerlink" title="扇区与块的关系"></a><strong>扇区与块的关系</strong></h3><p>图1是扇区与块之间的关系图：</p>
<center><img src="/2020/08/17/Linux-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/扇区与块之间的关系.gif">  </center>
<center>图1. 扇区与块之间的关系</center>


<p>扇区和块的别称：</p>
<ul>
<li><code>扇区</code>：设备的最小寻址单元，或称为“<code>硬扇区</code>”“<code>设备块</code>”。</li>
<li><code>块</code>：文件系统的最小寻址单元，或称为“<code>文件块</code>”“<code>I/O块</code>”。</li>
</ul>
<p>扇区和块的区别：</p>
<ul>
<li>扇区是硬件设备传送数据的基本单位，而块是VFS和文件系统传送数据的基本单位。</li>
<li>例如：内核访问一个文件的内容时，它必须首先从磁盘上读文件的磁盘索引节点所在的块。该块对应磁盘上一个或多个相邻的扇区，而VFS将其看成是一个单一的数据单元。</li>
</ul>
<blockquote>
<p>扇区这一个概念之所以对内核重要，是因为所有设备的I/O必须以扇区为单位进行操作，内核所使用的“块”这一个高级概念就是建立在扇区之上的。</p>
</blockquote>
<p>深入理解linux</p>
<h2 id="块设备的处理"><a href="#块设备的处理" class="headerlink" title="块设备的处理"></a><strong>块设备的处理</strong></h2><p>在本节我们来说明一下Linux块设备I/O子系统的体系结构。块设备驱动程序上的每个操作都涉及很多内核组件，其中最重要的一些如图2所示：</p>
<center><img src="/2020/08/17/Linux-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/块设备操作涉及的内核组件.gif">  </center>
<center>图2. 块设备操作涉及的内核组件</center>

<p>例如，我们假设一个进程在某个磁盘文件上发出一个read()系统调用（write()系统调用本质上采用同样的方式）。下面是内核对进程请求给予回应的一般步骤：</p>
<ol>
<li>read()系统调用的服务例程调用一个适当的函数，将<code>文件描述符</code>和<code>文件内的偏移量</code>传递给它。虚拟文件系统位于块设备处理体系结构的上层，他提供一个通用的文件模型，Linux支持的所有文件系统均采用该模型。</li>
<li>VFS函数<strong>确定所请求的数据是否存在</strong>，比如文件指针的位置的合法性等，如果有必要的话，它决定如何执行read操作（但均通过具体的文件系统提供的文件操作来执行）。有时候没有必要访问磁盘上的数据，因为内核将大多数最近从块设备读出或写入其中的数据保存在RAM中，及通过<code>磁盘高速缓存</code>来获得数据。</li>
<li>我们假设内核从块设备读数据，那么它就必须<strong>确定数据的物理位置</strong>。为了做到这点，内核依赖<code>映射层（mapping layer）</code>，主要执行下面两步：<br> 3.1. 内核确定该文件所在文件系统的块大小，并根据文件块的大小计算所请求数据的长度。<u>本质上，文件被看作许多数据块的集合</u>，因此内核确定请求数据所在的块号（文件开始位置的块索引）。<br> 3.2. 接下来，映射层调用一个具体文件系统的函数，它访问文件的磁盘索引节点，然后根据逻辑块号确定所请求数据在磁盘上的位置。事实上，磁盘也被看作数据块的数组，因此内核必须确定存放所请求数据的块对应的号（磁盘或分区开始位置的相对索引）。由于一个文件可能存储在磁盘上的不连续块中，因此存放在磁盘索引节点中的数据结构将每个文件块号映射为一个逻辑块号。<br> 3.3. <span class="icon has-text-info">  <i class="fas fa-info-circle"></i></span><strong>如果是从原始设备文件进行读访问，映射层就不调用具体文件系统的方法，而是把块设备文件中的偏移量转换成在磁盘或者在对应该设备文件的磁盘分区中的位置。</strong></li>
<li>现在内核可以<strong>对块设备发出读请求</strong>。内核利用<code>通用块层（generic block layer）</code>启动I/O操作来传送所请求的数据。一般而言，每个I/O操作只针对磁盘上一组连续的块。由于请求的数据不必位于相邻的块中，所以通用块层可能启动几次I/O操作。每次I/O操作是由一个“块I/O”（简称“bio”）结构描述，它收集底层组件需要的所有信息以满足所发出的请求。通用块层为所有的块设备提供了一个抽象视图，因而隐藏了硬件块设备间的差异性。几乎所有的块设备都是磁盘。</li>
<li>通用块层下面的“<code>I/O调度程序</code>”根据预先定义的内核策略将待处理的I/O数据传送请求归类。<strong><code>调度程序的作用</code>是把物理介质上相邻的数据请求聚集在一起。</strong></li>
<li>最后块设备驱动程序向磁盘控制器的硬件接口发送适当的命令，从而进行实际的数据传送。</li>
</ol>
<h3 id="块设备内核组件管理数据的方式"><a href="#块设备内核组件管理数据的方式" class="headerlink" title="块设备内核组件管理数据的方式"></a><strong>块设备内核组件管理数据的方式</strong></h3><p>块设备中的数据存储涉及到了许多内核组件，每个组件采用不同长度的块来管理磁盘数据：</p>
<ul>
<li>硬件块设备控制器采用称为“<code>扇区</code>”的固定长度的块来传送数据。因此，I/O调度程序和块设备驱动程序必须管理数据扇区。</li>
<li>虚拟文件系统、映射层和具体文件系统将磁盘数据存放在成为<code>“块”</code>的逻辑单元中。一个块对应文件系统中一个最小的磁盘存储单元。</li>
<li><code>“段”</code>: 块设备驱动程序应该能够处理数据的<code>“段”</code>。一个段就是一个内存页或内存页的一部分，它们包含磁盘上物理相邻的数据块。</li>
<li><code>磁盘高速缓存</code>作用于磁盘数据的<code>“页”</code>上，每页正好装在一个<code>页框</code>中。</li>
<li><code>通用块层</code>将所有的上层和下层的组件组合在一起，因此它了解数据的<code>扇区、块、段以及页</code>。即使有许多不同的数据块，它们通常也是共享相同的物理RAM单元。</li>
</ul>
<h3 id="管理数据方式示例"><a href="#管理数据方式示例" class="headerlink" title="管理数据方式示例"></a><strong>管理数据方式示例</strong></h3><p>例如，图3显示了一个具有4KB字节的<code>页</code>的构造。上层内核组件将页看成是4个1024字节组成的<code>块缓冲区</code>。块设备驱动程序正在传送页中的后三个<code>块</code>，因此这3块被插入到涵盖了后3072字节的<code>段</code>中。硬盘控制器将该段看成是由6个512字节的<code>扇区</code>组成。</p>
<center><img src="/2020/08/17/Linux-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/包含磁盘数据的页的典型构造.gif">  </center>
<center>图3. 包含磁盘数据的页的典型构造</center>

<h2 id="段"><a href="#段" class="headerlink" title="段"></a><strong>段</strong></h2><blockquote>
<p>磁盘的每个I/O操作的实质是在磁盘与一些RAM单元之间相互传送一些相邻扇区的内容。</p>
</blockquote>
<p>大多数情况下，磁盘控制器直接采用DMA方式进行数据传送。</p>
<ul>
<li>DMA方式的特点是，磁盘控制器就像一个外置CPU一样，块设备驱动程序只要向磁盘控制器发送一些适当的命令就可以触发一次数据传送；一旦完成数据的传送，控制器就会发出一个中断通知块设备驱动程序。</li>
<li>DMA方式传送的是磁盘上相邻扇区的数据。这是一个物理约束：磁盘控制器允许DMA传送不相邻的扇区数据，但是这种方式的传送速率很低，因为在磁盘表面上移动读/写磁头是相当慢的。</li>
</ul>
<p>老式的磁盘控制器仅仅支持“简单的”DMA传送方式：在这种传送方式中，磁盘必须与RAM中的连续内存单元相互传送数据。但是，新的磁盘控制器，也就是我们即将讲到的SCSI磁盘控制器，支持所谓的<code>分散-聚集（scatter-gather）DMA</code>传送方式。此种方式中，磁盘可以与一些非连续的内存区相互传送数据。启动一次分散-聚集DMA传送，块设备驱动程序需要向磁盘控制器发送：</p>
<ol>
<li>要传送的起始磁盘扇区号和总的扇区数（要传的数据位置）</li>
<li>内存区的描述符链表，其中链表的每项包含一个地址和一个长度（需要传送到的位置）</li>
</ol>
<p>磁盘控制器则负责整个数据传送，例如：</p>
<ul>
<li>在读操作中控制器从相邻磁盘扇区中获得数据，然后将它们存放到不同的内存区中。</li>
<li>为了使用分散-聚集DMA传送方式，块设备驱动程序必须能够处理称为<code>段</code>的数据存储元。</li>
<li>一个<code>段</code>就是一个内存页或内存页中的一部分，它们包含一些相邻磁盘扇区中的数据。</li>
<li>因此，一次分散-聚集DMA操作可能同时传送几个段。</li>
</ul>
<p>注意，块设备驱动程序不需要知道块、块大小以及块缓冲区。因此，即使高层将段看成是由几个块缓冲区组成的页，块设备驱动程序也不用对此给予关注。</p>
<p>如果，不同的段在RAM中相应的页框正好是连续的并且在磁盘上相应的数据块也是相邻的，那么通用块层可以合并它们。通过这种合并方式产生的更大的内存区就称为<code>物理段</code>。然而，在多种体系结构上还允许使用另一个合并方式：通过使用一个专门的总线电路来处理总线地址与物理地址间的映射。通过这种合并方式产生的内存区称为<code>硬件段</code>。由于我们将注意力集中在80 x 86体系结构上，它在总线地址和物理地址之间不存在动态的映射，因此在本章剩余部分我们假定硬件段总是对应物理段。</p>
<h2 id="缓冲区与缓冲区头"><a href="#缓冲区与缓冲区头" class="headerlink" title="缓冲区与缓冲区头"></a><strong>缓冲区与缓冲区头</strong></h2><p>当一个块被调入内存时（也就是，在读入后或者等待写出的时候），它要存储在一个缓冲区中。每个缓冲区和一个块对应，它相当于磁盘块在内存中的表示。一个块小于一个页，所以一页可以容纳一个或多个内存中的块。</p>
<p>由于内核在处理数据时需要一些相关的控制信息，每个缓冲区都有一个对应的描述符。该描述符<code>buffer_head结构体</code>表示，被称作<code>缓冲区头</code>，它包含了内核操作缓冲区所需的全部信息：</p>
<h3 id="buffer-head结构体"><a href="#buffer-head结构体" class="headerlink" title="buffer_head结构体"></a><strong>buffer_head结构体</strong></h3><p>buffer_head结构体在<a href="https://github.com/torvalds/linux/blob/v3.10/include/linux/buffer_head.h#L61">include/linux/buffer_head.h</a>中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Historically, a buffer_head was used to map a single block</span></span><br><span class="line"><span class="comment"> * within a page, and of course as the unit of I/O through the</span></span><br><span class="line"><span class="comment"> * filesystem and block layers.  Nowadays the basic I/O unit</span></span><br><span class="line"><span class="comment"> * is the bio, and buffer_heads are used for extracting block</span></span><br><span class="line"><span class="comment"> * mappings (via a get_block_t call), for tracking state within</span></span><br><span class="line"><span class="comment"> * a page (via a page_mapping) and for wrapping bio submission</span></span><br><span class="line"><span class="comment"> * for backward compatibility reasons (e.g. submit_bh).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> b_state;	           <span class="comment">//缓冲区状态标志	/* buffer state bitmap (see above) */ </span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> *<span class="title">b_this_page</span>;</span>   <span class="comment">//页面中的缓冲区   /* circular list of page's buffers */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">b_page</span>;</span>	           <span class="comment">//存储缓冲区的页面	/* the page this bh is mapped to */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">sector_t</span> b_blocknr;		<span class="comment">//起始块号 /* start block number */</span></span><br><span class="line">	<span class="keyword">size_t</span> b_size;			<span class="comment">//映像的大小 /* size of mapping */</span></span><br><span class="line">	<span class="keyword">char</span> *b_data;			<span class="comment">//页面内的数据指针 /* pointer to data within the page */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">block_device</span> *<span class="title">b_bdev</span>;</span>      <span class="comment">//相关联的块设备</span></span><br><span class="line">	<span class="keyword">bh_end_io_t</span> *b_end_io;<span class="comment">//I/O完成方法 /* I/O completion */</span></span><br><span class="line"> 	<span class="keyword">void</span> *b_private;		<span class="comment">/* reserved for b_end_io */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">b_assoc_buffers</span>;</span>   <span class="comment">/*相关的映射链表 associated with another mapping */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">b_assoc_map</span>;</span>	<span class="comment">/*相关的地址空间 mapping this buffer is associated with */</span></span><br><span class="line">	<span class="keyword">atomic_t</span> b_count;		            <span class="comment">/*缓冲区使用计数 users using this buffer_head */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li><p><code>b_count域</code>表示缓冲区的使用记数，可通过两个定义在文件<a href="https://github.com/torvalds/linux/blob/v3.10/include/linux/buffer_head.h#L268">include/linux/buffer_head.h</a>中的内联函数对此域进行增减。</p>
<ul>
<li><figure class="highlight c"><figcaption><span>点击展开对b_count域进行增减的内联函数 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">get_bh</span><span class="params">(struct buffer_head *bh)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        atomic_inc(&amp;bh-&gt;b_count);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">put_bh</span><span class="params">(struct buffer_head *bh)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        smp_mb__before_atomic_dec();</span><br><span class="line">        atomic_dec(&amp;bh-&gt;b_count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>在操作缓冲区头之前，应该先使用get_bh()函数增加缓冲区头的引用计数，确保该缓冲区头不会再被分配出去；当完成对缓冲区头的操作之后，还必须使用put_bh()函数减少引用计数。</li>
</ul>
</li>
<li><p><code>b_blocknr域</code>：与缓冲区对应的磁盘物理块由b_blocknr域索引，该值是b_bdev域指明的块设备中的逻辑块号。</p>
</li>
<li><p>与缓冲区对应的内存物理页由<code>b_page域</code>表示，另外，<code>b_data域</code>直接指向相应的块（它位于b_page域所指明的页面中的某个位置上），块的大小由<code>b_size域</code>表示，所以块在内存中的起始位置在b_data处，结束位置在(b_data + b_size)处。</p>
</li>
<li><p><code>b_state域</code>表示缓冲区状态标志，可以是下表中一种或者多种标志的组合。合法的标志存放在bh_state_bits枚举中，在<a href="https://github.com/torvalds/linux/blob/v3.10/include/linux/buffer_head.h#L19">include/linux/buffer_head.h</a>中定义    </p>
</li>
</ul>
<figure class="highlight c"><figcaption><span>点击展开bh_state_bits枚举列表 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> bh_state_bits &#123;</span><br><span class="line">	BH_Uptodate,	<span class="comment">/* 该缓冲区包含可用数据Contains valid data */</span></span><br><span class="line">	BH_Dirty,	<span class="comment">/* 该缓冲区是脏的，缓冲区的内容比磁盘中的块内容要新，所以缓冲区的内容必须被写回磁盘Is dirty */</span></span><br><span class="line">	BH_Lock,	<span class="comment">/* 该缓冲区正在被I/O操作访问，被锁定以防止并发访问Is locked */</span></span><br><span class="line">	BH_Req,		<span class="comment">/* 该缓冲区有I/O请求操作Has been submitted for I/O */</span></span><br><span class="line">	BH_Uptodate_Lock,<span class="comment">/* Used by the first bh in a page, to serialise</span></span><br><span class="line"><span class="comment">			  * IO completion of other buffers in the page</span></span><br><span class="line"><span class="comment">			  */</span></span><br><span class="line"></span><br><span class="line">	BH_Mapped,	<span class="comment">/* 该缓冲区是映射磁盘块的可用缓冲区Has a disk mapping */</span></span><br><span class="line">	BH_New,		<span class="comment">/* 缓冲区是通过get_block()刚刚映射的，尚且不能访问Disk mapping was newly created by get_block */</span></span><br><span class="line">	BH_Async_Read,	<span class="comment">/*该缓冲区正通过end_buffer_async_read()被异步I/O读操作使用 Is under end_buffer_async_read I/O */</span></span><br><span class="line">	BH_Async_Write,	<span class="comment">/*该缓冲区正通过end_buffer_async_write()被异步写操作使用 Is under end_buffer_async_write I/O */</span></span><br><span class="line">	BH_Delay,	<span class="comment">/* 该缓冲区尚未与磁盘块关联Buffer is not yet allocated on disk */</span></span><br><span class="line">	BH_Boundary,	<span class="comment">/* 该缓冲区片于连续块区的边界，下一个块不再连续 Block is followed by a discontiguity */</span></span><br><span class="line">	BH_Write_EIO,	<span class="comment">/* 该缓冲区在写的时候遇到I/O错误 I/O error on write */</span></span><br><span class="line">	BH_Unwritten,	<span class="comment">/* 该缓冲区在硬盘上的空间已经被申请但是没有实际数据写出Buffer is allocated on disk but not written */</span></span><br><span class="line">	BH_Quiet,	<span class="comment">/* 该缓冲区禁止错误Buffer Error Prinks to be quiet */</span></span><br><span class="line">	BH_Meta,	<span class="comment">/* Buffer contains metadata */</span></span><br><span class="line">	BH_Prio,	<span class="comment">/* Buffer should be submitted with REQ_PRIO */</span></span><br><span class="line"></span><br><span class="line">	BH_PrivateStart,<span class="comment">/* not a state bit, but the first bit available</span></span><br><span class="line"><span class="comment">			 * for private allocation by other entities</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li>BH_PrivateStart：bh_state_bits列表还包含了一个特殊标志——BH_PrivateStart，该标志不是可用状态标志，使用它是为了指明可被其他代码使用的起始位。块I/O层不会使用BH_PrivateStart或更高的位。那么某个驱动程序希望通过b_state域存储信息时就可以安全地使用这些位。驱动程序可以在这些位中定义自己的状态标志，只要保证自定义的状态标志不与块I/O层的专用位发生冲突就可以了。</li>
</ul>
<h3 id="块缓冲区头、块缓冲区以及页框的关系"><a href="#块缓冲区头、块缓冲区以及页框的关系" class="headerlink" title="块缓冲区头、块缓冲区以及页框的关系"></a><strong>块缓冲区头、块缓冲区以及页框的关系</strong></h3><p>每个块缓冲区都对应一个块缓冲区头buffer_head，二者的关系类似于物理页框和物理页框描述符，前者用来存储数据，后者是对前者的属性以及控制信息的描述。<br>块缓冲区头、块缓冲区以及页框的关系如下：</p>
<center><img src="/2020/08/17/Linux-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/块缓冲区头、块缓冲区以及页框的关系.gif">  </center>
<center>图4. 块缓冲区头、块缓冲区以及页框的关系</center>

<p>总结一下:</p>
<ul>
<li>缓冲区:磁盘块在物理内存中的表示形式</li>
<li>缓冲区描述符:对缓冲区的相关信息的描述，描述了缓冲区与磁盘块的映射关系</li>
<li>缓冲区头的目的在于描述磁盘块和物理内存缓冲区（在特定页面上的字节序列）之间的映射关系。这个结构体在内核中只扮演一个描述符的角色，说明从缓冲区到块的映射关系。</li>
</ul>
<h2 id="通用块层"><a href="#通用块层" class="headerlink" title="通用块层"></a><strong>通用块层</strong></h2><p>通用块层是一个内核组件，它处理来自系统中的所有对块设备发出的请求。由于该层所提供的函数，内核可以容易的做到：</p>
<ul>
<li>将数据缓冲区放在高端内存——仅当CPU访问其数据时，才将页框映射为内核中的线性地址空间，并在数据访问完后取消映射。</li>
<li>通过一些附加额手段，实现一个所谓的<code>“零-复制”模式</code>，将磁盘数据直接存放在用户态地址空间而不是首先复制到内核内存区；<ul>
<li>事实上，内核为I/O数据传送使用的缓冲区所在的页框就映射在进程的用户态线性地址空间中。</li>
</ul>
</li>
<li>管理逻辑卷，例如有LVM(逻辑卷管理)和RAID（磁盘冗余阵列）使用的逻辑卷：几个磁盘分区，即使位于不同的磁盘中，也可以被看做是一个单一的分区。</li>
<li>发挥大部分新磁盘控制器的高级特性，例如大主板磁盘高速缓存，增强的DMA性能，I/O传送请求的相关调度等。</li>
</ul>
<p>深入理解linux</p>
<h2 id="bio结构体"><a href="#bio结构体" class="headerlink" title="bio结构体"></a><strong>bio结构体</strong></h2><p>通用块层的核心数据结构是一个称为bio的描述符，它描述了块设备的I/O操作。目前内核中块I/O操作的基本容器由bio结构体表示。在更上层的具体的文件系统的读写操作方法中，构造bio结构，并通过通用块层来提交各块设备驱动程序来进行实际的数据传输。</p>
<p>它定义在文件<a href="https://github.com/torvalds/linux/blob/v3.10/include/linux/blk_types.h#L35">include/linux/blk_types.h</a>中:</p>
<ul>
<li>该结构体代表了正在活动的以<code>段(segment)链表</code>形式组织的块I/O操作。一个段是一小块连续的内存缓冲区。这样,单个缓冲区就不一定要连续。所以<u>使用段来描述缓冲区,即使一个缓冲区分散在内存的多个位置上,bio结构体也能对内核保证I/O操作的执行</u>。这样的向量I/O称为<code>分散-聚合I/O</code>。</li>
<li>每个bio结构都包含一个<code>磁盘存储区表示符</code>（存储区中的起始扇区号和扇区数目）和一个或多个描述与I/O操作相关的内存区的段。</li>
</ul>
<p>bio结构定义如下：</p>
<figure class="highlight c"><figcaption><span>点击展开bio结构体 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* struct bio, bio_vec and BIO_* flags are defined in blk_types.h */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * main unit of I/O for the block layer and lower layers (ie drivers and</span></span><br><span class="line"><span class="comment"> * stacking drivers)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bio</span> &#123;</span></span><br><span class="line">	<span class="keyword">sector_t</span>		bi_sector;	<span class="comment">/* 磁盘上相关的扇区,块I/O操作的第一个扇区 device address in 512 byte sectors */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bio</span>		*<span class="title">bi_next</span>;</span>	<span class="comment">/* 请求链表，链接到请求队列中的下一个bio request queue link */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">block_device</span>	*<span class="title">bi_bdev</span>;</span>	<span class="comment">//指向块设备描述符的指针</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		bi_flags;	<span class="comment">/* 状态和命令标志status, command, etc */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		bi_rw;		<span class="comment">/* 读还是写,I/O操作标志 bottom bits READ/WRITE,</span></span><br><span class="line"><span class="comment">						 * top bits priority</span></span><br><span class="line"><span class="comment">						 */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> short		bi_vcnt;	<span class="comment">/* bio的biovec数组中段的数目，bio_vec的偏移个数 how many bio_vec's */</span></span><br><span class="line">	<span class="keyword">unsigned</span> short		bi_idx;		<span class="comment">/* bio的biovec数组中段的当前索引值 current index into bvl_vec */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Number of segments in this BIO after</span></span><br><span class="line"><span class="comment">	 * physical address coalescing is performed.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		bi_phys_segments; <span class="comment">//合并之后的硬件段数目</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		bi_size;	<span class="comment">/* I/O计数 residual I/O count */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * To keep track of the max segment size, we account for the</span></span><br><span class="line"><span class="comment">	 * sizes of the first and last mergeable segments in this bio.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		bi_seg_front_size; <span class="comment">//第一个可合并段的大小，硬件段合并算法使用</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		bi_seg_back_size;  <span class="comment">//最后一个可合并段的大小，硬件段合并算法使用</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">bio_end_io_t</span>		*bi_end_io;        <span class="comment">//bio的I/O操作结束时调用的方法</span></span><br><span class="line">	<span class="keyword">void</span>			*bi_private;         <span class="comment">//拥有者的私有方法。通用块层和块设备驱动程序的I/O完成方法所使用的指针</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BLK_CGROUP</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Optional ioc and css associated with this bio.  Put on bio</span></span><br><span class="line"><span class="comment">	 * release.  Read comment on top of bio_associate_current().</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">io_context</span>	*<span class="title">bi_ioc</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cgroup_subsys_state</span> *<span class="title">bi_css</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_BLK_DEV_INTEGRITY)</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bio_integrity_payload</span> *<span class="title">bi_integrity</span>;</span>  <span class="comment">/* data integrity */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Everything starting with bi_max_vecs will be preserved by bio_reset()</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		bi_max_vecs;	<span class="comment">/* bio中的bio_vec数组中允许的最大段数 max bvl_vecs we can hold */</span></span><br><span class="line">	<span class="keyword">atomic_t</span>		bi_cnt;		<span class="comment">/* bio的引用计数器 pin count */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bio_vec</span>		*<span class="title">bi_io_vec</span>;</span>	<span class="comment">/* 指向bio中的bio_vec数组中段的指针 the actual vec list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bio_set</span>		*<span class="title">bi_pool</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We can inline a number of vecs at the end of the bio, to avoid</span></span><br><span class="line"><span class="comment">	 * double allocations for a small number of bio_vecs. This member</span></span><br><span class="line"><span class="comment">	 * MUST obviously be kept at the very end of the bio.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bio_vec</span>		<span class="title">bi_inline_vecs</span>[0];</span>  <span class="comment">//内嵌bio向量</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li>bio结构体描述的都只是元数据部分，实际数据都包含在紧跟其后的 <code>bio_vec结构体</code> 中。bio中的每一个段是由bio_vec结构体描述的</li>
<li>bio结构体中的bi_io_vec字段指向bio_vec数据结构的第一个元素，bi_vcnt则存放了bio_vec数据结构数组中当前元素的个数。</li>
<li>bi_private域，这是一个属于拥有者（创建者）的私有域，只有创建了bio结构的拥有者可以读写该域。<br>bio结构体中的主要成员变量都是用来管理I/O操作执行的相关信息的,其中最重要的几个成员变量是<code>bi_io_vec</code>、<code>bi_vcnt</code>和<code>bi_idx</code>。下图显示了bio结构体及相关结构体之间的关系：</li>
</ul>
<center><img src="/2020/08/17/Linux-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/bio结构体及相关结构体之间的关系.PNG">  </center>
<center>图5. bio结构体及bio_vec, bi_vcnt和bi_idx之间的关系</center>


<p>说明：</p>
<ul>
<li>在每个给定的块I/O操作中，bi_vcnt域用来描述bi_io_vec所指向的vio_vec数组中的向量数目。当块I/O操作执行完毕后,bi_idx域指向数组的当前索引。</li>
<li>在块I/O操作期间bio描述符的内容一直保持更新。例如，如果块设备驱动程序在一次分散-聚集DMA操作中不能完成全部的数据传送，那么bio中的bi_idx字段会不断更新来指向待传送的第一个段。为了从索引bi_idx指向的当前段开始不断遍历bio中的段，设备驱动程可以执行宏bio_for_each_segment().</li>
</ul>
<p>当通用块层启动一次新的I/O操作时，调用bio_alloc()函数分配一个新的bio结构。内核使用fs_bio_set结构类型来管理bio结构相关内存分配的缓冲区，这个结构由几个用于引用内存池或slab缓冲的指针组成。<br>fs_bio_set中的一个成员bio_pool用于引用分配bio结构的内存池，而在这个缓冲区中分配的内存块的单位并不是sizeof(struct bio)，而是sizeof(struct bio) + BIO_INLINE_VECS* sizeof(struct bio_vec)个字节。在分配了bio结构之后，通常要为bio分配bio_vec结构，当bio_vec结构数小于BIO_INLINE_VECS时则可以通过bio结构的最后一个成员bi_inline_vecs来引用这些bio_vec结构。</p>
<p>内核同时创建了6个slab缓冲区用于分配数量不等的bio_vec结构，当所需的bio_vec结构数大于BIO_INLINE_VECS，则从这些缓冲区中分配内存。</p>
<h3 id="I-O-向量"><a href="#I-O-向量" class="headerlink" title="I/O 向量"></a><strong>I/O 向量</strong></h3><p><code>bi_io_vec</code>域指向一个<code>bio_vec</code>结构体数组，该结构体链表包含一个特定I/O操作所需要使用的所有片段。</p>
<ul>
<li>每个bio_vec结构都是一个形式为<code>&lt;page, offset, len&gt;的向量</code>，它描述的是一个特定的片段。段所在的物理页、块在物理页中的偏移位置、从给定偏移量开始的块长度。</li>
</ul>
<p>整个bio_vec结构体数组表示一个完整的缓冲区。bio_vec结构定义在<a href="https://github.com/torvalds/linux/blob/v3.10/include/linux/blk_types.h">include/linux/blk_types.h</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * was unsigned short, but we might as well be ready for &gt; 64kB I/O pages</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bio_vec</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span>	*<span class="title">bv_page</span>;</span> <span class="comment">//指向这个缓冲区所驻留的物理页。指向段的页框中页描述符的指针</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>	bv_len; <span class="comment">//这个缓冲区以字节为单位的大小。段的字节长度</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>	bv_offset; <span class="comment">//缓冲区所驻留的页以字节为单位的偏移量，页框中段数据的偏移量。</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>总而言之，每一个块IO请求都通过一个bio结构体表示。</p>
<ul>
<li>每个请求包括一个或多个块，这些块存储在bio_vec结构体数组中。</li>
<li>这些结构体描述了每个片段在物理页中的实际位置，并且像向量一样被组织在一起。</li>
<li>IO操作的第一个片段由bio_io_vecs指针所指向，其他的片段在其后一次防止，共有bi_vcnt个片段。</li>
<li>当块IO层开始执行请求、需要使用各个片段时，bi_idx域会不断更新，指向当前片段。</li>
<li>块IO层通过bi_idx可以跟踪IO操作的完成进度。但该域更重要的作用在于分割bio结构体。</li>
</ul>
<p>bi_cnt域记录bio结构体的使用计数，如果为0就销毁该结构体，并释放内存。通过下面的函数管理使用计数：</p>
<ul>
<li>bio_put()代码在<a href="https://github.com/torvalds/linux/blob/v3.10/fs/bio.c#L487">fs/bio.c</a>：</li>
<li><figure class="highlight c"><figcaption><span>点击展开bio_put()代码 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * bio_put - release a reference to a bio</span></span><br><span class="line"><span class="comment"> * @bio:   bio to release reference to</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Description:</span></span><br><span class="line"><span class="comment"> *   Put a reference to a &amp;struct bio, either one you have gotten with</span></span><br><span class="line"><span class="comment"> *   bio_alloc, bio_get or bio_clone. The last put of a bio will free it.</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bio_put</span><span class="params">(struct bio *bio)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	BIO_BUG_ON(!atomic_read(&amp;bio-&gt;bi_cnt));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * last put frees it</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (atomic_dec_and_test(&amp;bio-&gt;bi_cnt))</span><br><span class="line">		bio_free(bio);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(bio_put);</span><br></pre></td></tr></table></figure></li>
<li>bio_get()代码在<a href="https://github.com/torvalds/linux/blob/v3.10/include/linux/bio.h#L157">include/linux/bio.h</a>：</li>
<li><figure class="highlight c"><figcaption><span>点击展开bio_get()代码 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * get a reference to a bio, so it won't disappear. the intended use is</span></span><br><span class="line"><span class="comment"> * something like:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * bio_get(bio);</span></span><br><span class="line"><span class="comment"> * submit_bio(rw, bio);</span></span><br><span class="line"><span class="comment"> * if (bio-&gt;bi_flags ...)</span></span><br><span class="line"><span class="comment"> *	do_something</span></span><br><span class="line"><span class="comment"> * bio_put(bio);</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * without the bio_get(), it could potentially complete I/O before submit_bio</span></span><br><span class="line"><span class="comment"> * returns. and then bio would be freed memory when if (bio-&gt;bi_flags ...)</span></span><br><span class="line"><span class="comment"> * runs</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> bio_get(bio)	atomic_inc(&amp;(bio)-&gt;bi_cnt)</span></span><br></pre></td></tr></table></figure>
前者增加使用计数，后者减少使用计数（如果为0就销毁该结构体，并释放内存）在操作正在活动的bio结构体时，一定要首先增加它的使用计数，以免在操作过程中该bio结构体被释放。</li>
</ul>
<h2 id="缓冲区头与bio结构体方法对比"><a href="#缓冲区头与bio结构体方法对比" class="headerlink" title="缓冲区头与bio结构体方法对比"></a><strong>缓冲区头与bio结构体方法对比</strong></h2><p>缓冲区头和新的bio结构体之间存在显著差别：</p>
<ul>
<li>bio结构体代表的是I/O操作，它可以包括内存中的一个或多个页。由于bio结构体是轻量级的，它描述的块可以不需要连续的存储区，并且不需要分隔I/O操作。</li>
<li>buffer_head结构体代表的是一个缓冲区，它描述的仅仅是磁盘中的一个块。因为缓冲区头关联的是单独页中的单独磁盘块，所以它可能会引起不必要的分隔，将请求按块为单位划分，只能靠以后再重新组合。</li>
</ul>
<p>利用bio代替buffer_head好处有：</p>
<ul>
<li>不需要连续存储区，也不需要分割I/O操作</li>
<li>bio很容易处理高端内存，因为它处理的是物理页而不是直接指针</li>
<li>bio既可以代表普通页，也可以代表直接I/O</li>
<li>bio便于执行分散——集中(矢量化)块I/O操作，操作中的数据可以来自多个物理页</li>
<li>bio相比缓冲区头属于轻量级结构体。因为它只需要包含块I/O操作所需的信息就行了，不用包含与缓冲区本身相关的不必要信息。</li>
</ul>
<p>但是还是需要缓冲区头这个概念，毕竟它还负责描述磁盘块到页面的映射。<br>bio结构体不包含任何和缓冲区相关的状态信息——它仅仅是一个矢量数组，描述一个或多个单独块I/O操作的数据片段和相关信息。<br>在当前设置中，当bio结构体描述当前正在使用的I/O操作时，buffer_head结构体仍然需要包含缓冲区信息。<br>内核通过这两种结构分别保存各自的信息，可以保证每种结构所含的信息量尽可能少。</p>
<h2 id="请求队列"><a href="#请求队列" class="headerlink" title="请求队列"></a><strong>请求队列</strong></h2><p>块设备将它们挂起的块I/O请求保存在请求队列中，该队列由<code>request_queue结构体</code>表示，定义在文件<a href="https://github.com/torvalds/linux/blob/v3.10/include/linux/blkdev.h#L288">linux/blkdev.h</a>中，包含一个双向请求链表以及相关控制信息。</p>
<figure class="highlight c"><figcaption><span>点击展开request_queue结构体代码 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">request_queue</span> &#123;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Together with queue_head for cacheline sharing</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">queue_head</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">request</span>		*<span class="title">last_merge</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">elevator_queue</span>	*<span class="title">elevator</span>;</span></span><br><span class="line">	<span class="keyword">int</span>			nr_rqs[<span class="number">2</span>];	<span class="comment">/* # allocated [a]sync rqs */</span></span><br><span class="line">	<span class="keyword">int</span>			nr_rqs_elvpriv;	<span class="comment">/* # allocated rqs w/ elvpriv */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If blkcg is not used, @q-&gt;root_rl serves all requests.  If blkcg</span></span><br><span class="line"><span class="comment">	 * is used, root blkg allocates from @q-&gt;root_rl and all other</span></span><br><span class="line"><span class="comment">	 * blkgs from their own blkg-&gt;rl.  Which one to use should be</span></span><br><span class="line"><span class="comment">	 * determined using bio_request_list().</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">request_list</span>	<span class="title">root_rl</span>;</span></span><br><span class="line"></span><br><span class="line">	request_fn_proc		*request_fn;</span><br><span class="line">	make_request_fn		*make_request_fn;</span><br><span class="line">	prep_rq_fn		*prep_rq_fn;</span><br><span class="line">	unprep_rq_fn		*unprep_rq_fn;</span><br><span class="line">	merge_bvec_fn		*merge_bvec_fn;</span><br><span class="line">	softirq_done_fn		*softirq_done_fn;</span><br><span class="line">	rq_timed_out_fn		*rq_timed_out_fn;</span><br><span class="line">	dma_drain_needed_fn	*dma_drain_needed;</span><br><span class="line">	lld_busy_fn		*lld_busy_fn;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Dispatch queue sorting</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">sector_t</span>		end_sector;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">request</span>		*<span class="title">boundary_rq</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Delayed queue handling</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">delayed_work</span>	<span class="title">delay_work</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">backing_dev_info</span>	<span class="title">backing_dev_info</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The queue owner gets to use this for whatever they like.</span></span><br><span class="line"><span class="comment">	 * ll_rw_blk doesn't touch it.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span>			*queuedata;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * various queue flags, see QUEUE_* below</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		queue_flags;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * ida allocated id for this queue.  Used to index queues from</span></span><br><span class="line"><span class="comment">	 * ioctx.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span>			id;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * queue needs bounce pages for pages above this limit</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">gfp_t</span>			bounce_gfp;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * protects queue structures from reentrancy. -&gt;__queue_lock should</span></span><br><span class="line"><span class="comment">	 * _never_ be used directly, it is queue private. always use</span></span><br><span class="line"><span class="comment">	 * -&gt;queue_lock.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">spinlock_t</span>		__queue_lock;</span><br><span class="line">	<span class="keyword">spinlock_t</span>		*queue_lock;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * queue kobject</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PM_RUNTIME</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span>		*<span class="title">dev</span>;</span></span><br><span class="line">	<span class="keyword">int</span>			rpm_status;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		nr_pending;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * queue settings</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		nr_requests;	<span class="comment">/* Max # of requests */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		nr_congestion_on;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		nr_congestion_off;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		nr_batching;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		dma_drain_size;</span><br><span class="line">	<span class="keyword">void</span>			*dma_drain_buffer;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		dma_pad_mask;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		dma_alignment;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">blk_queue_tag</span>	*<span class="title">queue_tags</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">tag_busy_list</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		nr_sorted;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		in_flight[<span class="number">2</span>];</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Number of active block driver functions for which blk_drain_queue()</span></span><br><span class="line"><span class="comment">	 * must wait. Must be incremented around functions that unlock the</span></span><br><span class="line"><span class="comment">	 * queue_lock internally, e.g. scsi_request_fn().</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		request_fn_active;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		rq_timeout;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span>	<span class="title">timeout</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">timeout_list</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">icq_list</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BLK_CGROUP</span></span><br><span class="line">	DECLARE_BITMAP		(blkcg_pols, BLKCG_MAX_POLS);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">blkcg_gq</span>		*<span class="title">root_blkg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">blkg_list</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">queue_limits</span>	<span class="title">limits</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * sg stuff</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		sg_timeout;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		sg_reserved_size;</span><br><span class="line">	<span class="keyword">int</span>			node;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BLK_DEV_IO_TRACE</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">blk_trace</span>	*<span class="title">blk_trace</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * for flush operations</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		flush_flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		flush_not_queueable:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		flush_queue_delayed:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		flush_pending_idx:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		flush_running_idx:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		flush_pending_since;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">flush_queue</span>[2];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">flush_data_in_flight</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">request</span>		<span class="title">flush_rq</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>		<span class="title">sysfs_lock</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>			bypass_depth;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_BLK_DEV_BSG)</span></span><br><span class="line">	bsg_job_fn		*bsg_job_fn;</span><br><span class="line">	<span class="keyword">int</span>			bsg_job_size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bsg_class_device</span> <span class="title">bsg_dev</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BLK_CGROUP</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">all_q_node</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BLK_DEV_THROTTLING</span></span><br><span class="line">	<span class="comment">/* Throttle data */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">throtl_data</span> *<span class="title">td</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>		<span class="title">rcu_head</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>通过内核中像文件系统这样的高层的代码将请求加入到队列中。请求队列只要不为空，队列对应的块设备驱动程序就会从队列头获取请求，然后将其送入对应的块设备上去。</p>
<ul>
<li>请求队列表中的每一项都是一个单独的请求，由<code>request结构体</code>表示。</li>
<li>队列中的请求由结构体request表示，因为一个请求可能要操作多个连续的磁盘块，所以每个请求可以由多个bio结构体组成。</li>
<li>注意，虽然磁盘上的块必须连续，但是在内存中这些块并不一定要连续_每个bio结构体都可以描述多个段（段是内存中的连续的小区域），而每个请求也可以包含多个bio结构体。</li>
</ul>
<h2 id="I-O调度程序-块I-O调度层"><a href="#I-O调度程序-块I-O调度层" class="headerlink" title="I/O调度程序(块I/O调度层)"></a><strong>I/O调度程序(块I/O调度层)</strong></h2><p>如果简单地以内核产生的请求的次序直接将请求发向块设备的话，性能会很差。磁盘寻址是整个计算机中最慢的操作之一，每次寻址（定位磁盘磁头到特定块上的某个位置）需要花费不少时间，所以尽量缩短寻址时间无疑提高系统性能。</p>
<p>为了优化寻址操作，内核既不会简单地按请求接受次序，也不会立即将其提交给磁盘。相反，它会在提交前，先执行名为<code>合并排序</code>的<strong>预操作</strong>，这种预操作可以极大地提高系统的整体性能。</p>
<p>在内核中<code>负责提交I/O请求的子系统</code>称为<code>I/O调度程序</code>:</p>
<ul>
<li>I/O调度程序将磁盘I/O资源分配给系统中所有挂起的块I/O请求。这种资源分配是通过将请求队列中挂起的<code>请求合并和排序</code>来完成的。</li>
</ul>
<p>进程调度程序与I/O调度程序的共同点与区别：</p>
<ul>
<li>二者都是将一个资源虚拟给多个对象</li>
<li>进程调度程序的作用是将处理器资源分配给系统中的运行进程。处理器被进程调度程序虚拟给系统中的运行进程共享。</li>
<li>I/O调度程序虚拟块设备给多个磁盘请求，以便降低磁盘寻址时间，确保磁盘性能地最优化。</li>
</ul>
<h3 id="I-O调度程序的工作"><a href="#I-O调度程序的工作" class="headerlink" title="I/O调度程序的工作"></a><strong>I/O调度程序的工作</strong></h3><p>I/O调度程序的工作是管理块设备的请求队列。</p>
<ul>
<li>它决定队列中的请求排列顺序以及在什么时候派发请求到块设备。这样做有利于减少磁盘寻址时间，从而提高全局吞吐量。</li>
<li><strong>I/O调度器提高的是系统整体性能，对个别请求可能不公平。</strong></li>
</ul>
<p>I/O调度程序通过两种方法减少磁盘寻址时间：合并与排序。</p>
<ul>
<li>合并：指将两个或多个请求结合成一个请求。通过合并请求，I/O调度程序将多次请求的开销压缩成一次请求的开销。更重要的是，请求合并后只需要传递给磁盘一条寻址命令，就可以访问到请求合并前必须多次寻址才能访问完的磁盘区域了，因此合并请求显然能减少系统开销和磁盘寻址次数。<ul>
<li>比如文件系统提交请求到请求队列——请求是从文件中读取一个数据区。（当然，最终所有的操作都是针对扇区和块进行的，而不是文件，还假定请求的块都是来自文件块）。如果这时队列中已经存在一个请求，它访问的磁盘扇区和当前请求访问的磁盘扇区相邻（比如，同一个文件中早些时候被读取的数据区），那么这两个请求就可以合并为一个对单个和多个相邻磁盘扇区操作的新请求。</li>
</ul>
</li>
<li>排序：如果存在一个请求，它要操作的磁盘扇区位置与当前请求比较接近，那么是不是该让这两个请求在请求队列上也相邻呢？事实上，I/O调度程序的确是这样处理上述情况的，整个请求队列将按扇区增长方向有序排列。使所有请求按硬盘上扇区的排列顺序有序排列（尽可能的）的目的不仅是为了缩短单独一次请求的寻址时间，更重要的优化在于，通过保持磁盘头以直线方向移动，缩短了所有请求的磁盘寻址时间。该排序算法类似于电梯调度（A–&gt;B…..A—&gt;B）。</li>
</ul>
<hr>
<h2 id="访问块设备"><a href="#访问块设备" class="headerlink" title="访问块设备"></a>访问块设备</h2><p>字符设备的实现比较简单，内核例程和用户态API一一对应，这种映射关系由字符设备的file_operations维护。块设备接口则相对复杂，读写API没有直接到块设备层，而是直接到文件系统层，然后再由文件系统层发起读写请求。<br>对于块设备来说，读写操作是以数据块为单位进行的，为了使高速的 CPU 同低速块设备能够协调工作，提高读写效率，操作系统设置了缓冲机制。当进行读写的时候，首先对缓冲区读写，只有缓冲区中没有需要读的数据或是需要写的数据没有地方写时，才真正地启动设备控制器去控制设备本身进行数据交换，而对于设备本身的数据交换同样也是同缓冲区打交道。</p>
<h2 id="块设备驱动程序的注册"><a href="#块设备驱动程序的注册" class="headerlink" title="块设备驱动程序的注册"></a><strong>块设备驱动程序的注册</strong></h2><h3 id="register-blkdev-函数"><a href="#register-blkdev-函数" class="headerlink" title="register_blkdev()函数"></a><strong>register_blkdev()函数</strong></h3><p>块设备驱动中的第1个工作通常是注册它们自己到内核，申请设备号，完成这个任务的函数是<code>register_blkdev()</code>,代码在<a href="https://github.com/torvalds/linux/blob/v3.10/block/genhd.c#L285">/block/genhd.c</a></p>
<figure class="highlight c"><figcaption><span>点击展开register_blkdev()函数代码 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * register_blkdev - register a new block device</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @major: the requested major device number [1..255]. If @major=0, try to</span></span><br><span class="line"><span class="comment"> *         allocate any unused major number.</span></span><br><span class="line"><span class="comment"> * @name: the name of the new block device as a zero terminated string</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The @name must be unique within the system.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The return value depends on the @major input parameter.</span></span><br><span class="line"><span class="comment"> *  - if a major device number was requested in range [1..255] then the</span></span><br><span class="line"><span class="comment"> *    function returns zero on success, or a negative error code</span></span><br><span class="line"><span class="comment"> *  - if any unused major number was requested with @major=0 parameter</span></span><br><span class="line"><span class="comment"> *    then the return value is the allocated major number in range</span></span><br><span class="line"><span class="comment"> *    [1..255] or a negative error code otherwise</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_blkdev</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> major, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;   <span class="comment">//传入的参数是要注册的主设备号和设备名称  </span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">blk_major_name</span> **<span class="title">n</span>, *<span class="title">p</span>;</span></span><br><span class="line">	<span class="keyword">int</span> index, ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	mutex_lock(&amp;block_class_lock);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* temporary */</span></span><br><span class="line">	<span class="comment">//检查传入的主设备号是否为0，如果为0怎么办？  </span></span><br><span class="line">    <span class="comment">//如果为0的话内核会自动去major_name这个指针数组中为你分配一个主设备号</span></span><br><span class="line">    <span class="comment">//如果已经没有空闲的设备号的话，就会返回一个错误  </span></span><br><span class="line">	<span class="keyword">if</span> (major == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">for</span> (index = ARRAY_SIZE(major_names)<span class="number">-1</span>; index &gt; <span class="number">0</span>; index--) &#123;</span><br><span class="line">			<span class="keyword">if</span> (major_names[index] == <span class="literal">NULL</span>)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">			printk(<span class="string">"register_blkdev: failed to get major for %s\n"</span>,</span><br><span class="line">			       name);</span><br><span class="line">			ret = -EBUSY;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">		major = index;</span><br><span class="line">		ret = major;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//如果主设备号不为0 ，我们就可以申请一个struct blk_major_name的结构体，并将它初始化，主要是将设备号和设备名称存储到这个结构体中  </span></span><br><span class="line">	p = kmalloc(<span class="keyword">sizeof</span>(struct blk_major_name), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		ret = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	p-&gt;major = major;</span><br><span class="line">	strlcpy(p-&gt;name, name, <span class="keyword">sizeof</span>(p-&gt;name));</span><br><span class="line">	p-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">	index = major_to_index(major);</span><br><span class="line">	<span class="comment">//这个函数是做模运算用来得到一个索引值(0-255)，也许你要问了，如果我的主设备号大于255，是不是会将major_names指针数组中的元素覆盖掉？  </span></span><br><span class="line">    <span class="comment">//看看下面的for循环就明白了。假定主设备号是288，那么index = 288%255，就是33</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//内核首先拿到索引值为33的元素，用*n判断此元素是否为空，如果为空，直接跳出for循环，将上面开辟的结构体赋值给*n好了，这样就将设备的信息注册到了全局数组中去了  </span></span><br><span class="line">  <span class="comment">//如果此元素不为空，也就是已经有一个设备注册到这了，怎么办?那内核就会去比较已经注册的主设备号与我们将要注册的主设备号是否一致，如果一致，内核就会提示我们该设备号已经被占用了。</span></span><br><span class="line">  <span class="comment">//如果不一致呢？有一个next指针，这个指针是指向下一个设备的结构体，直到找到一个空的结构体，并将前面申请的结构体进行赋值。</span></span><br><span class="line">	<span class="keyword">for</span> (n = &amp;major_names[index]; *n; n = &amp;(*n)-&gt;next) &#123;</span><br><span class="line">		<span class="keyword">if</span> ((*n)-&gt;major == major)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!*n)</span><br><span class="line">		*n = p;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		ret = -EBUSY;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">"register_blkdev: cannot get major %d for %s\n"</span>,</span><br><span class="line">		       major, name);</span><br><span class="line">		kfree(p);</span><br><span class="line">	&#125;</span><br><span class="line">out:</span><br><span class="line">	mutex_unlock(&amp;block_class_lock);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EXPORT_SYMBOL(register_blkdev);</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li>major参数是块设备要使用的主设备号，name为设备名，它会显示在<code>/proc/devices</code>中。如果major为0，内核会自动分配一个新的主设备号，register_blkdev()函数的返回值就是这个主设备号。</li>
<li>如果register_blkdev()返回一个负值，表明发生了一个错误。</li>
<li><code>/proc/devices</code>是一个文件，这个文件列出字符和块设备的主设备号，以及分配到这些设备号的设备名称。示例如下：</li>
<li><figure class="highlight c"><figcaption><span>点击展开/proc/devices示例 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="meta"># cat /proc/devices </span></span><br><span class="line">Character devices:</span><br><span class="line">  <span class="number">1</span> mem</span><br><span class="line">  <span class="number">4</span> /dev/vc/<span class="number">0</span></span><br><span class="line">  <span class="number">4</span> tty</span><br><span class="line">  <span class="number">4</span> ttyS</span><br><span class="line">  <span class="number">5</span> /dev/tty</span><br><span class="line">  <span class="number">5</span> /dev/console</span><br><span class="line">  <span class="number">5</span> /dev/ptmx</span><br><span class="line">  <span class="number">7</span> vcs</span><br><span class="line"> <span class="number">10</span> misc</span><br><span class="line"> <span class="number">13</span> input</span><br><span class="line"> <span class="number">21</span> sg</span><br><span class="line"> <span class="number">29</span> fb</span><br><span class="line"><span class="number">128</span> ptm</span><br><span class="line"><span class="number">136</span> pts</span><br><span class="line"><span class="number">162</span> raw</span><br><span class="line"><span class="number">180</span> usb</span><br><span class="line"><span class="number">188</span> ttyUSB</span><br><span class="line"><span class="number">189</span> usb_device</span><br><span class="line"><span class="number">202</span> cpu/msr</span><br><span class="line"><span class="number">203</span> cpu/cpuid</span><br><span class="line"><span class="number">226</span> drm</span><br><span class="line"><span class="number">231</span> infiniband_mad</span><br><span class="line"><span class="number">231</span> infiniband_verbs</span><br><span class="line"><span class="number">231</span> infiniband_cm</span><br><span class="line"><span class="number">235</span> infiniband_cm</span><br><span class="line"><span class="number">236</span> infiniband_mad</span><br><span class="line"><span class="number">237</span> mlx5_fpga_tools</span><br><span class="line"><span class="number">238</span> mei</span><br><span class="line"><span class="number">239</span> ipmidev</span><br><span class="line"><span class="number">240</span> infiniband_verbs</span><br><span class="line"><span class="number">241</span> aux</span><br><span class="line"><span class="number">242</span> nvme</span><br><span class="line"><span class="number">243</span> megaraid_sas_ioctl</span><br><span class="line"><span class="number">244</span> ptp</span><br><span class="line"><span class="number">245</span> pps</span><br><span class="line"><span class="number">246</span> hidraw</span><br><span class="line"><span class="number">247</span> usbmon</span><br><span class="line"><span class="number">248</span> bsg</span><br><span class="line"><span class="number">249</span> hmm_device</span><br><span class="line"><span class="number">250</span> watchdog</span><br><span class="line"><span class="number">251</span> iio</span><br><span class="line"><span class="number">252</span> rtc</span><br><span class="line"><span class="number">253</span> dax</span><br><span class="line"><span class="number">254</span> tpm</span><br><span class="line"></span><br><span class="line">Block devices:</span><br><span class="line"><span class="number">259</span> blkext</span><br><span class="line">  <span class="number">8</span> sd</span><br><span class="line">  <span class="number">9</span> md</span><br><span class="line"> <span class="number">11</span> sr</span><br><span class="line"> <span class="number">65</span> sd</span><br><span class="line"> <span class="number">66</span> sd</span><br><span class="line"> <span class="number">67</span> sd</span><br><span class="line"> <span class="number">68</span> sd</span><br><span class="line"> <span class="number">69</span> sd</span><br><span class="line"> <span class="number">70</span> sd</span><br><span class="line"> <span class="number">71</span> sd</span><br><span class="line"><span class="number">128</span> sd</span><br><span class="line"><span class="number">129</span> sd</span><br><span class="line"><span class="number">130</span> sd</span><br><span class="line"><span class="number">131</span> sd</span><br><span class="line"><span class="number">132</span> sd</span><br><span class="line"><span class="number">133</span> sd</span><br><span class="line"><span class="number">134</span> sd</span><br><span class="line"><span class="number">135</span> sd</span><br><span class="line"><span class="number">254</span> mdp</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="major-names数组"><a href="#major-names数组" class="headerlink" title="major_names数组"></a><strong>major_names数组</strong></h3><p>代码在<a href="https://github.com/torvalds/linux/blob/v3.10/block/genhd.c#L243">block/genhd.c</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">blk_major_name</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">blk_major_name</span> *<span class="title">next</span>;</span></span><br><span class="line">	<span class="keyword">int</span> major;</span><br><span class="line">	<span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">&#125; *major_names[BLKDEV_MAJOR_HASH_SIZE];</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li>BLKDEV_MAJOR_HASH_SIZE = 255</li>
<li>这是一个指针数组，其中的每一个元素都指向了一个struct blk_major_name的结构体</li>
<li>struct blk_major_name结构体就是用来存放设备的主设备号和设备名称的</li>
<li>更加详细的解释看参考文献。</li>
</ul>
<h3 id="unregister-blkdev-函数"><a href="#unregister-blkdev-函数" class="headerlink" title="unregister_blkdev()函数"></a><strong>unregister_blkdev()函数</strong></h3><p><code>unregister_blkdev()</code>代码在<a href="https://github.com/torvalds/linux/blob/v3.10/block/genhd.c#L341">/block/genhd.c</a></p>
<figure class="highlight c"><figcaption><span>点击展开unregister_blkdev()函数代码 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unregister_blkdev</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> major, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">blk_major_name</span> **<span class="title">n</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">blk_major_name</span> *<span class="title">p</span> = <span class="title">NULL</span>;</span></span><br><span class="line">	<span class="keyword">int</span> index = major_to_index(major);</span><br><span class="line"></span><br><span class="line">	mutex_lock(&amp;block_class_lock);</span><br><span class="line">	<span class="keyword">for</span> (n = &amp;major_names[index]; *n; n = &amp;(*n)-&gt;next)</span><br><span class="line">		<span class="keyword">if</span> ((*n)-&gt;major == major)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">if</span> (!*n || <span class="built_in">strcmp</span>((*n)-&gt;name, name)) &#123;</span><br><span class="line">		WARN_ON(<span class="number">1</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		p = *n;</span><br><span class="line">		*n = p-&gt;next;</span><br><span class="line">	&#125;</span><br><span class="line">	mutex_unlock(&amp;block_class_lock);</span><br><span class="line">	kfree(p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EXPORT_SYMBOL(unregister_blkdev);</span><br></pre></td></tr></table></figure>
<p>说明：传递给register_blkdev()的参数必须与传递给unregister_blkdev()的参数匹配，否则这个函数返回-EINVAL。</p>
<p>两个函数的声明代码在<a href="https://github.com/torvalds/linux/blob/v3.10/include/linux/fs.h#L2046">include/linux/fs.h</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">register_blkdev</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">const</span> <span class="keyword">char</span> *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">unregister_blkdev</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">const</span> <span class="keyword">char</span> *)</span></span>;</span><br></pre></td></tr></table></figure>





<p>每种具体的块设备都有一套具体的操作，因而各自有一个类似于file_operations 那样的数据结构，称为block_device_operations 结构。它是对块设备操作的集合，其定义为,代码在<a href="https://github.com/torvalds/linux/blob/v3.10/include/linux/blkdev.h#L288">include/linux/blkdev.h</a>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">block_device_operations</span> &#123;</span></span><br><span class="line">	<span class="comment">//打开和释放</span></span><br><span class="line">	<span class="keyword">int</span> (*<span class="built_in">open</span>) (struct block_device *, <span class="keyword">fmode_t</span>);</span><br><span class="line">	<span class="keyword">void</span> (*<span class="built_in">release</span>) (struct gendisk *, <span class="keyword">fmode_t</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//I/O控制</span></span><br><span class="line">	<span class="keyword">int</span> (*ioctl) (struct block_device *, <span class="keyword">fmode_t</span>, <span class="keyword">unsigned</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>);</span><br><span class="line">	<span class="keyword">int</span> (*compat_ioctl) (struct block_device *, <span class="keyword">fmode_t</span>, <span class="keyword">unsigned</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> (*direct_access) (struct block_device *, <span class="keyword">sector_t</span>,</span><br><span class="line">						<span class="keyword">void</span> **, <span class="keyword">unsigned</span> <span class="keyword">long</span> *);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//介质改变</span></span><br><span class="line">	<span class="function"><span class="keyword">unsigned</span> <span class="title">int</span> <span class="params">(*check_events)</span> <span class="params">(struct gendisk *disk,</span></span></span><br><span class="line"><span class="function"><span class="params">				      <span class="keyword">unsigned</span> <span class="keyword">int</span> clearing)</span></span>;</span><br><span class="line">	<span class="comment">/* -&gt;media_changed() is DEPRECATED, use -&gt;check_events() instead */</span></span><br><span class="line">	<span class="keyword">int</span> (*media_changed) (struct gendisk *);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">void</span> (*unlock_native_capacity) (struct gendisk *);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//使介质有效</span></span><br><span class="line">	<span class="keyword">int</span> (*revalidate_disk) (struct gendisk *);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//获得驱动器信息</span></span><br><span class="line">	<span class="keyword">int</span> (*getgeo)(struct block_device *, struct hd_geometry *);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* this callback is with swap_lock and sometimes page table lock held */</span></span><br><span class="line">	<span class="keyword">void</span> (*swap_slot_free_notify) (struct block_device *, <span class="keyword">unsigned</span> <span class="keyword">long</span>);、</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//模块指针，一个指向拥有这个结构体的模块的指针，它通常被初始化为THIS_MODULE</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果说<strong>file_operation 结构</strong>是连接虚拟的VFS 文件的操作与具体文件系统的文件操作之间的枢纽，那么<strong>block_device_operations</strong>就是连接抽象的块设备操作与具体块设备操作之间的枢纽。</p>
</blockquote>
<p>具体的块设备是由主设备号唯一确定的，因此，主设备号唯一地确定了一个具体的<code>block_device_operations 数据结构</code>。</p>
<p>那么，块设备注册到系统以后，怎样与文件系统联系起来呢，也就是说，文件系统怎么调用已注册的块设备，这还得从file_operations 结构说起。</p>
<p>先来看一下块设备的file_operations 结构的定义，变量名为<code>def_blk_fops</code>，其位于<a href="https://github.com/torvalds/linux/blob/v3.10/fs/block_dev.c#L1588">fs/block_dev.c</a>中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">def_blk_fops</span> = &#123;</span></span><br><span class="line">	.<span class="built_in">open</span>		= blkdev_open,</span><br><span class="line">	.<span class="built_in">release</span>	= blkdev_close,</span><br><span class="line">	.llseek		= block_llseek,</span><br><span class="line">	.<span class="built_in">read</span>		= do_sync_read,</span><br><span class="line">	.<span class="built_in">write</span>		= do_sync_write,</span><br><span class="line">	.aio_read	= blkdev_aio_read,</span><br><span class="line">	.aio_write	= blkdev_aio_write,</span><br><span class="line">	.mmap		= generic_file_mmap,</span><br><span class="line">	.fsync		= blkdev_fsync,</span><br><span class="line">	.unlocked_ioctl	= block_ioctl,</span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">	.compat_ioctl	= compat_blkdev_ioctl,</span><br><span class="line">#endif</span><br><span class="line">	.splice_read	= generic_file_splice_read,</span><br><span class="line">	.splice_write	= generic_file_splice_write,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>以open()系统调用为例，说明用户进程中的一个系统调用如何最终与物理块设备的操作联系起来。在此，我们仅仅给出几个<code>open()</code>函数的调用关系，如图所示。</p>
<center><img src="/2020/08/17/Linux-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/几个open函数的调用关系.PNG">  </center>
<center>图6.几个open函数的调用关系</center>

<ul>
<li>当调用open()系统调用时，其最终会调用到def_blk_fops的blkdev_open() 函数。</li>
<li>blkdev_open()函数的任务：<u>根据主设备号找到对应的block_device_operations结构</u>，然后再调用block_device_operations结构中的函数指针open所指向的函数，如果open 所指向的函数非空，就调用该函数打开最终的物理块设备。</li>
</ul>
<p>这就简单地说明了块设备注册以后，从最上层的系统调用到具体地打开一个设备的过程。</p>
<h2 id="块驱动程序的体系结构"><a href="#块驱动程序的体系结构" class="headerlink" title="块驱动程序的体系结构"></a>块驱动程序的体系结构</h2><p>块设备驱动程序通常分为两部分，即高级驱动程序和低级驱动程序，前者处理VFS 层，后者处理硬件设备</p>
<center><img src="/2020/08/17/Linux-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/块设备驱动程序的体系结构.PNG">  </center>
<center>图7.块设备驱动程序的体系结构</center>

<p>假设进程对一个设备文件发出read()或write()系统调用。<br>VFS 执行对应文件对象的read 或write方法，由此就调用高级块设备处理程序中的一个<strong>过程</strong>。这个过程执行的所有操作都与对这个硬件设备的具体读写请求有关。<br>内核提供两个名为generic_file_read()和generic_file_write()通用函数来留意所有事件的发生。<br>因此，在大部分情况下，高级硬件设备驱动程序不必做什么，而设备文件的read和write方法分别指向generic_file_read()和generic_file_write()方法。但是，有些块设备的处理程序需要自己专用的高级设备驱动程序。</p>
<p>即使高级设备驱动程序有自己的read 和write 方法，但是这两个方法通常最终还会调用generic_file_read ( )和generic_file_write ( )函数。这些函数把对I/O 设备文件的访问请求转换成对相应硬件设备的块请求。</p>
<ul>
<li>所请求的块可能已在主存， 因此generic_file_read ( )和generic_file_write ( )函数调用<code>getblk()函数</code>来检查缓冲区中是否已经预取了块，还是从上次访问以来缓冲区一直都没有改变。</li>
<li>如果块不在缓冲区中，getblk()就必须调用<code>ll_rw_block()</code>继续从磁盘中读取这个块，后面这个函数激活操纵设备控制器的低级驱动程序，以执行对块设备所请求的操作。</li>
</ul>
<p>在VFS 直接访问某一块设备上的特定块时，也会触发缓冲区I/O 操作。</p>
<ul>
<li>例如，如果内核必须从磁盘文件系统中读取一个索引节点，那么它必须从相应磁盘分区的块中传送数据 。</li>
<li>对于<code>特定块的直接访问</code>是由bread()和breada()函数来执行的，这两个函数又会调用前面提到过的getblk()和ll_rw_block()函数。</li>
</ul>
<p>由于块设备速度很慢，因此缓冲区I/O 数据传送通常都是异步处理的：</p>
<ul>
<li>低级设备驱动程序对DMAC和磁盘控制器进行编程来控制其操作，然后结束。当数据传送完成时，就会产生一个中断，从而第2次激活这个低级设备驱动程序来清除这次I/O 操作所涉及的数据结构。</li>
</ul>
<h2 id="块设备基于缓冲区的数据交换"><a href="#块设备基于缓冲区的数据交换" class="headerlink" title="块设备基于缓冲区的数据交换"></a>块设备基于缓冲区的数据交换</h2><p>对于块设备来说，读写操作是以数据块为单位进行的，为了使高速的 CPU 同低速块设备能够协调工作，提高读写效率，操作系统设置了缓冲机制。<br>块设备读和写当进行读写的时候，首先对缓冲区读写，只有缓冲区中没有需要读的数据或是需要写的数据没有地方写时，才真正地启动设备控制器去控制设备本身进行数据交换，而对于设备本身的数据交换同样也是同缓冲区打交道。</p>
<p>在PC 体系结构中，允许块的大小为512、1024、2048 和4096 字节。同一个块设备驱动程序可以作用于多个块大小，因为它必须处理共享**同一主设备号的一组设备文件，而每个块设备文件都有自己预定义的块大小。</p>
<p>例如，一个块设备驱动程序可能会处理有两个分区的硬盘，一个分区包含Ext2 文件系统，另一个分区包含交换分区。<br>内核在一个名为<code>blksize_size</code>的表中存放块的大小；<br>表中每个元素的索引就是相应块设备文件的主设备号和从设备号。如果blksize_size[M]为NULL，那么共享主设备号M的所有块设备都使用标准的块大小，即1024 字节。</p>
<p>每个块都需要自己的缓冲区，它是内核用来存放块内容的<code>RAM内存区</code>。当设备驱动程序从磁盘读出一个块时，就用从硬件设备中所获得的值来填充相应的缓冲区；同样，当设备驱动程序向磁盘中写入一个块时，就用相关缓冲区的实际值来更新硬件设备上相应的一组相邻字节。<br>缓冲区的大小一定要与块的大小相匹配。</p>
<h2 id="块设备请求"><a href="#块设备请求" class="headerlink" title="块设备请求"></a>块设备请求</h2><p>虽然块设备驱动程序可以一次传送一个单独的数据块，但是内核并不会为磁盘上每个被访问的数据块都单独执行一次I/O 操作,取而代之的是，只要可能，内核就试图把几个块合并在一起，并作为一个整体来处理，这样就减少了磁头的平均移动时间。</p>
<p>当进程、VFS 层或者任何其他的内核部分要读写一个磁盘块时，就真正引起一个块设备请求。</p>
<ul>
<li>从本质上说，这个请求描述的是所请求的块以及要对它执行的操作类型（读还是写）。</li>
<li>然而，并不是请求一发出，内核就满足它，实际上，<u>块请求发出时I/O 操作仅仅被调度，稍后才会被执行(先调度，后执行)</u>。这种人为的延迟有悖于提高块设备性能的关键机制。</li>
<li>当请求传送一个新的数据块时，内核检查能否通过稍微扩大前一个一直处于等待状态的请求而满足这个新请求，也就是说，能否不用进一步的搜索操作就能满足新请求。由于磁盘的访问大都是顺序的，因此这种简单机制就非常高效。</li>
</ul>
<p>延迟请求复杂化了块设备的处理。</p>
<ul>
<li>例如，假设某个进程打开了一个普通文件，然后，文件系统的驱动程序就要从磁盘读取相应的索引节点。高级块设备驱动程序把这个请求加入一个等待队列，并把这个进程挂起，直到存放索引节点的块被传送为止。因为块设备驱动程序是中断驱动的，因此，只要高级驱动程序一发出块请求，它就可以终止执行。</li>
<li>在稍后的时间低级驱动程序才被激活，它会调用一个所谓的策略程序从一个队列中取得这个请求，并向磁盘控制器发出适当的命令来满足这个请求。当I/O 操作完成时，磁盘控制器就产生一个中断，如果需要，相应的处理程序会再次调用这个策略程序来处理队列中进程的下一个请求。</li>
</ul>
<p>每个块设备驱动程序都维护自己的请求队列；每个物理块设备都应该有一个请求队列，以提高磁盘性能的方式对请求进行排序。<br>因此策略程序就可以顺序扫描这种队列，并以最少地移动磁头而为所有的请求提供服务。</p>
<h2 id="块设备驱动程序的几个函数"><a href="#块设备驱动程序的几个函数" class="headerlink" title="块设备驱动程序的几个函数"></a>块设备驱动程序的几个函数</h2><h2 id="Linux中硬盘驱动程序的实现"><a href="#Linux中硬盘驱动程序的实现" class="headerlink" title="Linux中硬盘驱动程序的实现"></a><strong>Linux中硬盘驱动程序的实现</strong></h2><h2 id="重要文件"><a href="#重要文件" class="headerlink" title="重要文件"></a>重要文件</h2><p>由于块设备驱动程序的绝大部分都与设备无关的，故内核开发者通过把大部分相同的代码放在一个头文件<a href="https://github.com/torvalds/linux/blob/v3.10/block/blk.h">block/blk.h</a>中来简化驱动程序的代码。从而每个块设备驱动程序都必须 包含这个头文件。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a><strong>参考资料</strong></h2><p>《深入分析Linux内核源代码》 //书籍内核版本有些旧<br>《Linux内核设计与实现》     //目前感觉这个版本是最准的<br><a href="https://www.byteisland.com/linux-%E9%80%9A%E7%94%A8%E5%9D%97%E5%B1%82-bio-%E8%AF%A6%E8%A7%A3/">Linux 通用块层 bio 详解</a><br><a href="https://www.xuebuyuan.com/1697885.html">块设备注册 register_blkdev | 学步园 </a></p>

        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/Linux/" rel="tag">Linux</a>, <a class="has-link-grey -link" href="/tags/%E5%9D%97%E8%AE%BE%E5%A4%87/" rel="tag">块设备</a>, <a class="has-link-grey -link" href="/tags/%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/" rel="tag">驱动程序</a>
                </div>
            </div>
        </div>
        
        
        
        <div class="social-share"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css">
<script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3>
        <div class="buttons is-centered">
            
        </div>
    </div>
</div>



<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2020/09/25/C-%E7%B2%BE%E5%BA%A6%E6%8E%A7%E5%88%B6/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">C++精度控制</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2020/08/16/Linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%B3%A8%E5%86%8C%E3%80%81%E5%AE%89%E8%A3%85%E4%B8%8E%E5%8D%B8%E8%BD%BD/">
                <span class="level-item">Linux文件系统注册、安装与卸载</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">评论</h3>
        
<div id="comment-container"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.min.js"></script>
<script>
    var gitalk = new Gitalk({
        clientID: 'e79770cfee30db02a856',
        clientSecret: 'bb958f5fc30797ffc222ca631ec345baa48a0bee',
        id: 'fe3b5f8cdd33597af83b876b3c1973c6',
        repo: 'STEMHA.github.io',
        owner: 'STEMHA',
        admin: "STEMHA",
        createIssueManually: false,
        distractionFreeMode: false
    })
    gitalk.render('comment-container')
</script>

    </div>
</div>
</div>-->
			   <!-- 原始代码-->
               <!--  




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                    <figure class="image is-128x128 has-mb-6">
                        <img class="" src="/images/avatar.png" alt="STEMHA">
                    </figure>
                    
                    <p class="is-size-4 is-block">
                        STEMHA
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        student
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>China</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <a href="/archives">
                        <p class="title has-text-weight-normal">
                            74
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <a href="/categories">
                        <p class="title has-text-weight-normal">
                            14
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <a href="/tags">
                        <p class="title has-text-weight-normal">
                            104
                        </p>
                    </a>
                </div>
            </div>
        </nav>
        
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/STEMHA" target="_blank" rel="noopener">
                关注我</a>
        </div>
        
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Github" href="https://github.com/STEMHA">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Facebook" href="https://facebook.com">
                
                <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Twitter" href="https://twitter.com">
                
                <i class="fab fa-twitter"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Dribbble" href="https://dribbble.com">
                
                <i class="fab fa-dribbble"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="RSS" href="/rss.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        

    <div class="card widget" id="toc">
        <div class="card-content">
            <div class="menu">
                <h3 class="menu-label">
                    目录
                </h3>
                <ul class="menu-list"><li>
        <a class="is-flex" href="#概述">
        <span class="has-mr-6">1</span>
        <span>概述</span>
        </a></li><li>
        <a class="is-flex" href="#块设备与字符设备">
        <span class="has-mr-6">2</span>
        <span>块设备与字符设备</span>
        </a></li><li>
        <a class="is-flex" href="#块设备的扇区-内核的块">
        <span class="has-mr-6">3</span>
        <span>块设备的扇区/内核的块</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#扇区">
        <span class="has-mr-6">3.1</span>
        <span>扇区</span>
        </a></li><li>
        <a class="is-flex" href="#块">
        <span class="has-mr-6">3.2</span>
        <span>块</span>
        </a></li><li>
        <a class="is-flex" href="#扇区与块的关系">
        <span class="has-mr-6">3.3</span>
        <span>扇区与块的关系</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#块设备的处理">
        <span class="has-mr-6">4</span>
        <span>块设备的处理</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#块设备内核组件管理数据的方式">
        <span class="has-mr-6">4.1</span>
        <span>块设备内核组件管理数据的方式</span>
        </a></li><li>
        <a class="is-flex" href="#管理数据方式示例">
        <span class="has-mr-6">4.2</span>
        <span>管理数据方式示例</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#段">
        <span class="has-mr-6">5</span>
        <span>段</span>
        </a></li><li>
        <a class="is-flex" href="#缓冲区与缓冲区头">
        <span class="has-mr-6">6</span>
        <span>缓冲区与缓冲区头</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#buffer-head结构体">
        <span class="has-mr-6">6.1</span>
        <span>buffer_head结构体</span>
        </a></li><li>
        <a class="is-flex" href="#块缓冲区头、块缓冲区以及页框的关系">
        <span class="has-mr-6">6.2</span>
        <span>块缓冲区头、块缓冲区以及页框的关系</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#通用块层">
        <span class="has-mr-6">7</span>
        <span>通用块层</span>
        </a></li><li>
        <a class="is-flex" href="#bio结构体">
        <span class="has-mr-6">8</span>
        <span>bio结构体</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#I-O-向量">
        <span class="has-mr-6">8.1</span>
        <span>I/O 向量</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#缓冲区头与bio结构体方法对比">
        <span class="has-mr-6">9</span>
        <span>缓冲区头与bio结构体方法对比</span>
        </a></li><li>
        <a class="is-flex" href="#请求队列">
        <span class="has-mr-6">10</span>
        <span>请求队列</span>
        </a></li><li>
        <a class="is-flex" href="#I-O调度程序-块I-O调度层">
        <span class="has-mr-6">11</span>
        <span>I/O调度程序(块I/O调度层)</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#I-O调度程序的工作">
        <span class="has-mr-6">11.1</span>
        <span>I/O调度程序的工作</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#访问块设备">
        <span class="has-mr-6">12</span>
        <span>访问块设备</span>
        </a></li><li>
        <a class="is-flex" href="#块设备驱动程序的注册">
        <span class="has-mr-6">13</span>
        <span>块设备驱动程序的注册</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#register-blkdev-函数">
        <span class="has-mr-6">13.1</span>
        <span>register_blkdev()函数</span>
        </a></li><li>
        <a class="is-flex" href="#major-names数组">
        <span class="has-mr-6">13.2</span>
        <span>major_names数组</span>
        </a></li><li>
        <a class="is-flex" href="#unregister-blkdev-函数">
        <span class="has-mr-6">13.3</span>
        <span>unregister_blkdev()函数</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#块驱动程序的体系结构">
        <span class="has-mr-6">14</span>
        <span>块驱动程序的体系结构</span>
        </a></li><li>
        <a class="is-flex" href="#块设备基于缓冲区的数据交换">
        <span class="has-mr-6">15</span>
        <span>块设备基于缓冲区的数据交换</span>
        </a></li><li>
        <a class="is-flex" href="#块设备请求">
        <span class="has-mr-6">16</span>
        <span>块设备请求</span>
        </a></li><li>
        <a class="is-flex" href="#块设备驱动程序的几个函数">
        <span class="has-mr-6">17</span>
        <span>块设备驱动程序的几个函数</span>
        </a></li><li>
        <a class="is-flex" href="#Linux中硬盘驱动程序的实现">
        <span class="has-mr-6">18</span>
        <span>Linux中硬盘驱动程序的实现</span>
        </a></li><li>
        <a class="is-flex" href="#重要文件">
        <span class="has-mr-6">19</span>
        <span>重要文件</span>
        </a></li><li>
        <a class="is-flex" href="#参考资料">
        <span class="has-mr-6">20</span>
        <span>参考资料</span>
        </a></li></ul>
            </div>
        </div>
    </div>

    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            链接
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">Hexo</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">hexo.io</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://github.com/ppoffice" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">PPOffice</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">github.com</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://github.com/STEMHA" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">GitHub - STEMHA</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">github.com</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>

    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/C/">
            <span class="level-start">
                <span class="level-item">C++</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">19</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Linux/">
            <span class="level-start">
                <span class="level-item">Linux</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">21</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E5%8D%9A%E5%AE%A2%E7%BB%B4%E6%8A%A4/">
            <span class="level-start">
                <span class="level-item">博客维护</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E5%AD%A6%E6%9C%AF%E8%AE%BA%E6%96%87/">
            <span class="level-start">
                <span class="level-item">学术论文</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">
            <span class="level-start">
                <span class="level-item">操作系统</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E6%95%88%E7%8E%87%E5%B7%A5%E5%85%B7/">
            <span class="level-start">
                <span class="level-item">效率工具</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">
            <span class="level-start">
                <span class="level-item">数据结构</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">5</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E7%AE%97%E6%B3%95/">
            <span class="level-start">
                <span class="level-item">算法</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E8%8B%B1%E8%AF%AD%E5%AD%A6%E4%B9%A0/">
            <span class="level-start">
                <span class="level-item">英语学习</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">
            <span class="level-start">
                <span class="level-item">计算机网络</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">7</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">
            <span class="level-start">
                <span class="level-item">读书笔记</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E8%AF%BE%E5%A4%96%E5%AD%A6%E6%9C%AF%E9%98%85%E8%AF%BB/">
            <span class="level-start">
                <span class="level-item">课外学术阅读</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/">
            <span class="level-start">
                <span class="level-item">软件工程</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E9%86%92%E4%B8%96%E9%80%9A%E8%A8%80/">
            <span class="level-start">
                <span class="level-item">醒世通言</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/B-%E6%A0%91/" style="font-size: 10px;">B+树</a> <a href="/tags/B-%E6%A0%91/" style="font-size: 10px;">B-树</a> <a href="/tags/C/" style="font-size: 16.25px;">C++</a> <a href="/tags/C-%E6%A0%87%E5%87%86%E5%BA%93/" style="font-size: 18.75px;">C++标准库</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/tags/Linux%E6%A6%82%E8%BF%B0/" style="font-size: 10px;">Linux概述</a> <a href="/tags/TCP/" style="font-size: 13.75px;">TCP</a> <a href="/tags/UDP/" style="font-size: 10px;">UDP</a> <a href="/tags/VFS/" style="font-size: 10px;">VFS</a> <a href="/tags/chrome/" style="font-size: 10px;">chrome</a> <a href="/tags/deque/" style="font-size: 10px;">deque</a> <a href="/tags/heap/" style="font-size: 10px;">heap</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/leetcode/" style="font-size: 10px;">leetcode</a> <a href="/tags/list/" style="font-size: 10px;">list</a> <a href="/tags/map/" style="font-size: 10px;">map</a> <a href="/tags/module/" style="font-size: 10px;">module</a> <a href="/tags/pair/" style="font-size: 10px;">pair</a> <a href="/tags/priority-queue/" style="font-size: 10px;">priority_queue</a> <a href="/tags/queue/" style="font-size: 10px;">queue</a> <a href="/tags/set/" style="font-size: 10px;">set</a> <a href="/tags/stack/" style="font-size: 10px;">stack</a> <a href="/tags/string/" style="font-size: 10px;">string</a> <a href="/tags/vector/" style="font-size: 10px;">vector</a> <a href="/tags/%E4%BA%92%E6%96%A5%E9%94%81/" style="font-size: 10px;">互斥锁</a> <a href="/tags/%E4%BA%BA%E7%94%9F/" style="font-size: 10px;">人生</a> <a href="/tags/%E4%BC%A0%E8%AE%B0/" style="font-size: 10px;">传记</a> <a href="/tags/%E4%BC%A0%E8%BE%93%E5%B1%82/" style="font-size: 15px;">传输层</a> <a href="/tags/%E4%BF%A1%E5%8F%B7%E9%87%8F/" style="font-size: 10px;">信号量</a> <a href="/tags/%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/" style="font-size: 10px;">关联容器</a> <a href="/tags/%E5%86%85%E5%AD%98%E5%88%86%E5%8C%BA/" style="font-size: 10px;">内存分区</a> <a href="/tags/%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/" style="font-size: 10px;">内存分配</a> <a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 10px;">内存管理</a> <a href="/tags/%E5%86%85%E6%A0%B8/" style="font-size: 17.5px;">内核</a> <a href="/tags/%E5%88%9D%E5%A7%8B%E5%8C%96/" style="font-size: 10px;">初始化</a> <a href="/tags/%E5%8A%A8%E6%80%81%E5%A4%9A%E6%80%81/" style="font-size: 10px;">动态多态</a> <a href="/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">单例模式</a> <a href="/tags/%E5%90%8D%E8%91%97/" style="font-size: 10px;">名著</a> <a href="/tags/%E5%91%BD%E4%BB%A4/" style="font-size: 11.25px;">命令</a> <a href="/tags/%E5%93%B2%E5%AD%A6/" style="font-size: 10px;">哲学</a> <a href="/tags/%E5%9D%97%E8%AE%BE%E5%A4%87/" style="font-size: 10px;">块设备</a> <a href="/tags/%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84/" style="font-size: 10px;">基本结构</a> <a href="/tags/%E5%A4%9A%E6%80%81/" style="font-size: 10px;">多态</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 10px;">多线程</a> <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="font-size: 10px;">大数据</a> <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE%E8%AE%A1%E7%AE%97/" style="font-size: 10px;">大数据计算</a> <a href="/tags/%E5%A5%97%E6%8E%A5%E5%AD%97/" style="font-size: 10px;">套接字</a> <a href="/tags/%E5%AD%A6%E6%9C%AF%E8%AE%BA%E6%96%87/" style="font-size: 10px;">学术论文</a> <a href="/tags/%E5%AE%B9%E5%99%A8%E7%B1%BB/" style="font-size: 10px;">容器类</a> <a href="/tags/%E5%B0%81%E8%A3%85/" style="font-size: 10px;">封装</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 11.25px;">工具</a> <a href="/tags/%E5%BA%94%E7%94%A8%E5%B1%82/" style="font-size: 10px;">应用层</a> <a href="/tags/%E5%BF%83%E6%80%81/" style="font-size: 10px;">心态</a> <a href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" style="font-size: 11.25px;">性能分析</a> <a href="/tags/%E6%8C%91%E6%88%98/" style="font-size: 10px;">挑战</a> <a href="/tags/%E6%8F%92%E4%BB%B6/" style="font-size: 10px;">插件</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">操作系统</a> <a href="/tags/%E6%95%99%E7%A8%8B/" style="font-size: 10px;">教程</a> <a href="/tags/%E6%95%A3%E5%88%97%E8%A1%A8/" style="font-size: 10px;">散列表</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 12.5px;">数据结构</a> <a href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8E%E7%9B%AE%E5%BD%95/" style="font-size: 10px;">文件与目录</a> <a href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" style="font-size: 11.25px;">文件系统</a> <a href="/tags/%E6%96%87%E6%A1%A3%E5%92%8C%E6%B3%A8%E9%87%8A/" style="font-size: 10px;">文档和注释</a> <a href="/tags/%E6%A0%88/" style="font-size: 10px;">栈</a> <a href="/tags/%E6%A1%B6%E6%8E%92%E5%BA%8F/" style="font-size: 10px;">桶排序</a> <a href="/tags/%E6%A6%82%E8%BF%B0/" style="font-size: 11.25px;">概述</a> <a href="/tags/%E6%A8%A1%E5%9D%97/" style="font-size: 10px;">模块</a> <a href="/tags/%E6%B5%85%E6%8B%B7%E8%B4%9D/" style="font-size: 10px;">浅拷贝</a> <a href="/tags/%E6%B7%B1%E6%8B%B7%E8%B4%9D/" style="font-size: 10px;">深拷贝</a> <a href="/tags/%E6%BC%94%E8%AE%B2/" style="font-size: 10px;">演讲</a> <a href="/tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/" style="font-size: 10px;">版本控制</a> <a href="/tags/%E7%89%B9%E6%AE%8A%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">特殊文件系统</a> <a href="/tags/%E7%94%9F%E4%BA%A7%E5%8A%9B/" style="font-size: 10px;">生产力</a> <a href="/tags/%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84/" style="font-size: 11.25px;">目录结构</a> <a href="/tags/%E7%A0%94%E7%A9%B6%E6%96%B9%E6%B3%95%E8%AE%BA/" style="font-size: 10px;">研究方法论</a> <a href="/tags/%E7%A1%AC%E8%BF%9E%E6%8E%A5/" style="font-size: 10px;">硬连接</a> <a href="/tags/%E7%A8%8B%E5%BA%8F%E6%89%A7%E8%A1%8C/" style="font-size: 10px;">程序执行</a> <a href="/tags/%E7%AE%80%E8%BF%B0/" style="font-size: 10px;">简述</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 13.75px;">算法</a> <a href="/tags/%E7%BA%A2%E9%BB%91%E6%A0%91/" style="font-size: 10px;">红黑树</a> <a href="/tags/%E7%BB%83%E4%B9%A0/" style="font-size: 10px;">练习</a> <a href="/tags/%E7%BB%A7%E6%89%BF/" style="font-size: 10px;">继承</a> <a href="/tags/%E7%BC%96%E8%AF%91%E5%8A%A0%E8%BD%BD/" style="font-size: 10px;">编译加载</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 10px;">网络</a> <a href="/tags/%E8%99%9A%E6%8B%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">虚拟文件系统</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 10px;">计算机网络</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%B3%95/" style="font-size: 10px;">设计方法</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 11.25px;">设计模式</a> <a href="/tags/%E8%AF%B4%E6%98%8E/" style="font-size: 10px;">说明</a> <a href="/tags/%E8%AF%BA%E8%B4%9D%E5%B0%94%E5%A5%96/" style="font-size: 10px;">诺贝尔奖</a> <a href="/tags/%E8%B0%83%E8%AF%95%E5%99%A8/" style="font-size: 10px;">调试器</a> <a href="/tags/%E8%B4%B9%E6%9B%BC/" style="font-size: 10px;">费曼</a> <a href="/tags/%E8%BD%AF%E8%BF%9E%E6%8E%A5/" style="font-size: 10px;">软连接</a> <a href="/tags/%E8%BF%90%E7%AE%97%E7%AC%A6/" style="font-size: 10px;">运算符</a> <a href="/tags/%E9%87%8D%E8%BD%BD/" style="font-size: 10px;">重载</a> <a href="/tags/%E9%93%BE%E8%A1%A8/" style="font-size: 10px;">链表</a> <a href="/tags/%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">阅读笔记</a> <a href="/tags/%E9%98%9F%E5%88%97/" style="font-size: 10px;">队列</a> <a href="/tags/%E9%9D%99%E6%80%81%E5%A4%9A%E6%80%81/" style="font-size: 10px;">静态多态</a> <a href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" style="font-size: 12.5px;">面向对象</a> <a href="/tags/%E9%9F%B3%E6%A0%87/" style="font-size: 10px;">音标</a> <a href="/tags/%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/" style="font-size: 10px;">顺序容器</a> <a href="/tags/%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/" style="font-size: 13.75px;">驱动程序</a>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <a href="/2020/10/14/%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="软件设计模式">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-10-14T13:38:03.000Z">2020-10-14</time></div>
                    <a href="/2020/10/14/%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="title has-link-black-ter is-size-6 has-text-weight-normal">软件设计模式</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/">软件工程</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/10/05/Linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Linux内存管理">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-10-05T07:05:43.000Z">2020-10-05</time></div>
                    <a href="/2020/10/05/Linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Linux内存管理</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/09/25/C-%E7%B2%BE%E5%BA%A6%E6%8E%A7%E5%88%B6/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="C++精度控制">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-09-25T01:38:32.449Z">2020-09-25</time></div>
                    <a href="/2020/09/25/C-%E7%B2%BE%E5%BA%A6%E6%8E%A7%E5%88%B6/" class="title has-link-black-ter is-size-6 has-text-weight-normal">C++精度控制</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/C/">C++</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/08/17/Linux-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Linux-块设备驱动程序">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-08-17T13:09:35.000Z">2020-08-17</time></div>
                    <a href="/2020/08/17/Linux-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Linux-块设备驱动程序</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/08/16/Linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%B3%A8%E5%86%8C%E3%80%81%E5%AE%89%E8%A3%85%E4%B8%8E%E5%8D%B8%E8%BD%BD/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Linux文件系统注册、安装与卸载">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-08-16T12:11:46.000Z">2020-08-16</time></div>
                    <a href="/2020/08/16/Linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%B3%A8%E5%86%8C%E3%80%81%E5%AE%89%E8%A3%85%E4%B8%8E%E5%8D%B8%E8%BD%BD/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Linux文件系统注册、安装与卸载</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2020/10/">
                <span class="level-start">
                    <span class="level-item">十月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/09/">
                <span class="level-start">
                    <span class="level-item">九月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/08/">
                <span class="level-start">
                    <span class="level-item">八月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/07/">
                <span class="level-start">
                    <span class="level-item">七月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">10</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/06/">
                <span class="level-start">
                    <span class="level-item">六月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">17</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/05/">
                <span class="level-start">
                    <span class="level-item">五月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">23</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/04/">
                <span class="level-start">
                    <span class="level-item">四月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">11</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/03/">
                <span class="level-start">
                    <span class="level-item">三月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/B-%E6%A0%91/">
                        <span class="tag">B+树</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/B-%E6%A0%91/">
                        <span class="tag">B-树</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/C/">
                        <span class="tag">C++</span>
                        <span class="tag is-grey">8</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/C-%E6%A0%87%E5%87%86%E5%BA%93/">
                        <span class="tag">C++标准库</span>
                        <span class="tag is-grey">14</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/HTTP/">
                        <span class="tag">HTTP</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Linux/">
                        <span class="tag">Linux</span>
                        <span class="tag is-grey">20</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Linux%E6%A6%82%E8%BF%B0/">
                        <span class="tag">Linux概述</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/TCP/">
                        <span class="tag">TCP</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/UDP/">
                        <span class="tag">UDP</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/VFS/">
                        <span class="tag">VFS</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/chrome/">
                        <span class="tag">chrome</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/deque/">
                        <span class="tag">deque</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/heap/">
                        <span class="tag">heap</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/hexo/">
                        <span class="tag">hexo</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/leetcode/">
                        <span class="tag">leetcode</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/list/">
                        <span class="tag">list</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/map/">
                        <span class="tag">map</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/module/">
                        <span class="tag">module</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pair/">
                        <span class="tag">pair</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/priority-queue/">
                        <span class="tag">priority_queue</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/queue/">
                        <span class="tag">queue</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/set/">
                        <span class="tag">set</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/stack/">
                        <span class="tag">stack</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/string/">
                        <span class="tag">string</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/vector/">
                        <span class="tag">vector</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E4%BA%92%E6%96%A5%E9%94%81/">
                        <span class="tag">互斥锁</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E4%BA%BA%E7%94%9F/">
                        <span class="tag">人生</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E4%BC%A0%E8%AE%B0/">
                        <span class="tag">传记</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E4%BC%A0%E8%BE%93%E5%B1%82/">
                        <span class="tag">传输层</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E4%BF%A1%E5%8F%B7%E9%87%8F/">
                        <span class="tag">信号量</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/">
                        <span class="tag">关联容器</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E5%88%86%E5%8C%BA/">
                        <span class="tag">内存分区</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/">
                        <span class="tag">内存分配</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">
                        <span class="tag">内存管理</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8/">
                        <span class="tag">内核</span>
                        <span class="tag is-grey">11</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%88%9D%E5%A7%8B%E5%8C%96/">
                        <span class="tag">初始化</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%8A%A8%E6%80%81%E5%A4%9A%E6%80%81/">
                        <span class="tag">动态多态</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/">
                        <span class="tag">单例模式</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%90%8D%E8%91%97/">
                        <span class="tag">名著</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%91%BD%E4%BB%A4/">
                        <span class="tag">命令</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%93%B2%E5%AD%A6/">
                        <span class="tag">哲学</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%9D%97%E8%AE%BE%E5%A4%87/">
                        <span class="tag">块设备</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84/">
                        <span class="tag">基本结构</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%A4%9A%E6%80%81/">
                        <span class="tag">多态</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">
                        <span class="tag">多线程</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">
                        <span class="tag">大数据</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE%E8%AE%A1%E7%AE%97/">
                        <span class="tag">大数据计算</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%A5%97%E6%8E%A5%E5%AD%97/">
                        <span class="tag">套接字</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%AD%A6%E6%9C%AF%E8%AE%BA%E6%96%87/">
                        <span class="tag">学术论文</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%AE%B9%E5%99%A8%E7%B1%BB/">
                        <span class="tag">容器类</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%B0%81%E8%A3%85/">
                        <span class="tag">封装</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%B7%A5%E5%85%B7/">
                        <span class="tag">工具</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%BA%94%E7%94%A8%E5%B1%82/">
                        <span class="tag">应用层</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%BF%83%E6%80%81/">
                        <span class="tag">心态</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/">
                        <span class="tag">性能分析</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%8C%91%E6%88%98/">
                        <span class="tag">挑战</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%8F%92%E4%BB%B6/">
                        <span class="tag">插件</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">
                        <span class="tag">操作系统</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%95%99%E7%A8%8B/">
                        <span class="tag">教程</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%95%A3%E5%88%97%E8%A1%A8/">
                        <span class="tag">散列表</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">
                        <span class="tag">数据结构</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8E%E7%9B%AE%E5%BD%95/">
                        <span class="tag">文件与目录</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">
                        <span class="tag">文件系统</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%96%87%E6%A1%A3%E5%92%8C%E6%B3%A8%E9%87%8A/">
                        <span class="tag">文档和注释</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%A0%88/">
                        <span class="tag">栈</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%A1%B6%E6%8E%92%E5%BA%8F/">
                        <span class="tag">桶排序</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%A6%82%E8%BF%B0/">
                        <span class="tag">概述</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%A8%A1%E5%9D%97/">
                        <span class="tag">模块</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%B5%85%E6%8B%B7%E8%B4%9D/">
                        <span class="tag">浅拷贝</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%B7%B1%E6%8B%B7%E8%B4%9D/">
                        <span class="tag">深拷贝</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%BC%94%E8%AE%B2/">
                        <span class="tag">演讲</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/">
                        <span class="tag">版本控制</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%89%B9%E6%AE%8A%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">
                        <span class="tag">特殊文件系统</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%94%9F%E4%BA%A7%E5%8A%9B/">
                        <span class="tag">生产力</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84/">
                        <span class="tag">目录结构</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%A0%94%E7%A9%B6%E6%96%B9%E6%B3%95%E8%AE%BA/">
                        <span class="tag">研究方法论</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%A1%AC%E8%BF%9E%E6%8E%A5/">
                        <span class="tag">硬连接</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%A8%8B%E5%BA%8F%E6%89%A7%E8%A1%8C/">
                        <span class="tag">程序执行</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%AE%80%E8%BF%B0/">
                        <span class="tag">简述</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%AE%97%E6%B3%95/">
                        <span class="tag">算法</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%BA%A2%E9%BB%91%E6%A0%91/">
                        <span class="tag">红黑树</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%BB%83%E4%B9%A0/">
                        <span class="tag">练习</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%BB%A7%E6%89%BF/">
                        <span class="tag">继承</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%BC%96%E8%AF%91%E5%8A%A0%E8%BD%BD/">
                        <span class="tag">编译加载</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%BD%91%E7%BB%9C/">
                        <span class="tag">网络</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%99%9A%E6%8B%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">
                        <span class="tag">虚拟文件系统</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">
                        <span class="tag">计算机网络</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%B3%95/">
                        <span class="tag">设计方法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">
                        <span class="tag">设计模式</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%AF%B4%E6%98%8E/">
                        <span class="tag">说明</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%AF%BA%E8%B4%9D%E5%B0%94%E5%A5%96/">
                        <span class="tag">诺贝尔奖</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%B0%83%E8%AF%95%E5%99%A8/">
                        <span class="tag">调试器</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%B4%B9%E6%9B%BC/">
                        <span class="tag">费曼</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%BD%AF%E8%BF%9E%E6%8E%A5/">
                        <span class="tag">软连接</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%BF%90%E7%AE%97%E7%AC%A6/">
                        <span class="tag">运算符</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E9%87%8D%E8%BD%BD/">
                        <span class="tag">重载</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E9%93%BE%E8%A1%A8/">
                        <span class="tag">链表</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/">
                        <span class="tag">阅读笔记</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E9%98%9F%E5%88%97/">
                        <span class="tag">队列</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E9%9D%99%E6%80%81%E5%A4%9A%E6%80%81/">
                        <span class="tag">静态多态</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/">
                        <span class="tag">面向对象</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E9%9F%B3%E6%A0%87/">
                        <span class="tag">音标</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/">
                        <span class="tag">顺序容器</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/">
                        <span class="tag">驱动程序</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
        </div>
    
</div>
 -->
               <!--  -->
			   <!-- 下面几行是调整3栏变两栏的代码-->
			     




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                    <figure class="image is-128x128 has-mb-6">
                        <img class="" src="/images/avatar.png" alt="STEMHA">
                    </figure>
                    
                    <p class="is-size-4 is-block">
                        STEMHA
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        student
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>China</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <a href="/archives">
                        <p class="title has-text-weight-normal">
                            74
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <a href="/categories">
                        <p class="title has-text-weight-normal">
                            14
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <a href="/tags">
                        <p class="title has-text-weight-normal">
                            104
                        </p>
                    </a>
                </div>
            </div>
        </nav>
        
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/STEMHA" target="_blank" rel="noopener">
                关注我</a>
        </div>
        
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Github" href="https://github.com/STEMHA">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Facebook" href="https://facebook.com">
                
                <i class="fab fa-facebook"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Twitter" href="https://twitter.com">
                
                <i class="fab fa-twitter"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Dribbble" href="https://dribbble.com">
                
                <i class="fab fa-dribbble"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="RSS" href="/rss.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        

    <div class="card widget" id="toc">
        <div class="card-content">
            <div class="menu">
                <h3 class="menu-label">
                    目录
                </h3>
                <ul class="menu-list"><li>
        <a class="is-flex" href="#概述">
        <span class="has-mr-6">1</span>
        <span>概述</span>
        </a></li><li>
        <a class="is-flex" href="#块设备与字符设备">
        <span class="has-mr-6">2</span>
        <span>块设备与字符设备</span>
        </a></li><li>
        <a class="is-flex" href="#块设备的扇区-内核的块">
        <span class="has-mr-6">3</span>
        <span>块设备的扇区/内核的块</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#扇区">
        <span class="has-mr-6">3.1</span>
        <span>扇区</span>
        </a></li><li>
        <a class="is-flex" href="#块">
        <span class="has-mr-6">3.2</span>
        <span>块</span>
        </a></li><li>
        <a class="is-flex" href="#扇区与块的关系">
        <span class="has-mr-6">3.3</span>
        <span>扇区与块的关系</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#块设备的处理">
        <span class="has-mr-6">4</span>
        <span>块设备的处理</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#块设备内核组件管理数据的方式">
        <span class="has-mr-6">4.1</span>
        <span>块设备内核组件管理数据的方式</span>
        </a></li><li>
        <a class="is-flex" href="#管理数据方式示例">
        <span class="has-mr-6">4.2</span>
        <span>管理数据方式示例</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#段">
        <span class="has-mr-6">5</span>
        <span>段</span>
        </a></li><li>
        <a class="is-flex" href="#缓冲区与缓冲区头">
        <span class="has-mr-6">6</span>
        <span>缓冲区与缓冲区头</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#buffer-head结构体">
        <span class="has-mr-6">6.1</span>
        <span>buffer_head结构体</span>
        </a></li><li>
        <a class="is-flex" href="#块缓冲区头、块缓冲区以及页框的关系">
        <span class="has-mr-6">6.2</span>
        <span>块缓冲区头、块缓冲区以及页框的关系</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#通用块层">
        <span class="has-mr-6">7</span>
        <span>通用块层</span>
        </a></li><li>
        <a class="is-flex" href="#bio结构体">
        <span class="has-mr-6">8</span>
        <span>bio结构体</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#I-O-向量">
        <span class="has-mr-6">8.1</span>
        <span>I/O 向量</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#缓冲区头与bio结构体方法对比">
        <span class="has-mr-6">9</span>
        <span>缓冲区头与bio结构体方法对比</span>
        </a></li><li>
        <a class="is-flex" href="#请求队列">
        <span class="has-mr-6">10</span>
        <span>请求队列</span>
        </a></li><li>
        <a class="is-flex" href="#I-O调度程序-块I-O调度层">
        <span class="has-mr-6">11</span>
        <span>I/O调度程序(块I/O调度层)</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#I-O调度程序的工作">
        <span class="has-mr-6">11.1</span>
        <span>I/O调度程序的工作</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#访问块设备">
        <span class="has-mr-6">12</span>
        <span>访问块设备</span>
        </a></li><li>
        <a class="is-flex" href="#块设备驱动程序的注册">
        <span class="has-mr-6">13</span>
        <span>块设备驱动程序的注册</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#register-blkdev-函数">
        <span class="has-mr-6">13.1</span>
        <span>register_blkdev()函数</span>
        </a></li><li>
        <a class="is-flex" href="#major-names数组">
        <span class="has-mr-6">13.2</span>
        <span>major_names数组</span>
        </a></li><li>
        <a class="is-flex" href="#unregister-blkdev-函数">
        <span class="has-mr-6">13.3</span>
        <span>unregister_blkdev()函数</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#块驱动程序的体系结构">
        <span class="has-mr-6">14</span>
        <span>块驱动程序的体系结构</span>
        </a></li><li>
        <a class="is-flex" href="#块设备基于缓冲区的数据交换">
        <span class="has-mr-6">15</span>
        <span>块设备基于缓冲区的数据交换</span>
        </a></li><li>
        <a class="is-flex" href="#块设备请求">
        <span class="has-mr-6">16</span>
        <span>块设备请求</span>
        </a></li><li>
        <a class="is-flex" href="#块设备驱动程序的几个函数">
        <span class="has-mr-6">17</span>
        <span>块设备驱动程序的几个函数</span>
        </a></li><li>
        <a class="is-flex" href="#Linux中硬盘驱动程序的实现">
        <span class="has-mr-6">18</span>
        <span>Linux中硬盘驱动程序的实现</span>
        </a></li><li>
        <a class="is-flex" href="#重要文件">
        <span class="has-mr-6">19</span>
        <span>重要文件</span>
        </a></li><li>
        <a class="is-flex" href="#参考资料">
        <span class="has-mr-6">20</span>
        <span>参考资料</span>
        </a></li></ul>
            </div>
        </div>
    </div>

    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            链接
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">Hexo</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">hexo.io</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://github.com/ppoffice" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">PPOffice</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">github.com</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://github.com/STEMHA" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">GitHub - STEMHA</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">github.com</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>

    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/C/">
            <span class="level-start">
                <span class="level-item">C++</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">19</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Linux/">
            <span class="level-start">
                <span class="level-item">Linux</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">21</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E5%8D%9A%E5%AE%A2%E7%BB%B4%E6%8A%A4/">
            <span class="level-start">
                <span class="level-item">博客维护</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E5%AD%A6%E6%9C%AF%E8%AE%BA%E6%96%87/">
            <span class="level-start">
                <span class="level-item">学术论文</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">
            <span class="level-start">
                <span class="level-item">操作系统</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E6%95%88%E7%8E%87%E5%B7%A5%E5%85%B7/">
            <span class="level-start">
                <span class="level-item">效率工具</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">
            <span class="level-start">
                <span class="level-item">数据结构</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">5</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E7%AE%97%E6%B3%95/">
            <span class="level-start">
                <span class="level-item">算法</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E8%8B%B1%E8%AF%AD%E5%AD%A6%E4%B9%A0/">
            <span class="level-start">
                <span class="level-item">英语学习</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">
            <span class="level-start">
                <span class="level-item">计算机网络</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">7</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">
            <span class="level-start">
                <span class="level-item">读书笔记</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E8%AF%BE%E5%A4%96%E5%AD%A6%E6%9C%AF%E9%98%85%E8%AF%BB/">
            <span class="level-start">
                <span class="level-item">课外学术阅读</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/">
            <span class="level-start">
                <span class="level-item">软件工程</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E9%86%92%E4%B8%96%E9%80%9A%E8%A8%80/">
            <span class="level-start">
                <span class="level-item">醒世通言</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/B-%E6%A0%91/" style="font-size: 10px;">B+树</a> <a href="/tags/B-%E6%A0%91/" style="font-size: 10px;">B-树</a> <a href="/tags/C/" style="font-size: 16.25px;">C++</a> <a href="/tags/C-%E6%A0%87%E5%87%86%E5%BA%93/" style="font-size: 18.75px;">C++标准库</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/tags/Linux%E6%A6%82%E8%BF%B0/" style="font-size: 10px;">Linux概述</a> <a href="/tags/TCP/" style="font-size: 13.75px;">TCP</a> <a href="/tags/UDP/" style="font-size: 10px;">UDP</a> <a href="/tags/VFS/" style="font-size: 10px;">VFS</a> <a href="/tags/chrome/" style="font-size: 10px;">chrome</a> <a href="/tags/deque/" style="font-size: 10px;">deque</a> <a href="/tags/heap/" style="font-size: 10px;">heap</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/leetcode/" style="font-size: 10px;">leetcode</a> <a href="/tags/list/" style="font-size: 10px;">list</a> <a href="/tags/map/" style="font-size: 10px;">map</a> <a href="/tags/module/" style="font-size: 10px;">module</a> <a href="/tags/pair/" style="font-size: 10px;">pair</a> <a href="/tags/priority-queue/" style="font-size: 10px;">priority_queue</a> <a href="/tags/queue/" style="font-size: 10px;">queue</a> <a href="/tags/set/" style="font-size: 10px;">set</a> <a href="/tags/stack/" style="font-size: 10px;">stack</a> <a href="/tags/string/" style="font-size: 10px;">string</a> <a href="/tags/vector/" style="font-size: 10px;">vector</a> <a href="/tags/%E4%BA%92%E6%96%A5%E9%94%81/" style="font-size: 10px;">互斥锁</a> <a href="/tags/%E4%BA%BA%E7%94%9F/" style="font-size: 10px;">人生</a> <a href="/tags/%E4%BC%A0%E8%AE%B0/" style="font-size: 10px;">传记</a> <a href="/tags/%E4%BC%A0%E8%BE%93%E5%B1%82/" style="font-size: 15px;">传输层</a> <a href="/tags/%E4%BF%A1%E5%8F%B7%E9%87%8F/" style="font-size: 10px;">信号量</a> <a href="/tags/%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/" style="font-size: 10px;">关联容器</a> <a href="/tags/%E5%86%85%E5%AD%98%E5%88%86%E5%8C%BA/" style="font-size: 10px;">内存分区</a> <a href="/tags/%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/" style="font-size: 10px;">内存分配</a> <a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 10px;">内存管理</a> <a href="/tags/%E5%86%85%E6%A0%B8/" style="font-size: 17.5px;">内核</a> <a href="/tags/%E5%88%9D%E5%A7%8B%E5%8C%96/" style="font-size: 10px;">初始化</a> <a href="/tags/%E5%8A%A8%E6%80%81%E5%A4%9A%E6%80%81/" style="font-size: 10px;">动态多态</a> <a href="/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">单例模式</a> <a href="/tags/%E5%90%8D%E8%91%97/" style="font-size: 10px;">名著</a> <a href="/tags/%E5%91%BD%E4%BB%A4/" style="font-size: 11.25px;">命令</a> <a href="/tags/%E5%93%B2%E5%AD%A6/" style="font-size: 10px;">哲学</a> <a href="/tags/%E5%9D%97%E8%AE%BE%E5%A4%87/" style="font-size: 10px;">块设备</a> <a href="/tags/%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84/" style="font-size: 10px;">基本结构</a> <a href="/tags/%E5%A4%9A%E6%80%81/" style="font-size: 10px;">多态</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 10px;">多线程</a> <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="font-size: 10px;">大数据</a> <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE%E8%AE%A1%E7%AE%97/" style="font-size: 10px;">大数据计算</a> <a href="/tags/%E5%A5%97%E6%8E%A5%E5%AD%97/" style="font-size: 10px;">套接字</a> <a href="/tags/%E5%AD%A6%E6%9C%AF%E8%AE%BA%E6%96%87/" style="font-size: 10px;">学术论文</a> <a href="/tags/%E5%AE%B9%E5%99%A8%E7%B1%BB/" style="font-size: 10px;">容器类</a> <a href="/tags/%E5%B0%81%E8%A3%85/" style="font-size: 10px;">封装</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 11.25px;">工具</a> <a href="/tags/%E5%BA%94%E7%94%A8%E5%B1%82/" style="font-size: 10px;">应用层</a> <a href="/tags/%E5%BF%83%E6%80%81/" style="font-size: 10px;">心态</a> <a href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" style="font-size: 11.25px;">性能分析</a> <a href="/tags/%E6%8C%91%E6%88%98/" style="font-size: 10px;">挑战</a> <a href="/tags/%E6%8F%92%E4%BB%B6/" style="font-size: 10px;">插件</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">操作系统</a> <a href="/tags/%E6%95%99%E7%A8%8B/" style="font-size: 10px;">教程</a> <a href="/tags/%E6%95%A3%E5%88%97%E8%A1%A8/" style="font-size: 10px;">散列表</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 12.5px;">数据结构</a> <a href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8E%E7%9B%AE%E5%BD%95/" style="font-size: 10px;">文件与目录</a> <a href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" style="font-size: 11.25px;">文件系统</a> <a href="/tags/%E6%96%87%E6%A1%A3%E5%92%8C%E6%B3%A8%E9%87%8A/" style="font-size: 10px;">文档和注释</a> <a href="/tags/%E6%A0%88/" style="font-size: 10px;">栈</a> <a href="/tags/%E6%A1%B6%E6%8E%92%E5%BA%8F/" style="font-size: 10px;">桶排序</a> <a href="/tags/%E6%A6%82%E8%BF%B0/" style="font-size: 11.25px;">概述</a> <a href="/tags/%E6%A8%A1%E5%9D%97/" style="font-size: 10px;">模块</a> <a href="/tags/%E6%B5%85%E6%8B%B7%E8%B4%9D/" style="font-size: 10px;">浅拷贝</a> <a href="/tags/%E6%B7%B1%E6%8B%B7%E8%B4%9D/" style="font-size: 10px;">深拷贝</a> <a href="/tags/%E6%BC%94%E8%AE%B2/" style="font-size: 10px;">演讲</a> <a href="/tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/" style="font-size: 10px;">版本控制</a> <a href="/tags/%E7%89%B9%E6%AE%8A%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">特殊文件系统</a> <a href="/tags/%E7%94%9F%E4%BA%A7%E5%8A%9B/" style="font-size: 10px;">生产力</a> <a href="/tags/%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84/" style="font-size: 11.25px;">目录结构</a> <a href="/tags/%E7%A0%94%E7%A9%B6%E6%96%B9%E6%B3%95%E8%AE%BA/" style="font-size: 10px;">研究方法论</a> <a href="/tags/%E7%A1%AC%E8%BF%9E%E6%8E%A5/" style="font-size: 10px;">硬连接</a> <a href="/tags/%E7%A8%8B%E5%BA%8F%E6%89%A7%E8%A1%8C/" style="font-size: 10px;">程序执行</a> <a href="/tags/%E7%AE%80%E8%BF%B0/" style="font-size: 10px;">简述</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 13.75px;">算法</a> <a href="/tags/%E7%BA%A2%E9%BB%91%E6%A0%91/" style="font-size: 10px;">红黑树</a> <a href="/tags/%E7%BB%83%E4%B9%A0/" style="font-size: 10px;">练习</a> <a href="/tags/%E7%BB%A7%E6%89%BF/" style="font-size: 10px;">继承</a> <a href="/tags/%E7%BC%96%E8%AF%91%E5%8A%A0%E8%BD%BD/" style="font-size: 10px;">编译加载</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 10px;">网络</a> <a href="/tags/%E8%99%9A%E6%8B%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">虚拟文件系统</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 10px;">计算机网络</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%B3%95/" style="font-size: 10px;">设计方法</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 11.25px;">设计模式</a> <a href="/tags/%E8%AF%B4%E6%98%8E/" style="font-size: 10px;">说明</a> <a href="/tags/%E8%AF%BA%E8%B4%9D%E5%B0%94%E5%A5%96/" style="font-size: 10px;">诺贝尔奖</a> <a href="/tags/%E8%B0%83%E8%AF%95%E5%99%A8/" style="font-size: 10px;">调试器</a> <a href="/tags/%E8%B4%B9%E6%9B%BC/" style="font-size: 10px;">费曼</a> <a href="/tags/%E8%BD%AF%E8%BF%9E%E6%8E%A5/" style="font-size: 10px;">软连接</a> <a href="/tags/%E8%BF%90%E7%AE%97%E7%AC%A6/" style="font-size: 10px;">运算符</a> <a href="/tags/%E9%87%8D%E8%BD%BD/" style="font-size: 10px;">重载</a> <a href="/tags/%E9%93%BE%E8%A1%A8/" style="font-size: 10px;">链表</a> <a href="/tags/%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">阅读笔记</a> <a href="/tags/%E9%98%9F%E5%88%97/" style="font-size: 10px;">队列</a> <a href="/tags/%E9%9D%99%E6%80%81%E5%A4%9A%E6%80%81/" style="font-size: 10px;">静态多态</a> <a href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" style="font-size: 12.5px;">面向对象</a> <a href="/tags/%E9%9F%B3%E6%A0%87/" style="font-size: 10px;">音标</a> <a href="/tags/%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/" style="font-size: 10px;">顺序容器</a> <a href="/tags/%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/" style="font-size: 13.75px;">驱动程序</a>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <a href="/2020/10/14/%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="软件设计模式">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-10-14T13:38:03.000Z">2020-10-14</time></div>
                    <a href="/2020/10/14/%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="title has-link-black-ter is-size-6 has-text-weight-normal">软件设计模式</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/">软件工程</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/10/05/Linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Linux内存管理">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-10-05T07:05:43.000Z">2020-10-05</time></div>
                    <a href="/2020/10/05/Linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Linux内存管理</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/09/25/C-%E7%B2%BE%E5%BA%A6%E6%8E%A7%E5%88%B6/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="C++精度控制">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-09-25T01:38:32.449Z">2020-09-25</time></div>
                    <a href="/2020/09/25/C-%E7%B2%BE%E5%BA%A6%E6%8E%A7%E5%88%B6/" class="title has-link-black-ter is-size-6 has-text-weight-normal">C++精度控制</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/C/">C++</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/08/17/Linux-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Linux-块设备驱动程序">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-08-17T13:09:35.000Z">2020-08-17</time></div>
                    <a href="/2020/08/17/Linux-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Linux-块设备驱动程序</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/08/16/Linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%B3%A8%E5%86%8C%E3%80%81%E5%AE%89%E8%A3%85%E4%B8%8E%E5%8D%B8%E8%BD%BD/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Linux文件系统注册、安装与卸载">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-08-16T12:11:46.000Z">2020-08-16</time></div>
                    <a href="/2020/08/16/Linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%B3%A8%E5%86%8C%E3%80%81%E5%AE%89%E8%A3%85%E4%B8%8E%E5%8D%B8%E8%BD%BD/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Linux文件系统注册、安装与卸载</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2020/10/">
                <span class="level-start">
                    <span class="level-item">十月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/09/">
                <span class="level-start">
                    <span class="level-item">九月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/08/">
                <span class="level-start">
                    <span class="level-item">八月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/07/">
                <span class="level-start">
                    <span class="level-item">七月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">10</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/06/">
                <span class="level-start">
                    <span class="level-item">六月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">17</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/05/">
                <span class="level-start">
                    <span class="level-item">五月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">23</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/04/">
                <span class="level-start">
                    <span class="level-item">四月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">11</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/03/">
                <span class="level-start">
                    <span class="level-item">三月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/B-%E6%A0%91/">
                        <span class="tag">B+树</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/B-%E6%A0%91/">
                        <span class="tag">B-树</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/C/">
                        <span class="tag">C++</span>
                        <span class="tag is-grey">8</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/C-%E6%A0%87%E5%87%86%E5%BA%93/">
                        <span class="tag">C++标准库</span>
                        <span class="tag is-grey">14</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/HTTP/">
                        <span class="tag">HTTP</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Linux/">
                        <span class="tag">Linux</span>
                        <span class="tag is-grey">20</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Linux%E6%A6%82%E8%BF%B0/">
                        <span class="tag">Linux概述</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/TCP/">
                        <span class="tag">TCP</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/UDP/">
                        <span class="tag">UDP</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/VFS/">
                        <span class="tag">VFS</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/chrome/">
                        <span class="tag">chrome</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/deque/">
                        <span class="tag">deque</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/heap/">
                        <span class="tag">heap</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/hexo/">
                        <span class="tag">hexo</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/leetcode/">
                        <span class="tag">leetcode</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/list/">
                        <span class="tag">list</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/map/">
                        <span class="tag">map</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/module/">
                        <span class="tag">module</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/pair/">
                        <span class="tag">pair</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/priority-queue/">
                        <span class="tag">priority_queue</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/queue/">
                        <span class="tag">queue</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/set/">
                        <span class="tag">set</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/stack/">
                        <span class="tag">stack</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/string/">
                        <span class="tag">string</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/vector/">
                        <span class="tag">vector</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E4%BA%92%E6%96%A5%E9%94%81/">
                        <span class="tag">互斥锁</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E4%BA%BA%E7%94%9F/">
                        <span class="tag">人生</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E4%BC%A0%E8%AE%B0/">
                        <span class="tag">传记</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E4%BC%A0%E8%BE%93%E5%B1%82/">
                        <span class="tag">传输层</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E4%BF%A1%E5%8F%B7%E9%87%8F/">
                        <span class="tag">信号量</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/">
                        <span class="tag">关联容器</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E5%88%86%E5%8C%BA/">
                        <span class="tag">内存分区</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/">
                        <span class="tag">内存分配</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">
                        <span class="tag">内存管理</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%86%85%E6%A0%B8/">
                        <span class="tag">内核</span>
                        <span class="tag is-grey">11</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%88%9D%E5%A7%8B%E5%8C%96/">
                        <span class="tag">初始化</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%8A%A8%E6%80%81%E5%A4%9A%E6%80%81/">
                        <span class="tag">动态多态</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/">
                        <span class="tag">单例模式</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%90%8D%E8%91%97/">
                        <span class="tag">名著</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%91%BD%E4%BB%A4/">
                        <span class="tag">命令</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%93%B2%E5%AD%A6/">
                        <span class="tag">哲学</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%9D%97%E8%AE%BE%E5%A4%87/">
                        <span class="tag">块设备</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84/">
                        <span class="tag">基本结构</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%A4%9A%E6%80%81/">
                        <span class="tag">多态</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">
                        <span class="tag">多线程</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">
                        <span class="tag">大数据</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE%E8%AE%A1%E7%AE%97/">
                        <span class="tag">大数据计算</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%A5%97%E6%8E%A5%E5%AD%97/">
                        <span class="tag">套接字</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%AD%A6%E6%9C%AF%E8%AE%BA%E6%96%87/">
                        <span class="tag">学术论文</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%AE%B9%E5%99%A8%E7%B1%BB/">
                        <span class="tag">容器类</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%B0%81%E8%A3%85/">
                        <span class="tag">封装</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%B7%A5%E5%85%B7/">
                        <span class="tag">工具</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%BA%94%E7%94%A8%E5%B1%82/">
                        <span class="tag">应用层</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%BF%83%E6%80%81/">
                        <span class="tag">心态</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/">
                        <span class="tag">性能分析</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%8C%91%E6%88%98/">
                        <span class="tag">挑战</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%8F%92%E4%BB%B6/">
                        <span class="tag">插件</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">
                        <span class="tag">操作系统</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%95%99%E7%A8%8B/">
                        <span class="tag">教程</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%95%A3%E5%88%97%E8%A1%A8/">
                        <span class="tag">散列表</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">
                        <span class="tag">数据结构</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8E%E7%9B%AE%E5%BD%95/">
                        <span class="tag">文件与目录</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">
                        <span class="tag">文件系统</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%96%87%E6%A1%A3%E5%92%8C%E6%B3%A8%E9%87%8A/">
                        <span class="tag">文档和注释</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%A0%88/">
                        <span class="tag">栈</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%A1%B6%E6%8E%92%E5%BA%8F/">
                        <span class="tag">桶排序</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%A6%82%E8%BF%B0/">
                        <span class="tag">概述</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%A8%A1%E5%9D%97/">
                        <span class="tag">模块</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%B5%85%E6%8B%B7%E8%B4%9D/">
                        <span class="tag">浅拷贝</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%B7%B1%E6%8B%B7%E8%B4%9D/">
                        <span class="tag">深拷贝</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%BC%94%E8%AE%B2/">
                        <span class="tag">演讲</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/">
                        <span class="tag">版本控制</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%89%B9%E6%AE%8A%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">
                        <span class="tag">特殊文件系统</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%94%9F%E4%BA%A7%E5%8A%9B/">
                        <span class="tag">生产力</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84/">
                        <span class="tag">目录结构</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%A0%94%E7%A9%B6%E6%96%B9%E6%B3%95%E8%AE%BA/">
                        <span class="tag">研究方法论</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%A1%AC%E8%BF%9E%E6%8E%A5/">
                        <span class="tag">硬连接</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%A8%8B%E5%BA%8F%E6%89%A7%E8%A1%8C/">
                        <span class="tag">程序执行</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%AE%80%E8%BF%B0/">
                        <span class="tag">简述</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%AE%97%E6%B3%95/">
                        <span class="tag">算法</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%BA%A2%E9%BB%91%E6%A0%91/">
                        <span class="tag">红黑树</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%BB%83%E4%B9%A0/">
                        <span class="tag">练习</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%BB%A7%E6%89%BF/">
                        <span class="tag">继承</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%BC%96%E8%AF%91%E5%8A%A0%E8%BD%BD/">
                        <span class="tag">编译加载</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E7%BD%91%E7%BB%9C/">
                        <span class="tag">网络</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%99%9A%E6%8B%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">
                        <span class="tag">虚拟文件系统</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">
                        <span class="tag">计算机网络</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%B3%95/">
                        <span class="tag">设计方法</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">
                        <span class="tag">设计模式</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%AF%B4%E6%98%8E/">
                        <span class="tag">说明</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%AF%BA%E8%B4%9D%E5%B0%94%E5%A5%96/">
                        <span class="tag">诺贝尔奖</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%B0%83%E8%AF%95%E5%99%A8/">
                        <span class="tag">调试器</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%B4%B9%E6%9B%BC/">
                        <span class="tag">费曼</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%BD%AF%E8%BF%9E%E6%8E%A5/">
                        <span class="tag">软连接</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%BF%90%E7%AE%97%E7%AC%A6/">
                        <span class="tag">运算符</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E9%87%8D%E8%BD%BD/">
                        <span class="tag">重载</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E9%93%BE%E8%A1%A8/">
                        <span class="tag">链表</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/">
                        <span class="tag">阅读笔记</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E9%98%9F%E5%88%97/">
                        <span class="tag">队列</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E9%9D%99%E6%80%81%E5%A4%9A%E6%80%81/">
                        <span class="tag">静态多态</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/">
                        <span class="tag">面向对象</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E9%9F%B3%E6%A0%87/">
                        <span class="tag">音标</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/">
                        <span class="tag">顺序容器</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/">
                        <span class="tag">驱动程序</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
        </div>
    
</div>

				 
				 
				  <div class="column is-8-tablet is-8-desktop is-9-widescreen has-order-2 column-main twoLine">
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2020-08-17T13:09:35.000Z">2020-08-17</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Linux/">Linux</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    2 小时 读完 (大约 15981 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                Linux-块设备驱动程序
            
        </h1>
        <div class="content">
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a><strong>概述</strong></h2><blockquote>
<p>Linux块设备处理程序的组织是相当复杂的，在此不可能详细介绍内核块设备I/O子系统中包含的所有函数<br>我们主要说明下面几个问题：</p>
<ul>
<li>Linux块设备I/O子系统的体系结构是什么？</li>
<li>块设备I/O子系统的主要组件有哪些？有哪些作用？</li>
<li>打开一个块设备文件时内核执行的步骤有哪些？</li>
<li>内核如何对块设备和块设备的请求进行管理？-&gt;这部分在内核中称为块I/O层</li>
</ul>
</blockquote>
<a id="more"></a>
<h2 id="块设备与字符设备"><a href="#块设备与字符设备" class="headerlink" title="块设备与字符设备"></a><strong>块设备与字符设备</strong></h2><p><code>块设备</code>:系统中能够随机（不需要按顺序）访问固定大小数据片（chunks）的设备被称作<code>块设备</code>，这些数据片就称作<code>块</code>。</p>
<ul>
<li>最常见的块设备是硬盘，除此以外，还有软盘驱动器、CD-ROM驱动器和闪存等等许多其他块设备。</li>
<li>注意，它们都是以安装文件系统的方式使用的——这也是块设备的一般访问方式。</li>
</ul>
<p><code>字符设备</code>:另一种基本的设备类型是<code>字符设备</code>。</p>
<ul>
<li>字符设备按照字符流的方式被有序访问，像串口和键盘就都属于字符设备。</li>
<li>如果一个硬件设备是以字符流的方式被访问的话，那就应该将它归于字符设备；反过来，如果一个设备是随机（无序的）访问的，那么它就属于块设备。</li>
</ul>
<p>两种类型的设备的根本区别在于它们是否可以被随机访问——也就是能否在访问设备时随意地从一个位置跳转到另一个位置。</p>
<article class="message is-info"><div class="message-header">
<p>为什么要使用专门的内核子系统来进行块设备的管理？对块设备的优化带来什么好处？</p>
</div><div class="message-body">
<p>内核管理块设备要比管理字符设备细致得多，需要考虑的问题和完成的工作相比字符设备来说要复杂许多。这是因为字符设备仅仅需要控制一个位置—当前位置—而块设备访问的位置必须能够在介质的不同区间前后移动。所以事实上内核不必提供一个专门的子系统来管理字符设备，但是对块设备的管理却必须要有一个专门的提供服务的子系统。不仅仅是因为块设备的复杂性远远高于字符设备，<span class="icon has-text-info">  <i class="fas fa-info-circle"></i></span><strong>更重要的原因是块设备对执行性能的要求很高；对硬盘每多一分利用都会对整个系统的性能带来提升，其效果要远远比键盘吞吐速度成倍的提高大得多</strong>。另外，我们将会看到，块设备的复杂性会为这种优化留下很大的施展空间。</p>
</div></article>

<h2 id="块设备的扇区-内核的块"><a href="#块设备的扇区-内核的块" class="headerlink" title="块设备的扇区/内核的块"></a><strong>块设备的扇区/内核的块</strong></h2><h3 id="扇区"><a href="#扇区" class="headerlink" title="扇区"></a><strong>扇区</strong></h3><p><strong>扇区是什么？</strong></p>
<ul>
<li>块设备中最小的可寻址单元是扇区。扇区大小一般是2的整数倍，而最常见的是512字节。</li>
<li>扇区的大小是设备的物理属性<ul>
<li>扇区是所有块设备的基本单元，块设备无法对比它还小的单元进行寻址和操作，不过许多块设备能够一次就传输多个扇区。</li>
<li>虽然大多数块设备的扇区大小都是512字节，不过其它大小的扇区也很常见， 比如，很多CD-ROM盘的扇区都是2K大小。</li>
<li>在Linux中，扇区大小按惯例都设为512字节；如果一个块设备使用更大的扇区，那么相应的底层设备驱动程序将做些必要的变换。</li>
</ul>
</li>
</ul>
<p><strong>为什么提出扇区？扇区的作用是什么？</strong></p>
<ul>
<li>为了达到可接受的性能，硬盘和类似的设备快速传送几个相邻字节的数据（也就是传递多个字节的数据会提高性能）。块设备的每次数据传送操作都作用于一组称为<code>扇区</code>的相邻字节。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </li>
<li>尽管磁盘的物理构造很复杂，但是硬盘控制器接收到的命令将磁盘看成一大组扇区。应该把扇区作为数据传送的基本单元，不允许传送少于一个扇区的数据，大部分磁盘设备都可以同时传送几个相邻的扇区。</li>
<li>对存放在块设备中的一组数据是通过他们在磁盘上的位置来标识，即其首个512字节扇区的下标以及扇区的数目。扇区的下标存放在类型为sector_t的32位或64位的变量中。</li>
</ul>
<h3 id="块"><a href="#块" class="headerlink" title="块"></a><strong>块</strong></h3><p><strong>块：</strong></p>
<ul>
<li>虽然各种软件的用途不同，但是它们都会用到自己的最小逻辑可寻址单元—块。</li>
<li>块是文件系统的一种抽象，只能基于块来访问文件系统。虽然物理磁盘寻址是按照扇区来级进行的，但是内核执行的所有磁盘操作都是按照块进行的。</li>
<li>由于扇区是设备的最小可寻址单元，所以块不能比扇区还小，只能数倍于扇区大小。对有扇区的硬件设备，内核还要求块大小是2的整数倍，且不能超过一个页的长度。</li>
<li>对块大小的要求最终如下：<ul>
<li>必须是扇区大小的2的整数倍，并且要小于页面大小（页框大小），所以通常块大小是512字节，1KB或者4KB</li>
<li>在80X86体系结构中，允许块的大小为512，1024，2048，4096字节。</li>
<li>块设备的块大小不是唯一的，创建一个磁盘文件系统时，管理员可以选择合适的块大小。因此，同一个磁盘上的几个分区可能使用不同的块大小。</li>
<li>此外，对块设备文件的每次读或写操作是一种“原始”访问，因为他绕过了磁盘文件系统；内核通过使用<code>最大的块（4096字节）</code>执行该操作。</li>
</ul>
</li>
</ul>
<p><code>块缓冲区</code>：每个块都需要自己的块缓冲区，它是内核用来存放块内容的RAM空间。</p>
<ul>
<li>当内核从磁盘读出一个块时，就用从硬件设备中所获得的数据来填充相应的缓冲区；同样，当内核向磁盘中写入一个块时，就用相关块缓冲区的数据来更新硬件设备上相应的一组相邻字节。</li>
<li>块缓冲区的大小通常要与相应块的大小相匹配。</li>
<li><code>缓冲区首部</code>是一个与每个缓冲区相关的<code>buffer_head</code>类型的描述符。它包含内核处理缓冲区需要了解的所有信息；因此，在对每个缓冲区进行操作之前，内核都要首先检查其缓冲区首部；因此，在对每个缓冲区进行操作之前，内核都要首先检查其缓冲区首部。</li>
</ul>
<h3 id="扇区与块的关系"><a href="#扇区与块的关系" class="headerlink" title="扇区与块的关系"></a><strong>扇区与块的关系</strong></h3><p>图1是扇区与块之间的关系图：</p>
<center><img src="/2020/08/17/Linux-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/扇区与块之间的关系.gif">  </center>
<center>图1. 扇区与块之间的关系</center>


<p>扇区和块的别称：</p>
<ul>
<li><code>扇区</code>：设备的最小寻址单元，或称为“<code>硬扇区</code>”“<code>设备块</code>”。</li>
<li><code>块</code>：文件系统的最小寻址单元，或称为“<code>文件块</code>”“<code>I/O块</code>”。</li>
</ul>
<p>扇区和块的区别：</p>
<ul>
<li>扇区是硬件设备传送数据的基本单位，而块是VFS和文件系统传送数据的基本单位。</li>
<li>例如：内核访问一个文件的内容时，它必须首先从磁盘上读文件的磁盘索引节点所在的块。该块对应磁盘上一个或多个相邻的扇区，而VFS将其看成是一个单一的数据单元。</li>
</ul>
<blockquote>
<p>扇区这一个概念之所以对内核重要，是因为所有设备的I/O必须以扇区为单位进行操作，内核所使用的“块”这一个高级概念就是建立在扇区之上的。</p>
</blockquote>
<p>深入理解linux</p>
<h2 id="块设备的处理"><a href="#块设备的处理" class="headerlink" title="块设备的处理"></a><strong>块设备的处理</strong></h2><p>在本节我们来说明一下Linux块设备I/O子系统的体系结构。块设备驱动程序上的每个操作都涉及很多内核组件，其中最重要的一些如图2所示：</p>
<center><img src="/2020/08/17/Linux-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/块设备操作涉及的内核组件.gif">  </center>
<center>图2. 块设备操作涉及的内核组件</center>

<p>例如，我们假设一个进程在某个磁盘文件上发出一个read()系统调用（write()系统调用本质上采用同样的方式）。下面是内核对进程请求给予回应的一般步骤：</p>
<ol>
<li>read()系统调用的服务例程调用一个适当的函数，将<code>文件描述符</code>和<code>文件内的偏移量</code>传递给它。虚拟文件系统位于块设备处理体系结构的上层，他提供一个通用的文件模型，Linux支持的所有文件系统均采用该模型。</li>
<li>VFS函数<strong>确定所请求的数据是否存在</strong>，比如文件指针的位置的合法性等，如果有必要的话，它决定如何执行read操作（但均通过具体的文件系统提供的文件操作来执行）。有时候没有必要访问磁盘上的数据，因为内核将大多数最近从块设备读出或写入其中的数据保存在RAM中，及通过<code>磁盘高速缓存</code>来获得数据。</li>
<li>我们假设内核从块设备读数据，那么它就必须<strong>确定数据的物理位置</strong>。为了做到这点，内核依赖<code>映射层（mapping layer）</code>，主要执行下面两步：<br> 3.1. 内核确定该文件所在文件系统的块大小，并根据文件块的大小计算所请求数据的长度。<u>本质上，文件被看作许多数据块的集合</u>，因此内核确定请求数据所在的块号（文件开始位置的块索引）。<br> 3.2. 接下来，映射层调用一个具体文件系统的函数，它访问文件的磁盘索引节点，然后根据逻辑块号确定所请求数据在磁盘上的位置。事实上，磁盘也被看作数据块的数组，因此内核必须确定存放所请求数据的块对应的号（磁盘或分区开始位置的相对索引）。由于一个文件可能存储在磁盘上的不连续块中，因此存放在磁盘索引节点中的数据结构将每个文件块号映射为一个逻辑块号。<br> 3.3. <span class="icon has-text-info">  <i class="fas fa-info-circle"></i></span><strong>如果是从原始设备文件进行读访问，映射层就不调用具体文件系统的方法，而是把块设备文件中的偏移量转换成在磁盘或者在对应该设备文件的磁盘分区中的位置。</strong></li>
<li>现在内核可以<strong>对块设备发出读请求</strong>。内核利用<code>通用块层（generic block layer）</code>启动I/O操作来传送所请求的数据。一般而言，每个I/O操作只针对磁盘上一组连续的块。由于请求的数据不必位于相邻的块中，所以通用块层可能启动几次I/O操作。每次I/O操作是由一个“块I/O”（简称“bio”）结构描述，它收集底层组件需要的所有信息以满足所发出的请求。通用块层为所有的块设备提供了一个抽象视图，因而隐藏了硬件块设备间的差异性。几乎所有的块设备都是磁盘。</li>
<li>通用块层下面的“<code>I/O调度程序</code>”根据预先定义的内核策略将待处理的I/O数据传送请求归类。<strong><code>调度程序的作用</code>是把物理介质上相邻的数据请求聚集在一起。</strong></li>
<li>最后块设备驱动程序向磁盘控制器的硬件接口发送适当的命令，从而进行实际的数据传送。</li>
</ol>
<h3 id="块设备内核组件管理数据的方式"><a href="#块设备内核组件管理数据的方式" class="headerlink" title="块设备内核组件管理数据的方式"></a><strong>块设备内核组件管理数据的方式</strong></h3><p>块设备中的数据存储涉及到了许多内核组件，每个组件采用不同长度的块来管理磁盘数据：</p>
<ul>
<li>硬件块设备控制器采用称为“<code>扇区</code>”的固定长度的块来传送数据。因此，I/O调度程序和块设备驱动程序必须管理数据扇区。</li>
<li>虚拟文件系统、映射层和具体文件系统将磁盘数据存放在成为<code>“块”</code>的逻辑单元中。一个块对应文件系统中一个最小的磁盘存储单元。</li>
<li><code>“段”</code>: 块设备驱动程序应该能够处理数据的<code>“段”</code>。一个段就是一个内存页或内存页的一部分，它们包含磁盘上物理相邻的数据块。</li>
<li><code>磁盘高速缓存</code>作用于磁盘数据的<code>“页”</code>上，每页正好装在一个<code>页框</code>中。</li>
<li><code>通用块层</code>将所有的上层和下层的组件组合在一起，因此它了解数据的<code>扇区、块、段以及页</code>。即使有许多不同的数据块，它们通常也是共享相同的物理RAM单元。</li>
</ul>
<h3 id="管理数据方式示例"><a href="#管理数据方式示例" class="headerlink" title="管理数据方式示例"></a><strong>管理数据方式示例</strong></h3><p>例如，图3显示了一个具有4KB字节的<code>页</code>的构造。上层内核组件将页看成是4个1024字节组成的<code>块缓冲区</code>。块设备驱动程序正在传送页中的后三个<code>块</code>，因此这3块被插入到涵盖了后3072字节的<code>段</code>中。硬盘控制器将该段看成是由6个512字节的<code>扇区</code>组成。</p>
<center><img src="/2020/08/17/Linux-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/包含磁盘数据的页的典型构造.gif">  </center>
<center>图3. 包含磁盘数据的页的典型构造</center>

<h2 id="段"><a href="#段" class="headerlink" title="段"></a><strong>段</strong></h2><blockquote>
<p>磁盘的每个I/O操作的实质是在磁盘与一些RAM单元之间相互传送一些相邻扇区的内容。</p>
</blockquote>
<p>大多数情况下，磁盘控制器直接采用DMA方式进行数据传送。</p>
<ul>
<li>DMA方式的特点是，磁盘控制器就像一个外置CPU一样，块设备驱动程序只要向磁盘控制器发送一些适当的命令就可以触发一次数据传送；一旦完成数据的传送，控制器就会发出一个中断通知块设备驱动程序。</li>
<li>DMA方式传送的是磁盘上相邻扇区的数据。这是一个物理约束：磁盘控制器允许DMA传送不相邻的扇区数据，但是这种方式的传送速率很低，因为在磁盘表面上移动读/写磁头是相当慢的。</li>
</ul>
<p>老式的磁盘控制器仅仅支持“简单的”DMA传送方式：在这种传送方式中，磁盘必须与RAM中的连续内存单元相互传送数据。但是，新的磁盘控制器，也就是我们即将讲到的SCSI磁盘控制器，支持所谓的<code>分散-聚集（scatter-gather）DMA</code>传送方式。此种方式中，磁盘可以与一些非连续的内存区相互传送数据。启动一次分散-聚集DMA传送，块设备驱动程序需要向磁盘控制器发送：</p>
<ol>
<li>要传送的起始磁盘扇区号和总的扇区数（要传的数据位置）</li>
<li>内存区的描述符链表，其中链表的每项包含一个地址和一个长度（需要传送到的位置）</li>
</ol>
<p>磁盘控制器则负责整个数据传送，例如：</p>
<ul>
<li>在读操作中控制器从相邻磁盘扇区中获得数据，然后将它们存放到不同的内存区中。</li>
<li>为了使用分散-聚集DMA传送方式，块设备驱动程序必须能够处理称为<code>段</code>的数据存储元。</li>
<li>一个<code>段</code>就是一个内存页或内存页中的一部分，它们包含一些相邻磁盘扇区中的数据。</li>
<li>因此，一次分散-聚集DMA操作可能同时传送几个段。</li>
</ul>
<p>注意，块设备驱动程序不需要知道块、块大小以及块缓冲区。因此，即使高层将段看成是由几个块缓冲区组成的页，块设备驱动程序也不用对此给予关注。</p>
<p>如果，不同的段在RAM中相应的页框正好是连续的并且在磁盘上相应的数据块也是相邻的，那么通用块层可以合并它们。通过这种合并方式产生的更大的内存区就称为<code>物理段</code>。然而，在多种体系结构上还允许使用另一个合并方式：通过使用一个专门的总线电路来处理总线地址与物理地址间的映射。通过这种合并方式产生的内存区称为<code>硬件段</code>。由于我们将注意力集中在80 x 86体系结构上，它在总线地址和物理地址之间不存在动态的映射，因此在本章剩余部分我们假定硬件段总是对应物理段。</p>
<h2 id="缓冲区与缓冲区头"><a href="#缓冲区与缓冲区头" class="headerlink" title="缓冲区与缓冲区头"></a><strong>缓冲区与缓冲区头</strong></h2><p>当一个块被调入内存时（也就是，在读入后或者等待写出的时候），它要存储在一个缓冲区中。每个缓冲区和一个块对应，它相当于磁盘块在内存中的表示。一个块小于一个页，所以一页可以容纳一个或多个内存中的块。</p>
<p>由于内核在处理数据时需要一些相关的控制信息，每个缓冲区都有一个对应的描述符。该描述符<code>buffer_head结构体</code>表示，被称作<code>缓冲区头</code>，它包含了内核操作缓冲区所需的全部信息：</p>
<h3 id="buffer-head结构体"><a href="#buffer-head结构体" class="headerlink" title="buffer_head结构体"></a><strong>buffer_head结构体</strong></h3><p>buffer_head结构体在<a href="https://github.com/torvalds/linux/blob/v3.10/include/linux/buffer_head.h#L61">include/linux/buffer_head.h</a>中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Historically, a buffer_head was used to map a single block</span></span><br><span class="line"><span class="comment"> * within a page, and of course as the unit of I/O through the</span></span><br><span class="line"><span class="comment"> * filesystem and block layers.  Nowadays the basic I/O unit</span></span><br><span class="line"><span class="comment"> * is the bio, and buffer_heads are used for extracting block</span></span><br><span class="line"><span class="comment"> * mappings (via a get_block_t call), for tracking state within</span></span><br><span class="line"><span class="comment"> * a page (via a page_mapping) and for wrapping bio submission</span></span><br><span class="line"><span class="comment"> * for backward compatibility reasons (e.g. submit_bh).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> b_state;	           <span class="comment">//缓冲区状态标志	/* buffer state bitmap (see above) */ </span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> *<span class="title">b_this_page</span>;</span>   <span class="comment">//页面中的缓冲区   /* circular list of page's buffers */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">b_page</span>;</span>	           <span class="comment">//存储缓冲区的页面	/* the page this bh is mapped to */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">sector_t</span> b_blocknr;		<span class="comment">//起始块号 /* start block number */</span></span><br><span class="line">	<span class="keyword">size_t</span> b_size;			<span class="comment">//映像的大小 /* size of mapping */</span></span><br><span class="line">	<span class="keyword">char</span> *b_data;			<span class="comment">//页面内的数据指针 /* pointer to data within the page */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">block_device</span> *<span class="title">b_bdev</span>;</span>      <span class="comment">//相关联的块设备</span></span><br><span class="line">	<span class="keyword">bh_end_io_t</span> *b_end_io;<span class="comment">//I/O完成方法 /* I/O completion */</span></span><br><span class="line"> 	<span class="keyword">void</span> *b_private;		<span class="comment">/* reserved for b_end_io */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">b_assoc_buffers</span>;</span>   <span class="comment">/*相关的映射链表 associated with another mapping */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">b_assoc_map</span>;</span>	<span class="comment">/*相关的地址空间 mapping this buffer is associated with */</span></span><br><span class="line">	<span class="keyword">atomic_t</span> b_count;		            <span class="comment">/*缓冲区使用计数 users using this buffer_head */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li><p><code>b_count域</code>表示缓冲区的使用记数，可通过两个定义在文件<a href="https://github.com/torvalds/linux/blob/v3.10/include/linux/buffer_head.h#L268">include/linux/buffer_head.h</a>中的内联函数对此域进行增减。</p>
<ul>
<li><figure class="highlight c"><figcaption><span>点击展开对b_count域进行增减的内联函数 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">get_bh</span><span class="params">(struct buffer_head *bh)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        atomic_inc(&amp;bh-&gt;b_count);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">put_bh</span><span class="params">(struct buffer_head *bh)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        smp_mb__before_atomic_dec();</span><br><span class="line">        atomic_dec(&amp;bh-&gt;b_count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>在操作缓冲区头之前，应该先使用get_bh()函数增加缓冲区头的引用计数，确保该缓冲区头不会再被分配出去；当完成对缓冲区头的操作之后，还必须使用put_bh()函数减少引用计数。</li>
</ul>
</li>
<li><p><code>b_blocknr域</code>：与缓冲区对应的磁盘物理块由b_blocknr域索引，该值是b_bdev域指明的块设备中的逻辑块号。</p>
</li>
<li><p>与缓冲区对应的内存物理页由<code>b_page域</code>表示，另外，<code>b_data域</code>直接指向相应的块（它位于b_page域所指明的页面中的某个位置上），块的大小由<code>b_size域</code>表示，所以块在内存中的起始位置在b_data处，结束位置在(b_data + b_size)处。</p>
</li>
<li><p><code>b_state域</code>表示缓冲区状态标志，可以是下表中一种或者多种标志的组合。合法的标志存放在bh_state_bits枚举中，在<a href="https://github.com/torvalds/linux/blob/v3.10/include/linux/buffer_head.h#L19">include/linux/buffer_head.h</a>中定义    </p>
</li>
</ul>
<figure class="highlight c"><figcaption><span>点击展开bh_state_bits枚举列表 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> bh_state_bits &#123;</span><br><span class="line">	BH_Uptodate,	<span class="comment">/* 该缓冲区包含可用数据Contains valid data */</span></span><br><span class="line">	BH_Dirty,	<span class="comment">/* 该缓冲区是脏的，缓冲区的内容比磁盘中的块内容要新，所以缓冲区的内容必须被写回磁盘Is dirty */</span></span><br><span class="line">	BH_Lock,	<span class="comment">/* 该缓冲区正在被I/O操作访问，被锁定以防止并发访问Is locked */</span></span><br><span class="line">	BH_Req,		<span class="comment">/* 该缓冲区有I/O请求操作Has been submitted for I/O */</span></span><br><span class="line">	BH_Uptodate_Lock,<span class="comment">/* Used by the first bh in a page, to serialise</span></span><br><span class="line"><span class="comment">			  * IO completion of other buffers in the page</span></span><br><span class="line"><span class="comment">			  */</span></span><br><span class="line"></span><br><span class="line">	BH_Mapped,	<span class="comment">/* 该缓冲区是映射磁盘块的可用缓冲区Has a disk mapping */</span></span><br><span class="line">	BH_New,		<span class="comment">/* 缓冲区是通过get_block()刚刚映射的，尚且不能访问Disk mapping was newly created by get_block */</span></span><br><span class="line">	BH_Async_Read,	<span class="comment">/*该缓冲区正通过end_buffer_async_read()被异步I/O读操作使用 Is under end_buffer_async_read I/O */</span></span><br><span class="line">	BH_Async_Write,	<span class="comment">/*该缓冲区正通过end_buffer_async_write()被异步写操作使用 Is under end_buffer_async_write I/O */</span></span><br><span class="line">	BH_Delay,	<span class="comment">/* 该缓冲区尚未与磁盘块关联Buffer is not yet allocated on disk */</span></span><br><span class="line">	BH_Boundary,	<span class="comment">/* 该缓冲区片于连续块区的边界，下一个块不再连续 Block is followed by a discontiguity */</span></span><br><span class="line">	BH_Write_EIO,	<span class="comment">/* 该缓冲区在写的时候遇到I/O错误 I/O error on write */</span></span><br><span class="line">	BH_Unwritten,	<span class="comment">/* 该缓冲区在硬盘上的空间已经被申请但是没有实际数据写出Buffer is allocated on disk but not written */</span></span><br><span class="line">	BH_Quiet,	<span class="comment">/* 该缓冲区禁止错误Buffer Error Prinks to be quiet */</span></span><br><span class="line">	BH_Meta,	<span class="comment">/* Buffer contains metadata */</span></span><br><span class="line">	BH_Prio,	<span class="comment">/* Buffer should be submitted with REQ_PRIO */</span></span><br><span class="line"></span><br><span class="line">	BH_PrivateStart,<span class="comment">/* not a state bit, but the first bit available</span></span><br><span class="line"><span class="comment">			 * for private allocation by other entities</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li>BH_PrivateStart：bh_state_bits列表还包含了一个特殊标志——BH_PrivateStart，该标志不是可用状态标志，使用它是为了指明可被其他代码使用的起始位。块I/O层不会使用BH_PrivateStart或更高的位。那么某个驱动程序希望通过b_state域存储信息时就可以安全地使用这些位。驱动程序可以在这些位中定义自己的状态标志，只要保证自定义的状态标志不与块I/O层的专用位发生冲突就可以了。</li>
</ul>
<h3 id="块缓冲区头、块缓冲区以及页框的关系"><a href="#块缓冲区头、块缓冲区以及页框的关系" class="headerlink" title="块缓冲区头、块缓冲区以及页框的关系"></a><strong>块缓冲区头、块缓冲区以及页框的关系</strong></h3><p>每个块缓冲区都对应一个块缓冲区头buffer_head，二者的关系类似于物理页框和物理页框描述符，前者用来存储数据，后者是对前者的属性以及控制信息的描述。<br>块缓冲区头、块缓冲区以及页框的关系如下：</p>
<center><img src="/2020/08/17/Linux-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/块缓冲区头、块缓冲区以及页框的关系.gif">  </center>
<center>图4. 块缓冲区头、块缓冲区以及页框的关系</center>

<p>总结一下:</p>
<ul>
<li>缓冲区:磁盘块在物理内存中的表示形式</li>
<li>缓冲区描述符:对缓冲区的相关信息的描述，描述了缓冲区与磁盘块的映射关系</li>
<li>缓冲区头的目的在于描述磁盘块和物理内存缓冲区（在特定页面上的字节序列）之间的映射关系。这个结构体在内核中只扮演一个描述符的角色，说明从缓冲区到块的映射关系。</li>
</ul>
<h2 id="通用块层"><a href="#通用块层" class="headerlink" title="通用块层"></a><strong>通用块层</strong></h2><p>通用块层是一个内核组件，它处理来自系统中的所有对块设备发出的请求。由于该层所提供的函数，内核可以容易的做到：</p>
<ul>
<li>将数据缓冲区放在高端内存——仅当CPU访问其数据时，才将页框映射为内核中的线性地址空间，并在数据访问完后取消映射。</li>
<li>通过一些附加额手段，实现一个所谓的<code>“零-复制”模式</code>，将磁盘数据直接存放在用户态地址空间而不是首先复制到内核内存区；<ul>
<li>事实上，内核为I/O数据传送使用的缓冲区所在的页框就映射在进程的用户态线性地址空间中。</li>
</ul>
</li>
<li>管理逻辑卷，例如有LVM(逻辑卷管理)和RAID（磁盘冗余阵列）使用的逻辑卷：几个磁盘分区，即使位于不同的磁盘中，也可以被看做是一个单一的分区。</li>
<li>发挥大部分新磁盘控制器的高级特性，例如大主板磁盘高速缓存，增强的DMA性能，I/O传送请求的相关调度等。</li>
</ul>
<p>深入理解linux</p>
<h2 id="bio结构体"><a href="#bio结构体" class="headerlink" title="bio结构体"></a><strong>bio结构体</strong></h2><p>通用块层的核心数据结构是一个称为bio的描述符，它描述了块设备的I/O操作。目前内核中块I/O操作的基本容器由bio结构体表示。在更上层的具体的文件系统的读写操作方法中，构造bio结构，并通过通用块层来提交各块设备驱动程序来进行实际的数据传输。</p>
<p>它定义在文件<a href="https://github.com/torvalds/linux/blob/v3.10/include/linux/blk_types.h#L35">include/linux/blk_types.h</a>中:</p>
<ul>
<li>该结构体代表了正在活动的以<code>段(segment)链表</code>形式组织的块I/O操作。一个段是一小块连续的内存缓冲区。这样,单个缓冲区就不一定要连续。所以<u>使用段来描述缓冲区,即使一个缓冲区分散在内存的多个位置上,bio结构体也能对内核保证I/O操作的执行</u>。这样的向量I/O称为<code>分散-聚合I/O</code>。</li>
<li>每个bio结构都包含一个<code>磁盘存储区表示符</code>（存储区中的起始扇区号和扇区数目）和一个或多个描述与I/O操作相关的内存区的段。</li>
</ul>
<p>bio结构定义如下：</p>
<figure class="highlight c"><figcaption><span>点击展开bio结构体 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* struct bio, bio_vec and BIO_* flags are defined in blk_types.h */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * main unit of I/O for the block layer and lower layers (ie drivers and</span></span><br><span class="line"><span class="comment"> * stacking drivers)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bio</span> &#123;</span></span><br><span class="line">	<span class="keyword">sector_t</span>		bi_sector;	<span class="comment">/* 磁盘上相关的扇区,块I/O操作的第一个扇区 device address in 512 byte sectors */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bio</span>		*<span class="title">bi_next</span>;</span>	<span class="comment">/* 请求链表，链接到请求队列中的下一个bio request queue link */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">block_device</span>	*<span class="title">bi_bdev</span>;</span>	<span class="comment">//指向块设备描述符的指针</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		bi_flags;	<span class="comment">/* 状态和命令标志status, command, etc */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		bi_rw;		<span class="comment">/* 读还是写,I/O操作标志 bottom bits READ/WRITE,</span></span><br><span class="line"><span class="comment">						 * top bits priority</span></span><br><span class="line"><span class="comment">						 */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> short		bi_vcnt;	<span class="comment">/* bio的biovec数组中段的数目，bio_vec的偏移个数 how many bio_vec's */</span></span><br><span class="line">	<span class="keyword">unsigned</span> short		bi_idx;		<span class="comment">/* bio的biovec数组中段的当前索引值 current index into bvl_vec */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Number of segments in this BIO after</span></span><br><span class="line"><span class="comment">	 * physical address coalescing is performed.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		bi_phys_segments; <span class="comment">//合并之后的硬件段数目</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		bi_size;	<span class="comment">/* I/O计数 residual I/O count */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * To keep track of the max segment size, we account for the</span></span><br><span class="line"><span class="comment">	 * sizes of the first and last mergeable segments in this bio.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		bi_seg_front_size; <span class="comment">//第一个可合并段的大小，硬件段合并算法使用</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		bi_seg_back_size;  <span class="comment">//最后一个可合并段的大小，硬件段合并算法使用</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">bio_end_io_t</span>		*bi_end_io;        <span class="comment">//bio的I/O操作结束时调用的方法</span></span><br><span class="line">	<span class="keyword">void</span>			*bi_private;         <span class="comment">//拥有者的私有方法。通用块层和块设备驱动程序的I/O完成方法所使用的指针</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BLK_CGROUP</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Optional ioc and css associated with this bio.  Put on bio</span></span><br><span class="line"><span class="comment">	 * release.  Read comment on top of bio_associate_current().</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">io_context</span>	*<span class="title">bi_ioc</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cgroup_subsys_state</span> *<span class="title">bi_css</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_BLK_DEV_INTEGRITY)</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bio_integrity_payload</span> *<span class="title">bi_integrity</span>;</span>  <span class="comment">/* data integrity */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Everything starting with bi_max_vecs will be preserved by bio_reset()</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		bi_max_vecs;	<span class="comment">/* bio中的bio_vec数组中允许的最大段数 max bvl_vecs we can hold */</span></span><br><span class="line">	<span class="keyword">atomic_t</span>		bi_cnt;		<span class="comment">/* bio的引用计数器 pin count */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bio_vec</span>		*<span class="title">bi_io_vec</span>;</span>	<span class="comment">/* 指向bio中的bio_vec数组中段的指针 the actual vec list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bio_set</span>		*<span class="title">bi_pool</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We can inline a number of vecs at the end of the bio, to avoid</span></span><br><span class="line"><span class="comment">	 * double allocations for a small number of bio_vecs. This member</span></span><br><span class="line"><span class="comment">	 * MUST obviously be kept at the very end of the bio.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bio_vec</span>		<span class="title">bi_inline_vecs</span>[0];</span>  <span class="comment">//内嵌bio向量</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li>bio结构体描述的都只是元数据部分，实际数据都包含在紧跟其后的 <code>bio_vec结构体</code> 中。bio中的每一个段是由bio_vec结构体描述的</li>
<li>bio结构体中的bi_io_vec字段指向bio_vec数据结构的第一个元素，bi_vcnt则存放了bio_vec数据结构数组中当前元素的个数。</li>
<li>bi_private域，这是一个属于拥有者（创建者）的私有域，只有创建了bio结构的拥有者可以读写该域。<br>bio结构体中的主要成员变量都是用来管理I/O操作执行的相关信息的,其中最重要的几个成员变量是<code>bi_io_vec</code>、<code>bi_vcnt</code>和<code>bi_idx</code>。下图显示了bio结构体及相关结构体之间的关系：</li>
</ul>
<center><img src="/2020/08/17/Linux-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/bio结构体及相关结构体之间的关系.PNG">  </center>
<center>图5. bio结构体及bio_vec, bi_vcnt和bi_idx之间的关系</center>


<p>说明：</p>
<ul>
<li>在每个给定的块I/O操作中，bi_vcnt域用来描述bi_io_vec所指向的vio_vec数组中的向量数目。当块I/O操作执行完毕后,bi_idx域指向数组的当前索引。</li>
<li>在块I/O操作期间bio描述符的内容一直保持更新。例如，如果块设备驱动程序在一次分散-聚集DMA操作中不能完成全部的数据传送，那么bio中的bi_idx字段会不断更新来指向待传送的第一个段。为了从索引bi_idx指向的当前段开始不断遍历bio中的段，设备驱动程可以执行宏bio_for_each_segment().</li>
</ul>
<p>当通用块层启动一次新的I/O操作时，调用bio_alloc()函数分配一个新的bio结构。内核使用fs_bio_set结构类型来管理bio结构相关内存分配的缓冲区，这个结构由几个用于引用内存池或slab缓冲的指针组成。<br>fs_bio_set中的一个成员bio_pool用于引用分配bio结构的内存池，而在这个缓冲区中分配的内存块的单位并不是sizeof(struct bio)，而是sizeof(struct bio) + BIO_INLINE_VECS* sizeof(struct bio_vec)个字节。在分配了bio结构之后，通常要为bio分配bio_vec结构，当bio_vec结构数小于BIO_INLINE_VECS时则可以通过bio结构的最后一个成员bi_inline_vecs来引用这些bio_vec结构。</p>
<p>内核同时创建了6个slab缓冲区用于分配数量不等的bio_vec结构，当所需的bio_vec结构数大于BIO_INLINE_VECS，则从这些缓冲区中分配内存。</p>
<h3 id="I-O-向量"><a href="#I-O-向量" class="headerlink" title="I/O 向量"></a><strong>I/O 向量</strong></h3><p><code>bi_io_vec</code>域指向一个<code>bio_vec</code>结构体数组，该结构体链表包含一个特定I/O操作所需要使用的所有片段。</p>
<ul>
<li>每个bio_vec结构都是一个形式为<code>&lt;page, offset, len&gt;的向量</code>，它描述的是一个特定的片段。段所在的物理页、块在物理页中的偏移位置、从给定偏移量开始的块长度。</li>
</ul>
<p>整个bio_vec结构体数组表示一个完整的缓冲区。bio_vec结构定义在<a href="https://github.com/torvalds/linux/blob/v3.10/include/linux/blk_types.h">include/linux/blk_types.h</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * was unsigned short, but we might as well be ready for &gt; 64kB I/O pages</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bio_vec</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span>	*<span class="title">bv_page</span>;</span> <span class="comment">//指向这个缓冲区所驻留的物理页。指向段的页框中页描述符的指针</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>	bv_len; <span class="comment">//这个缓冲区以字节为单位的大小。段的字节长度</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>	bv_offset; <span class="comment">//缓冲区所驻留的页以字节为单位的偏移量，页框中段数据的偏移量。</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>总而言之，每一个块IO请求都通过一个bio结构体表示。</p>
<ul>
<li>每个请求包括一个或多个块，这些块存储在bio_vec结构体数组中。</li>
<li>这些结构体描述了每个片段在物理页中的实际位置，并且像向量一样被组织在一起。</li>
<li>IO操作的第一个片段由bio_io_vecs指针所指向，其他的片段在其后一次防止，共有bi_vcnt个片段。</li>
<li>当块IO层开始执行请求、需要使用各个片段时，bi_idx域会不断更新，指向当前片段。</li>
<li>块IO层通过bi_idx可以跟踪IO操作的完成进度。但该域更重要的作用在于分割bio结构体。</li>
</ul>
<p>bi_cnt域记录bio结构体的使用计数，如果为0就销毁该结构体，并释放内存。通过下面的函数管理使用计数：</p>
<ul>
<li>bio_put()代码在<a href="https://github.com/torvalds/linux/blob/v3.10/fs/bio.c#L487">fs/bio.c</a>：</li>
<li><figure class="highlight c"><figcaption><span>点击展开bio_put()代码 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * bio_put - release a reference to a bio</span></span><br><span class="line"><span class="comment"> * @bio:   bio to release reference to</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Description:</span></span><br><span class="line"><span class="comment"> *   Put a reference to a &amp;struct bio, either one you have gotten with</span></span><br><span class="line"><span class="comment"> *   bio_alloc, bio_get or bio_clone. The last put of a bio will free it.</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bio_put</span><span class="params">(struct bio *bio)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	BIO_BUG_ON(!atomic_read(&amp;bio-&gt;bi_cnt));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * last put frees it</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (atomic_dec_and_test(&amp;bio-&gt;bi_cnt))</span><br><span class="line">		bio_free(bio);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(bio_put);</span><br></pre></td></tr></table></figure></li>
<li>bio_get()代码在<a href="https://github.com/torvalds/linux/blob/v3.10/include/linux/bio.h#L157">include/linux/bio.h</a>：</li>
<li><figure class="highlight c"><figcaption><span>点击展开bio_get()代码 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * get a reference to a bio, so it won't disappear. the intended use is</span></span><br><span class="line"><span class="comment"> * something like:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * bio_get(bio);</span></span><br><span class="line"><span class="comment"> * submit_bio(rw, bio);</span></span><br><span class="line"><span class="comment"> * if (bio-&gt;bi_flags ...)</span></span><br><span class="line"><span class="comment"> *	do_something</span></span><br><span class="line"><span class="comment"> * bio_put(bio);</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * without the bio_get(), it could potentially complete I/O before submit_bio</span></span><br><span class="line"><span class="comment"> * returns. and then bio would be freed memory when if (bio-&gt;bi_flags ...)</span></span><br><span class="line"><span class="comment"> * runs</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> bio_get(bio)	atomic_inc(&amp;(bio)-&gt;bi_cnt)</span></span><br></pre></td></tr></table></figure>
前者增加使用计数，后者减少使用计数（如果为0就销毁该结构体，并释放内存）在操作正在活动的bio结构体时，一定要首先增加它的使用计数，以免在操作过程中该bio结构体被释放。</li>
</ul>
<h2 id="缓冲区头与bio结构体方法对比"><a href="#缓冲区头与bio结构体方法对比" class="headerlink" title="缓冲区头与bio结构体方法对比"></a><strong>缓冲区头与bio结构体方法对比</strong></h2><p>缓冲区头和新的bio结构体之间存在显著差别：</p>
<ul>
<li>bio结构体代表的是I/O操作，它可以包括内存中的一个或多个页。由于bio结构体是轻量级的，它描述的块可以不需要连续的存储区，并且不需要分隔I/O操作。</li>
<li>buffer_head结构体代表的是一个缓冲区，它描述的仅仅是磁盘中的一个块。因为缓冲区头关联的是单独页中的单独磁盘块，所以它可能会引起不必要的分隔，将请求按块为单位划分，只能靠以后再重新组合。</li>
</ul>
<p>利用bio代替buffer_head好处有：</p>
<ul>
<li>不需要连续存储区，也不需要分割I/O操作</li>
<li>bio很容易处理高端内存，因为它处理的是物理页而不是直接指针</li>
<li>bio既可以代表普通页，也可以代表直接I/O</li>
<li>bio便于执行分散——集中(矢量化)块I/O操作，操作中的数据可以来自多个物理页</li>
<li>bio相比缓冲区头属于轻量级结构体。因为它只需要包含块I/O操作所需的信息就行了，不用包含与缓冲区本身相关的不必要信息。</li>
</ul>
<p>但是还是需要缓冲区头这个概念，毕竟它还负责描述磁盘块到页面的映射。<br>bio结构体不包含任何和缓冲区相关的状态信息——它仅仅是一个矢量数组，描述一个或多个单独块I/O操作的数据片段和相关信息。<br>在当前设置中，当bio结构体描述当前正在使用的I/O操作时，buffer_head结构体仍然需要包含缓冲区信息。<br>内核通过这两种结构分别保存各自的信息，可以保证每种结构所含的信息量尽可能少。</p>
<h2 id="请求队列"><a href="#请求队列" class="headerlink" title="请求队列"></a><strong>请求队列</strong></h2><p>块设备将它们挂起的块I/O请求保存在请求队列中，该队列由<code>request_queue结构体</code>表示，定义在文件<a href="https://github.com/torvalds/linux/blob/v3.10/include/linux/blkdev.h#L288">linux/blkdev.h</a>中，包含一个双向请求链表以及相关控制信息。</p>
<figure class="highlight c"><figcaption><span>点击展开request_queue结构体代码 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">request_queue</span> &#123;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Together with queue_head for cacheline sharing</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">queue_head</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">request</span>		*<span class="title">last_merge</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">elevator_queue</span>	*<span class="title">elevator</span>;</span></span><br><span class="line">	<span class="keyword">int</span>			nr_rqs[<span class="number">2</span>];	<span class="comment">/* # allocated [a]sync rqs */</span></span><br><span class="line">	<span class="keyword">int</span>			nr_rqs_elvpriv;	<span class="comment">/* # allocated rqs w/ elvpriv */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If blkcg is not used, @q-&gt;root_rl serves all requests.  If blkcg</span></span><br><span class="line"><span class="comment">	 * is used, root blkg allocates from @q-&gt;root_rl and all other</span></span><br><span class="line"><span class="comment">	 * blkgs from their own blkg-&gt;rl.  Which one to use should be</span></span><br><span class="line"><span class="comment">	 * determined using bio_request_list().</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">request_list</span>	<span class="title">root_rl</span>;</span></span><br><span class="line"></span><br><span class="line">	request_fn_proc		*request_fn;</span><br><span class="line">	make_request_fn		*make_request_fn;</span><br><span class="line">	prep_rq_fn		*prep_rq_fn;</span><br><span class="line">	unprep_rq_fn		*unprep_rq_fn;</span><br><span class="line">	merge_bvec_fn		*merge_bvec_fn;</span><br><span class="line">	softirq_done_fn		*softirq_done_fn;</span><br><span class="line">	rq_timed_out_fn		*rq_timed_out_fn;</span><br><span class="line">	dma_drain_needed_fn	*dma_drain_needed;</span><br><span class="line">	lld_busy_fn		*lld_busy_fn;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Dispatch queue sorting</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">sector_t</span>		end_sector;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">request</span>		*<span class="title">boundary_rq</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Delayed queue handling</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">delayed_work</span>	<span class="title">delay_work</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">backing_dev_info</span>	<span class="title">backing_dev_info</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The queue owner gets to use this for whatever they like.</span></span><br><span class="line"><span class="comment">	 * ll_rw_blk doesn't touch it.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span>			*queuedata;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * various queue flags, see QUEUE_* below</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		queue_flags;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * ida allocated id for this queue.  Used to index queues from</span></span><br><span class="line"><span class="comment">	 * ioctx.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span>			id;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * queue needs bounce pages for pages above this limit</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">gfp_t</span>			bounce_gfp;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * protects queue structures from reentrancy. -&gt;__queue_lock should</span></span><br><span class="line"><span class="comment">	 * _never_ be used directly, it is queue private. always use</span></span><br><span class="line"><span class="comment">	 * -&gt;queue_lock.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">spinlock_t</span>		__queue_lock;</span><br><span class="line">	<span class="keyword">spinlock_t</span>		*queue_lock;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * queue kobject</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PM_RUNTIME</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span>		*<span class="title">dev</span>;</span></span><br><span class="line">	<span class="keyword">int</span>			rpm_status;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		nr_pending;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * queue settings</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		nr_requests;	<span class="comment">/* Max # of requests */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		nr_congestion_on;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		nr_congestion_off;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		nr_batching;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		dma_drain_size;</span><br><span class="line">	<span class="keyword">void</span>			*dma_drain_buffer;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		dma_pad_mask;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		dma_alignment;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">blk_queue_tag</span>	*<span class="title">queue_tags</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">tag_busy_list</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		nr_sorted;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		in_flight[<span class="number">2</span>];</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Number of active block driver functions for which blk_drain_queue()</span></span><br><span class="line"><span class="comment">	 * must wait. Must be incremented around functions that unlock the</span></span><br><span class="line"><span class="comment">	 * queue_lock internally, e.g. scsi_request_fn().</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		request_fn_active;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		rq_timeout;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span>	<span class="title">timeout</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">timeout_list</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">icq_list</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BLK_CGROUP</span></span><br><span class="line">	DECLARE_BITMAP		(blkcg_pols, BLKCG_MAX_POLS);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">blkcg_gq</span>		*<span class="title">root_blkg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">blkg_list</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">queue_limits</span>	<span class="title">limits</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * sg stuff</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		sg_timeout;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		sg_reserved_size;</span><br><span class="line">	<span class="keyword">int</span>			node;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BLK_DEV_IO_TRACE</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">blk_trace</span>	*<span class="title">blk_trace</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * for flush operations</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		flush_flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		flush_not_queueable:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		flush_queue_delayed:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		flush_pending_idx:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		flush_running_idx:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		flush_pending_since;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">flush_queue</span>[2];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">flush_data_in_flight</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">request</span>		<span class="title">flush_rq</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>		<span class="title">sysfs_lock</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>			bypass_depth;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_BLK_DEV_BSG)</span></span><br><span class="line">	bsg_job_fn		*bsg_job_fn;</span><br><span class="line">	<span class="keyword">int</span>			bsg_job_size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bsg_class_device</span> <span class="title">bsg_dev</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BLK_CGROUP</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">all_q_node</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BLK_DEV_THROTTLING</span></span><br><span class="line">	<span class="comment">/* Throttle data */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">throtl_data</span> *<span class="title">td</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>		<span class="title">rcu_head</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>通过内核中像文件系统这样的高层的代码将请求加入到队列中。请求队列只要不为空，队列对应的块设备驱动程序就会从队列头获取请求，然后将其送入对应的块设备上去。</p>
<ul>
<li>请求队列表中的每一项都是一个单独的请求，由<code>request结构体</code>表示。</li>
<li>队列中的请求由结构体request表示，因为一个请求可能要操作多个连续的磁盘块，所以每个请求可以由多个bio结构体组成。</li>
<li>注意，虽然磁盘上的块必须连续，但是在内存中这些块并不一定要连续_每个bio结构体都可以描述多个段（段是内存中的连续的小区域），而每个请求也可以包含多个bio结构体。</li>
</ul>
<h2 id="I-O调度程序-块I-O调度层"><a href="#I-O调度程序-块I-O调度层" class="headerlink" title="I/O调度程序(块I/O调度层)"></a><strong>I/O调度程序(块I/O调度层)</strong></h2><p>如果简单地以内核产生的请求的次序直接将请求发向块设备的话，性能会很差。磁盘寻址是整个计算机中最慢的操作之一，每次寻址（定位磁盘磁头到特定块上的某个位置）需要花费不少时间，所以尽量缩短寻址时间无疑提高系统性能。</p>
<p>为了优化寻址操作，内核既不会简单地按请求接受次序，也不会立即将其提交给磁盘。相反，它会在提交前，先执行名为<code>合并排序</code>的<strong>预操作</strong>，这种预操作可以极大地提高系统的整体性能。</p>
<p>在内核中<code>负责提交I/O请求的子系统</code>称为<code>I/O调度程序</code>:</p>
<ul>
<li>I/O调度程序将磁盘I/O资源分配给系统中所有挂起的块I/O请求。这种资源分配是通过将请求队列中挂起的<code>请求合并和排序</code>来完成的。</li>
</ul>
<p>进程调度程序与I/O调度程序的共同点与区别：</p>
<ul>
<li>二者都是将一个资源虚拟给多个对象</li>
<li>进程调度程序的作用是将处理器资源分配给系统中的运行进程。处理器被进程调度程序虚拟给系统中的运行进程共享。</li>
<li>I/O调度程序虚拟块设备给多个磁盘请求，以便降低磁盘寻址时间，确保磁盘性能地最优化。</li>
</ul>
<h3 id="I-O调度程序的工作"><a href="#I-O调度程序的工作" class="headerlink" title="I/O调度程序的工作"></a><strong>I/O调度程序的工作</strong></h3><p>I/O调度程序的工作是管理块设备的请求队列。</p>
<ul>
<li>它决定队列中的请求排列顺序以及在什么时候派发请求到块设备。这样做有利于减少磁盘寻址时间，从而提高全局吞吐量。</li>
<li><strong>I/O调度器提高的是系统整体性能，对个别请求可能不公平。</strong></li>
</ul>
<p>I/O调度程序通过两种方法减少磁盘寻址时间：合并与排序。</p>
<ul>
<li>合并：指将两个或多个请求结合成一个请求。通过合并请求，I/O调度程序将多次请求的开销压缩成一次请求的开销。更重要的是，请求合并后只需要传递给磁盘一条寻址命令，就可以访问到请求合并前必须多次寻址才能访问完的磁盘区域了，因此合并请求显然能减少系统开销和磁盘寻址次数。<ul>
<li>比如文件系统提交请求到请求队列——请求是从文件中读取一个数据区。（当然，最终所有的操作都是针对扇区和块进行的，而不是文件，还假定请求的块都是来自文件块）。如果这时队列中已经存在一个请求，它访问的磁盘扇区和当前请求访问的磁盘扇区相邻（比如，同一个文件中早些时候被读取的数据区），那么这两个请求就可以合并为一个对单个和多个相邻磁盘扇区操作的新请求。</li>
</ul>
</li>
<li>排序：如果存在一个请求，它要操作的磁盘扇区位置与当前请求比较接近，那么是不是该让这两个请求在请求队列上也相邻呢？事实上，I/O调度程序的确是这样处理上述情况的，整个请求队列将按扇区增长方向有序排列。使所有请求按硬盘上扇区的排列顺序有序排列（尽可能的）的目的不仅是为了缩短单独一次请求的寻址时间，更重要的优化在于，通过保持磁盘头以直线方向移动，缩短了所有请求的磁盘寻址时间。该排序算法类似于电梯调度（A–&gt;B…..A—&gt;B）。</li>
</ul>
<hr>
<h2 id="访问块设备"><a href="#访问块设备" class="headerlink" title="访问块设备"></a>访问块设备</h2><p>字符设备的实现比较简单，内核例程和用户态API一一对应，这种映射关系由字符设备的file_operations维护。块设备接口则相对复杂，读写API没有直接到块设备层，而是直接到文件系统层，然后再由文件系统层发起读写请求。<br>对于块设备来说，读写操作是以数据块为单位进行的，为了使高速的 CPU 同低速块设备能够协调工作，提高读写效率，操作系统设置了缓冲机制。当进行读写的时候，首先对缓冲区读写，只有缓冲区中没有需要读的数据或是需要写的数据没有地方写时，才真正地启动设备控制器去控制设备本身进行数据交换，而对于设备本身的数据交换同样也是同缓冲区打交道。</p>
<h2 id="块设备驱动程序的注册"><a href="#块设备驱动程序的注册" class="headerlink" title="块设备驱动程序的注册"></a><strong>块设备驱动程序的注册</strong></h2><h3 id="register-blkdev-函数"><a href="#register-blkdev-函数" class="headerlink" title="register_blkdev()函数"></a><strong>register_blkdev()函数</strong></h3><p>块设备驱动中的第1个工作通常是注册它们自己到内核，申请设备号，完成这个任务的函数是<code>register_blkdev()</code>,代码在<a href="https://github.com/torvalds/linux/blob/v3.10/block/genhd.c#L285">/block/genhd.c</a></p>
<figure class="highlight c"><figcaption><span>点击展开register_blkdev()函数代码 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * register_blkdev - register a new block device</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @major: the requested major device number [1..255]. If @major=0, try to</span></span><br><span class="line"><span class="comment"> *         allocate any unused major number.</span></span><br><span class="line"><span class="comment"> * @name: the name of the new block device as a zero terminated string</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The @name must be unique within the system.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The return value depends on the @major input parameter.</span></span><br><span class="line"><span class="comment"> *  - if a major device number was requested in range [1..255] then the</span></span><br><span class="line"><span class="comment"> *    function returns zero on success, or a negative error code</span></span><br><span class="line"><span class="comment"> *  - if any unused major number was requested with @major=0 parameter</span></span><br><span class="line"><span class="comment"> *    then the return value is the allocated major number in range</span></span><br><span class="line"><span class="comment"> *    [1..255] or a negative error code otherwise</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_blkdev</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> major, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;   <span class="comment">//传入的参数是要注册的主设备号和设备名称  </span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">blk_major_name</span> **<span class="title">n</span>, *<span class="title">p</span>;</span></span><br><span class="line">	<span class="keyword">int</span> index, ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	mutex_lock(&amp;block_class_lock);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* temporary */</span></span><br><span class="line">	<span class="comment">//检查传入的主设备号是否为0，如果为0怎么办？  </span></span><br><span class="line">    <span class="comment">//如果为0的话内核会自动去major_name这个指针数组中为你分配一个主设备号</span></span><br><span class="line">    <span class="comment">//如果已经没有空闲的设备号的话，就会返回一个错误  </span></span><br><span class="line">	<span class="keyword">if</span> (major == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">for</span> (index = ARRAY_SIZE(major_names)<span class="number">-1</span>; index &gt; <span class="number">0</span>; index--) &#123;</span><br><span class="line">			<span class="keyword">if</span> (major_names[index] == <span class="literal">NULL</span>)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">			printk(<span class="string">"register_blkdev: failed to get major for %s\n"</span>,</span><br><span class="line">			       name);</span><br><span class="line">			ret = -EBUSY;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">		major = index;</span><br><span class="line">		ret = major;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//如果主设备号不为0 ，我们就可以申请一个struct blk_major_name的结构体，并将它初始化，主要是将设备号和设备名称存储到这个结构体中  </span></span><br><span class="line">	p = kmalloc(<span class="keyword">sizeof</span>(struct blk_major_name), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		ret = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	p-&gt;major = major;</span><br><span class="line">	strlcpy(p-&gt;name, name, <span class="keyword">sizeof</span>(p-&gt;name));</span><br><span class="line">	p-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">	index = major_to_index(major);</span><br><span class="line">	<span class="comment">//这个函数是做模运算用来得到一个索引值(0-255)，也许你要问了，如果我的主设备号大于255，是不是会将major_names指针数组中的元素覆盖掉？  </span></span><br><span class="line">    <span class="comment">//看看下面的for循环就明白了。假定主设备号是288，那么index = 288%255，就是33</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//内核首先拿到索引值为33的元素，用*n判断此元素是否为空，如果为空，直接跳出for循环，将上面开辟的结构体赋值给*n好了，这样就将设备的信息注册到了全局数组中去了  </span></span><br><span class="line">  <span class="comment">//如果此元素不为空，也就是已经有一个设备注册到这了，怎么办?那内核就会去比较已经注册的主设备号与我们将要注册的主设备号是否一致，如果一致，内核就会提示我们该设备号已经被占用了。</span></span><br><span class="line">  <span class="comment">//如果不一致呢？有一个next指针，这个指针是指向下一个设备的结构体，直到找到一个空的结构体，并将前面申请的结构体进行赋值。</span></span><br><span class="line">	<span class="keyword">for</span> (n = &amp;major_names[index]; *n; n = &amp;(*n)-&gt;next) &#123;</span><br><span class="line">		<span class="keyword">if</span> ((*n)-&gt;major == major)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!*n)</span><br><span class="line">		*n = p;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		ret = -EBUSY;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">"register_blkdev: cannot get major %d for %s\n"</span>,</span><br><span class="line">		       major, name);</span><br><span class="line">		kfree(p);</span><br><span class="line">	&#125;</span><br><span class="line">out:</span><br><span class="line">	mutex_unlock(&amp;block_class_lock);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EXPORT_SYMBOL(register_blkdev);</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li>major参数是块设备要使用的主设备号，name为设备名，它会显示在<code>/proc/devices</code>中。如果major为0，内核会自动分配一个新的主设备号，register_blkdev()函数的返回值就是这个主设备号。</li>
<li>如果register_blkdev()返回一个负值，表明发生了一个错误。</li>
<li><code>/proc/devices</code>是一个文件，这个文件列出字符和块设备的主设备号，以及分配到这些设备号的设备名称。示例如下：</li>
<li><figure class="highlight c"><figcaption><span>点击展开/proc/devices示例 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="meta"># cat /proc/devices </span></span><br><span class="line">Character devices:</span><br><span class="line">  <span class="number">1</span> mem</span><br><span class="line">  <span class="number">4</span> /dev/vc/<span class="number">0</span></span><br><span class="line">  <span class="number">4</span> tty</span><br><span class="line">  <span class="number">4</span> ttyS</span><br><span class="line">  <span class="number">5</span> /dev/tty</span><br><span class="line">  <span class="number">5</span> /dev/console</span><br><span class="line">  <span class="number">5</span> /dev/ptmx</span><br><span class="line">  <span class="number">7</span> vcs</span><br><span class="line"> <span class="number">10</span> misc</span><br><span class="line"> <span class="number">13</span> input</span><br><span class="line"> <span class="number">21</span> sg</span><br><span class="line"> <span class="number">29</span> fb</span><br><span class="line"><span class="number">128</span> ptm</span><br><span class="line"><span class="number">136</span> pts</span><br><span class="line"><span class="number">162</span> raw</span><br><span class="line"><span class="number">180</span> usb</span><br><span class="line"><span class="number">188</span> ttyUSB</span><br><span class="line"><span class="number">189</span> usb_device</span><br><span class="line"><span class="number">202</span> cpu/msr</span><br><span class="line"><span class="number">203</span> cpu/cpuid</span><br><span class="line"><span class="number">226</span> drm</span><br><span class="line"><span class="number">231</span> infiniband_mad</span><br><span class="line"><span class="number">231</span> infiniband_verbs</span><br><span class="line"><span class="number">231</span> infiniband_cm</span><br><span class="line"><span class="number">235</span> infiniband_cm</span><br><span class="line"><span class="number">236</span> infiniband_mad</span><br><span class="line"><span class="number">237</span> mlx5_fpga_tools</span><br><span class="line"><span class="number">238</span> mei</span><br><span class="line"><span class="number">239</span> ipmidev</span><br><span class="line"><span class="number">240</span> infiniband_verbs</span><br><span class="line"><span class="number">241</span> aux</span><br><span class="line"><span class="number">242</span> nvme</span><br><span class="line"><span class="number">243</span> megaraid_sas_ioctl</span><br><span class="line"><span class="number">244</span> ptp</span><br><span class="line"><span class="number">245</span> pps</span><br><span class="line"><span class="number">246</span> hidraw</span><br><span class="line"><span class="number">247</span> usbmon</span><br><span class="line"><span class="number">248</span> bsg</span><br><span class="line"><span class="number">249</span> hmm_device</span><br><span class="line"><span class="number">250</span> watchdog</span><br><span class="line"><span class="number">251</span> iio</span><br><span class="line"><span class="number">252</span> rtc</span><br><span class="line"><span class="number">253</span> dax</span><br><span class="line"><span class="number">254</span> tpm</span><br><span class="line"></span><br><span class="line">Block devices:</span><br><span class="line"><span class="number">259</span> blkext</span><br><span class="line">  <span class="number">8</span> sd</span><br><span class="line">  <span class="number">9</span> md</span><br><span class="line"> <span class="number">11</span> sr</span><br><span class="line"> <span class="number">65</span> sd</span><br><span class="line"> <span class="number">66</span> sd</span><br><span class="line"> <span class="number">67</span> sd</span><br><span class="line"> <span class="number">68</span> sd</span><br><span class="line"> <span class="number">69</span> sd</span><br><span class="line"> <span class="number">70</span> sd</span><br><span class="line"> <span class="number">71</span> sd</span><br><span class="line"><span class="number">128</span> sd</span><br><span class="line"><span class="number">129</span> sd</span><br><span class="line"><span class="number">130</span> sd</span><br><span class="line"><span class="number">131</span> sd</span><br><span class="line"><span class="number">132</span> sd</span><br><span class="line"><span class="number">133</span> sd</span><br><span class="line"><span class="number">134</span> sd</span><br><span class="line"><span class="number">135</span> sd</span><br><span class="line"><span class="number">254</span> mdp</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="major-names数组"><a href="#major-names数组" class="headerlink" title="major_names数组"></a><strong>major_names数组</strong></h3><p>代码在<a href="https://github.com/torvalds/linux/blob/v3.10/block/genhd.c#L243">block/genhd.c</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">blk_major_name</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">blk_major_name</span> *<span class="title">next</span>;</span></span><br><span class="line">	<span class="keyword">int</span> major;</span><br><span class="line">	<span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">&#125; *major_names[BLKDEV_MAJOR_HASH_SIZE];</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li>BLKDEV_MAJOR_HASH_SIZE = 255</li>
<li>这是一个指针数组，其中的每一个元素都指向了一个struct blk_major_name的结构体</li>
<li>struct blk_major_name结构体就是用来存放设备的主设备号和设备名称的</li>
<li>更加详细的解释看参考文献。</li>
</ul>
<h3 id="unregister-blkdev-函数"><a href="#unregister-blkdev-函数" class="headerlink" title="unregister_blkdev()函数"></a><strong>unregister_blkdev()函数</strong></h3><p><code>unregister_blkdev()</code>代码在<a href="https://github.com/torvalds/linux/blob/v3.10/block/genhd.c#L341">/block/genhd.c</a></p>
<figure class="highlight c"><figcaption><span>点击展开unregister_blkdev()函数代码 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unregister_blkdev</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> major, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">blk_major_name</span> **<span class="title">n</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">blk_major_name</span> *<span class="title">p</span> = <span class="title">NULL</span>;</span></span><br><span class="line">	<span class="keyword">int</span> index = major_to_index(major);</span><br><span class="line"></span><br><span class="line">	mutex_lock(&amp;block_class_lock);</span><br><span class="line">	<span class="keyword">for</span> (n = &amp;major_names[index]; *n; n = &amp;(*n)-&gt;next)</span><br><span class="line">		<span class="keyword">if</span> ((*n)-&gt;major == major)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">if</span> (!*n || <span class="built_in">strcmp</span>((*n)-&gt;name, name)) &#123;</span><br><span class="line">		WARN_ON(<span class="number">1</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		p = *n;</span><br><span class="line">		*n = p-&gt;next;</span><br><span class="line">	&#125;</span><br><span class="line">	mutex_unlock(&amp;block_class_lock);</span><br><span class="line">	kfree(p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EXPORT_SYMBOL(unregister_blkdev);</span><br></pre></td></tr></table></figure>
<p>说明：传递给register_blkdev()的参数必须与传递给unregister_blkdev()的参数匹配，否则这个函数返回-EINVAL。</p>
<p>两个函数的声明代码在<a href="https://github.com/torvalds/linux/blob/v3.10/include/linux/fs.h#L2046">include/linux/fs.h</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">register_blkdev</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">const</span> <span class="keyword">char</span> *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">unregister_blkdev</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">const</span> <span class="keyword">char</span> *)</span></span>;</span><br></pre></td></tr></table></figure>





<p>每种具体的块设备都有一套具体的操作，因而各自有一个类似于file_operations 那样的数据结构，称为block_device_operations 结构。它是对块设备操作的集合，其定义为,代码在<a href="https://github.com/torvalds/linux/blob/v3.10/include/linux/blkdev.h#L288">include/linux/blkdev.h</a>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">block_device_operations</span> &#123;</span></span><br><span class="line">	<span class="comment">//打开和释放</span></span><br><span class="line">	<span class="keyword">int</span> (*<span class="built_in">open</span>) (struct block_device *, <span class="keyword">fmode_t</span>);</span><br><span class="line">	<span class="keyword">void</span> (*<span class="built_in">release</span>) (struct gendisk *, <span class="keyword">fmode_t</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//I/O控制</span></span><br><span class="line">	<span class="keyword">int</span> (*ioctl) (struct block_device *, <span class="keyword">fmode_t</span>, <span class="keyword">unsigned</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>);</span><br><span class="line">	<span class="keyword">int</span> (*compat_ioctl) (struct block_device *, <span class="keyword">fmode_t</span>, <span class="keyword">unsigned</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> (*direct_access) (struct block_device *, <span class="keyword">sector_t</span>,</span><br><span class="line">						<span class="keyword">void</span> **, <span class="keyword">unsigned</span> <span class="keyword">long</span> *);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//介质改变</span></span><br><span class="line">	<span class="function"><span class="keyword">unsigned</span> <span class="title">int</span> <span class="params">(*check_events)</span> <span class="params">(struct gendisk *disk,</span></span></span><br><span class="line"><span class="function"><span class="params">				      <span class="keyword">unsigned</span> <span class="keyword">int</span> clearing)</span></span>;</span><br><span class="line">	<span class="comment">/* -&gt;media_changed() is DEPRECATED, use -&gt;check_events() instead */</span></span><br><span class="line">	<span class="keyword">int</span> (*media_changed) (struct gendisk *);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">void</span> (*unlock_native_capacity) (struct gendisk *);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//使介质有效</span></span><br><span class="line">	<span class="keyword">int</span> (*revalidate_disk) (struct gendisk *);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//获得驱动器信息</span></span><br><span class="line">	<span class="keyword">int</span> (*getgeo)(struct block_device *, struct hd_geometry *);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* this callback is with swap_lock and sometimes page table lock held */</span></span><br><span class="line">	<span class="keyword">void</span> (*swap_slot_free_notify) (struct block_device *, <span class="keyword">unsigned</span> <span class="keyword">long</span>);、</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//模块指针，一个指向拥有这个结构体的模块的指针，它通常被初始化为THIS_MODULE</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果说<strong>file_operation 结构</strong>是连接虚拟的VFS 文件的操作与具体文件系统的文件操作之间的枢纽，那么<strong>block_device_operations</strong>就是连接抽象的块设备操作与具体块设备操作之间的枢纽。</p>
</blockquote>
<p>具体的块设备是由主设备号唯一确定的，因此，主设备号唯一地确定了一个具体的<code>block_device_operations 数据结构</code>。</p>
<p>那么，块设备注册到系统以后，怎样与文件系统联系起来呢，也就是说，文件系统怎么调用已注册的块设备，这还得从file_operations 结构说起。</p>
<p>先来看一下块设备的file_operations 结构的定义，变量名为<code>def_blk_fops</code>，其位于<a href="https://github.com/torvalds/linux/blob/v3.10/fs/block_dev.c#L1588">fs/block_dev.c</a>中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">def_blk_fops</span> = &#123;</span></span><br><span class="line">	.<span class="built_in">open</span>		= blkdev_open,</span><br><span class="line">	.<span class="built_in">release</span>	= blkdev_close,</span><br><span class="line">	.llseek		= block_llseek,</span><br><span class="line">	.<span class="built_in">read</span>		= do_sync_read,</span><br><span class="line">	.<span class="built_in">write</span>		= do_sync_write,</span><br><span class="line">	.aio_read	= blkdev_aio_read,</span><br><span class="line">	.aio_write	= blkdev_aio_write,</span><br><span class="line">	.mmap		= generic_file_mmap,</span><br><span class="line">	.fsync		= blkdev_fsync,</span><br><span class="line">	.unlocked_ioctl	= block_ioctl,</span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">	.compat_ioctl	= compat_blkdev_ioctl,</span><br><span class="line">#endif</span><br><span class="line">	.splice_read	= generic_file_splice_read,</span><br><span class="line">	.splice_write	= generic_file_splice_write,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>以open()系统调用为例，说明用户进程中的一个系统调用如何最终与物理块设备的操作联系起来。在此，我们仅仅给出几个<code>open()</code>函数的调用关系，如图所示。</p>
<center><img src="/2020/08/17/Linux-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/几个open函数的调用关系.PNG">  </center>
<center>图6.几个open函数的调用关系</center>

<ul>
<li>当调用open()系统调用时，其最终会调用到def_blk_fops的blkdev_open() 函数。</li>
<li>blkdev_open()函数的任务：<u>根据主设备号找到对应的block_device_operations结构</u>，然后再调用block_device_operations结构中的函数指针open所指向的函数，如果open 所指向的函数非空，就调用该函数打开最终的物理块设备。</li>
</ul>
<p>这就简单地说明了块设备注册以后，从最上层的系统调用到具体地打开一个设备的过程。</p>
<h2 id="块驱动程序的体系结构"><a href="#块驱动程序的体系结构" class="headerlink" title="块驱动程序的体系结构"></a>块驱动程序的体系结构</h2><p>块设备驱动程序通常分为两部分，即高级驱动程序和低级驱动程序，前者处理VFS 层，后者处理硬件设备</p>
<center><img src="/2020/08/17/Linux-%E5%9D%97%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/块设备驱动程序的体系结构.PNG">  </center>
<center>图7.块设备驱动程序的体系结构</center>

<p>假设进程对一个设备文件发出read()或write()系统调用。<br>VFS 执行对应文件对象的read 或write方法，由此就调用高级块设备处理程序中的一个<strong>过程</strong>。这个过程执行的所有操作都与对这个硬件设备的具体读写请求有关。<br>内核提供两个名为generic_file_read()和generic_file_write()通用函数来留意所有事件的发生。<br>因此，在大部分情况下，高级硬件设备驱动程序不必做什么，而设备文件的read和write方法分别指向generic_file_read()和generic_file_write()方法。但是，有些块设备的处理程序需要自己专用的高级设备驱动程序。</p>
<p>即使高级设备驱动程序有自己的read 和write 方法，但是这两个方法通常最终还会调用generic_file_read ( )和generic_file_write ( )函数。这些函数把对I/O 设备文件的访问请求转换成对相应硬件设备的块请求。</p>
<ul>
<li>所请求的块可能已在主存， 因此generic_file_read ( )和generic_file_write ( )函数调用<code>getblk()函数</code>来检查缓冲区中是否已经预取了块，还是从上次访问以来缓冲区一直都没有改变。</li>
<li>如果块不在缓冲区中，getblk()就必须调用<code>ll_rw_block()</code>继续从磁盘中读取这个块，后面这个函数激活操纵设备控制器的低级驱动程序，以执行对块设备所请求的操作。</li>
</ul>
<p>在VFS 直接访问某一块设备上的特定块时，也会触发缓冲区I/O 操作。</p>
<ul>
<li>例如，如果内核必须从磁盘文件系统中读取一个索引节点，那么它必须从相应磁盘分区的块中传送数据 。</li>
<li>对于<code>特定块的直接访问</code>是由bread()和breada()函数来执行的，这两个函数又会调用前面提到过的getblk()和ll_rw_block()函数。</li>
</ul>
<p>由于块设备速度很慢，因此缓冲区I/O 数据传送通常都是异步处理的：</p>
<ul>
<li>低级设备驱动程序对DMAC和磁盘控制器进行编程来控制其操作，然后结束。当数据传送完成时，就会产生一个中断，从而第2次激活这个低级设备驱动程序来清除这次I/O 操作所涉及的数据结构。</li>
</ul>
<h2 id="块设备基于缓冲区的数据交换"><a href="#块设备基于缓冲区的数据交换" class="headerlink" title="块设备基于缓冲区的数据交换"></a>块设备基于缓冲区的数据交换</h2><p>对于块设备来说，读写操作是以数据块为单位进行的，为了使高速的 CPU 同低速块设备能够协调工作，提高读写效率，操作系统设置了缓冲机制。<br>块设备读和写当进行读写的时候，首先对缓冲区读写，只有缓冲区中没有需要读的数据或是需要写的数据没有地方写时，才真正地启动设备控制器去控制设备本身进行数据交换，而对于设备本身的数据交换同样也是同缓冲区打交道。</p>
<p>在PC 体系结构中，允许块的大小为512、1024、2048 和4096 字节。同一个块设备驱动程序可以作用于多个块大小，因为它必须处理共享**同一主设备号的一组设备文件，而每个块设备文件都有自己预定义的块大小。</p>
<p>例如，一个块设备驱动程序可能会处理有两个分区的硬盘，一个分区包含Ext2 文件系统，另一个分区包含交换分区。<br>内核在一个名为<code>blksize_size</code>的表中存放块的大小；<br>表中每个元素的索引就是相应块设备文件的主设备号和从设备号。如果blksize_size[M]为NULL，那么共享主设备号M的所有块设备都使用标准的块大小，即1024 字节。</p>
<p>每个块都需要自己的缓冲区，它是内核用来存放块内容的<code>RAM内存区</code>。当设备驱动程序从磁盘读出一个块时，就用从硬件设备中所获得的值来填充相应的缓冲区；同样，当设备驱动程序向磁盘中写入一个块时，就用相关缓冲区的实际值来更新硬件设备上相应的一组相邻字节。<br>缓冲区的大小一定要与块的大小相匹配。</p>
<h2 id="块设备请求"><a href="#块设备请求" class="headerlink" title="块设备请求"></a>块设备请求</h2><p>虽然块设备驱动程序可以一次传送一个单独的数据块，但是内核并不会为磁盘上每个被访问的数据块都单独执行一次I/O 操作,取而代之的是，只要可能，内核就试图把几个块合并在一起，并作为一个整体来处理，这样就减少了磁头的平均移动时间。</p>
<p>当进程、VFS 层或者任何其他的内核部分要读写一个磁盘块时，就真正引起一个块设备请求。</p>
<ul>
<li>从本质上说，这个请求描述的是所请求的块以及要对它执行的操作类型（读还是写）。</li>
<li>然而，并不是请求一发出，内核就满足它，实际上，<u>块请求发出时I/O 操作仅仅被调度，稍后才会被执行(先调度，后执行)</u>。这种人为的延迟有悖于提高块设备性能的关键机制。</li>
<li>当请求传送一个新的数据块时，内核检查能否通过稍微扩大前一个一直处于等待状态的请求而满足这个新请求，也就是说，能否不用进一步的搜索操作就能满足新请求。由于磁盘的访问大都是顺序的，因此这种简单机制就非常高效。</li>
</ul>
<p>延迟请求复杂化了块设备的处理。</p>
<ul>
<li>例如，假设某个进程打开了一个普通文件，然后，文件系统的驱动程序就要从磁盘读取相应的索引节点。高级块设备驱动程序把这个请求加入一个等待队列，并把这个进程挂起，直到存放索引节点的块被传送为止。因为块设备驱动程序是中断驱动的，因此，只要高级驱动程序一发出块请求，它就可以终止执行。</li>
<li>在稍后的时间低级驱动程序才被激活，它会调用一个所谓的策略程序从一个队列中取得这个请求，并向磁盘控制器发出适当的命令来满足这个请求。当I/O 操作完成时，磁盘控制器就产生一个中断，如果需要，相应的处理程序会再次调用这个策略程序来处理队列中进程的下一个请求。</li>
</ul>
<p>每个块设备驱动程序都维护自己的请求队列；每个物理块设备都应该有一个请求队列，以提高磁盘性能的方式对请求进行排序。<br>因此策略程序就可以顺序扫描这种队列，并以最少地移动磁头而为所有的请求提供服务。</p>
<h2 id="块设备驱动程序的几个函数"><a href="#块设备驱动程序的几个函数" class="headerlink" title="块设备驱动程序的几个函数"></a>块设备驱动程序的几个函数</h2><h2 id="Linux中硬盘驱动程序的实现"><a href="#Linux中硬盘驱动程序的实现" class="headerlink" title="Linux中硬盘驱动程序的实现"></a><strong>Linux中硬盘驱动程序的实现</strong></h2><h2 id="重要文件"><a href="#重要文件" class="headerlink" title="重要文件"></a>重要文件</h2><p>由于块设备驱动程序的绝大部分都与设备无关的，故内核开发者通过把大部分相同的代码放在一个头文件<a href="https://github.com/torvalds/linux/blob/v3.10/block/blk.h">block/blk.h</a>中来简化驱动程序的代码。从而每个块设备驱动程序都必须 包含这个头文件。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a><strong>参考资料</strong></h2><p>《深入分析Linux内核源代码》 //书籍内核版本有些旧<br>《Linux内核设计与实现》     //目前感觉这个版本是最准的<br><a href="https://www.byteisland.com/linux-%E9%80%9A%E7%94%A8%E5%9D%97%E5%B1%82-bio-%E8%AF%A6%E8%A7%A3/">Linux 通用块层 bio 详解</a><br><a href="https://www.xuebuyuan.com/1697885.html">块设备注册 register_blkdev | 学步园 </a></p>

        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/Linux/" rel="tag">Linux</a>, <a class="has-link-grey -link" href="/tags/%E5%9D%97%E8%AE%BE%E5%A4%87/" rel="tag">块设备</a>, <a class="has-link-grey -link" href="/tags/%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/" rel="tag">驱动程序</a>
                </div>
            </div>
        </div>
        
        
        
        <div class="social-share"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css">
<script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3>
        <div class="buttons is-centered">
            
        </div>
    </div>
</div>



<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2020/09/25/C-%E7%B2%BE%E5%BA%A6%E6%8E%A7%E5%88%B6/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">C++精度控制</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2020/08/16/Linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%B3%A8%E5%86%8C%E3%80%81%E5%AE%89%E8%A3%85%E4%B8%8E%E5%8D%B8%E8%BD%BD/">
                <span class="level-item">Linux文件系统注册、安装与卸载</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">评论</h3>
        
<div id="comment-container"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.min.js"></script>
<script>
    var gitalk = new Gitalk({
        clientID: 'e79770cfee30db02a856',
        clientSecret: 'bb958f5fc30797ffc222ca631ec345baa48a0bee',
        id: 'fe3b5f8cdd33597af83b876b3c1973c6',
        repo: 'STEMHA.github.io',
        owner: 'STEMHA',
        admin: "STEMHA",
        createIssueManually: false,
        distractionFreeMode: false
    })
    gitalk.render('comment-container')
</script>

    </div>
</div>
</div>
				 
				
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/og_image.png" alt="Linux-块设备驱动程序" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2020 STEMHA&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


<script>
var IcarusThemeSettings = {
    site: {
        url: 'https://stemha.github.io',
        external_link: {"enable":true,"exclude":[]}
    },
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>





<script src="/js/animation.js"></script>



<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
<script src="/js/gallery.js" defer></script>



<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>


<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>














<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    	

</body>
</html>